<!DOCTYPE html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-ERP Ù…Ø­Ù„ÙŠ</title>
    
    <!-- Ø±ÙˆØ§Ø¨Ø· CDN Ù…Ø­Ø¯Ø«Ø© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø© -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --sidebar-width: 250px;
            --header-height: 60px;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0dcaf0;
            --light: #f8f9fa;
            --dark: #212529;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: #f8f9fa;
            --bs-body-color: #212529;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --sidebar-link-hover: #e9ecef;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: #121212;
            --bs-body-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --sidebar-bg: #1e1e1e;
            --sidebar-link-hover: #2c2c2c;
            --bs-card-bg: var(--card-bg);
            --bs-card-color: var(--bs-body-color);
        }

        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            transition: background-color 0.3s, color 0.3s;
            padding-top: var(--header-height);
        }
        
        .card {
            background-color: var(--card-bg);
            transition: background-color 0.3s;
            border: 1px solid var(--sidebar-link-hover);
        }

        .header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: var(--header-height);
            z-index: 1030;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--sidebar-link-hover);
            display: flex;
            align-items: center;
        }

        .sidebar {
            position: fixed;
            top: var(--header-height);
            bottom: 0;
            right: 0;
            width: var(--sidebar-width);
            z-index: 1000;
            background-color: var(--sidebar-bg);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding-top: 1rem;
            border-left: 1px solid var(--sidebar-link-hover);
        }

        .sidebar.show {
            transform: translateX(0);
        }

        .main-content {
            padding: 1rem;
            transition: margin-right 0.3s;
        }

        .sidebar .nav-link {
            color: var(--bs-body-color);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--sidebar-link-hover);
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }

        .module {
            display: none;
            animation: fadeIn 0.5s;
        }
        .module.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .kpi-card {
            text-align: center;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #posCart {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 1050;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            padding-top: var(--header-height);
        }

        #posCart.show {
            transform: translateX(0);
        }

        .fab-cart {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1040;
        }

        .cart-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.75rem;
        }

        /* Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ÙˆØ³Ø§Ø¦Ø· */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                right: 0;
                top: 0;
                height: 100vh;
                padding-top: var(--header-height);
                border-bottom: none;
                border-top: none;
                border-left: 1px solid var(--sidebar-link-hover);
            }
            .main-content {
                margin-right: var(--sidebar-width);
                padding: 1rem 1rem 1rem 2rem;
            }
            .header {
                right: var(--sidebar-width);
                left: 0;
            }
            #sidebarToggle {
                display: none;
            }
            #posCart {
                left: 0; 
                width: 350px;
                transform: translateX(-100%);
            }
            .fab-cart {
                display: none;
            }
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† */
        .low-stock {
            background-color: rgba(255, 0, 0, 0.1) !important;
        }
        
        .expired {
            background-color: rgba(255, 165, 0, 0.1) !important;
        }
        
        .table th {
            border-top: none;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ */
        .pos-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .quick-suggestions {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .suggestion-item {
            flex: 0 0 auto;
            width: 80px;
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--sidebar-link-hover);
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .suggestion-emoji {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .suggestion-name {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quantity-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--warning);
            color: #000;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--card-bg);
            z-index: 1;
        }

        .toast-notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1060;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 70px; opacity: 1; }
        }

        .success-profit {
            color: var(--primary-dark, #2d4cd2);
            font-weight: bold;
            font-size: 1.1em;
        }

        .whatsapp-preview {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
        }

        .quantity-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--warning);
            color: #000;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--card-bg);
            z-index: 1;
        }

        .cart-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª */
        #categoriesView .category-count {
            font-size: 0.8rem;
            color: var(--bs-secondary);
            background: var(--sidebar-link-hover);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            margin-top: 0.5rem;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .product-card {
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--sidebar-link-hover);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .product-card.added {
            border: 2px solid var(--success);
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }

        .floating-cart {
            position: fixed;
            bottom: 90px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1040;
            cursor: pointer;
            display: none;
        }

        .floating-cart-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floating-cart.show {
            display: flex;
        }

        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--sidebar-link-hover);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .categories-bar {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .categories-bar .suggestion-item {
            flex: 0 0 auto;
            padding: 10px 15px;
            border-radius: 20px;
            background: var(--card-bg);
            border: 2px solid var(--sidebar-link-hover);
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
        }

        .categories-bar .suggestion-item.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª */
        #categoriesView .category-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-bg);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #categoriesView .category-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        #categoriesView .category-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        #categoriesView .category-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        #categoriesView .category-count {
            font-size: 0.8rem;
            color: var(--bs-secondary);
            background: var(--sidebar-link-hover);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        /* Ø±Ø£Ø³ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        #productsView .view-header {
            background: var(--sidebar-link-hover);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ - Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
        @media (max-width: 768px) {
            .pos-container {
                max-width: 100%;
                padding: 0.5rem;
            }
            
            .product-card {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .categories-bar {
                padding: 0.5rem 0;
            }
            
            .suggestion-item {
                min-width: 70px;
                padding: 0.5rem;
            }
            
            .search-result-item {
                padding: 0.75rem;
            }
            
            #posCart {
                width: 100%;
                max-width: none;
            }
            
            /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
            #productsGrid .col-4 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        @media (max-width: 480px) {
            #productsGrid .col-4 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .suggestion-item {
                min-width: 60px;
                font-size: 0.8rem;
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ */
        .search-result-item {
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: var(--sidebar-link-hover);
        }

        .search-result-item:active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 12pt !important;
            }
            
            .card {
                border: 1px solid #000 !important;
                box-shadow: none !important;
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        .credit-report-table th {
            background-color: #e9ecef !important;
            color: #495057 !important;
            font-weight: 600 !important;
        }

        .balance-positive {
            color: #28a745 !important;
            font-weight: bold !important;
        }

        .balance-negative {
            color: #dc3545 !important;
            font-weight: bold !important;
        }

        .report-summary-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff !important;
        }

        .report-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }        

        /* Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø© */
        #categoriesView h4,
        #categoriesBar {
            display: none !important;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
        .search-results-container {
            position: relative !important;
            top: 0 !important;
            margin-top: 5px;
            max-height: 300px;
            z-index: 1000;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª */
        #categoriesGrid {
            margin-top: 20px;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background: var(--card-bg);
        }

        .subscription-status {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1100;
        }

        .user-info {
            margin-left: 15px;
            font-size: 0.9rem;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ */
        .owner-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .user-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .subscription-active {
            border-left: 4px solid #28a745;
        }

        .subscription-expired {
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>

    <!-- ========== Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-4">
            <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-muted">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Micro-ERP</p>
        </div>
        
        <form id="loginForm">
            <div class="mb-3">
                <label for="loginEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </form>

        <div class="text-center">
            <p class="text-muted">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="showRegister">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
        </div>

        <div id="ownerAccess" class="mt-4 p-3 border rounded">
            <h6 class="text-center">ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø§Ù„Ùƒ</h6>
            <button class="btn btn-outline-primary w-100" id="ownerLoginBtn">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø§Ù„Ùƒ -->
        <div class="mt-3 p-3 border border-warning rounded bg-light">
            <h6 class="text-warning text-center">
                <i class="bi bi-lightning-charge"></i> Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ ÙƒÙ…Ø§Ù„Ùƒ
            </h6>
            <div class="d-grid gap-2">
                <button class="btn btn-warning btn-sm" id="quickOwnerLogin">
                    <i class="bi bi-shield-lock"></i> Ø¯Ø®ÙˆÙ„ ÙÙˆØ±ÙŠ ÙƒÙ…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
                <small class="text-muted text-center">
                    Ø§Ù„Ø¨Ø±ÙŠØ¯: owner@erp.com | ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: owner123456
                </small>
            </div>
        </div>
    </div>

    <!-- ========== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ========== -->
    <div id="registerScreen" class="login-container" style="display: none;">
        <div class="text-center mb-4">
            <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <p class="text-muted">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Micro-ERP</p>
        </div>
        
        <form id="registerForm">
            <div class="mb-3">
                <label for="registerName" class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" class="form-control" id="registerName" required>
            </div>
            <div class="mb-3">
                <label for="registerEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" class="form-control" id="registerEmail" required>
            </div>
            <div class="mb-3">
                <label for="registerPassword" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" class="form-control" id="registerPassword" required minlength="6">
            </div>
            <div class="mb-3">
                <label for="registerConfirmPassword" class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" class="form-control" id="registerConfirmPassword" required>
            </div>
            <button type="submit" class="btn btn-success w-100 mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </form>

        <div class="text-center">
            <p class="text-muted">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="#" id="showLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
        </div>
    </div>

    <!-- ========== Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) ========== -->
    <div id="appContainer" style="display: none;">
        <!-- ========== Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ========== -->
        <div class="header d-flex justify-content-between align-items-center px-3">
            <div>
                <span class="badge bg-success me-3">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: <span id="currentBalance">0.00 Ø±.ÙŠ</span></span>
                <button class="btn btn-outline-secondary btn-sm" id="themeToggle">
                    <i class="bi bi-sun" id="themeIcon"></i>
                </button>
                <button class="btn btn-primary btn-sm d-md-none me-2" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
            </div>
            <div class="d-flex align-items-center">
                <span class="user-info">
                    <span id="userDisplayName">Ù…Ø³ØªØ®Ø¯Ù…</span>
                    <span class="badge bg-info ms-2" id="userRole">Ù…Ø³ØªØ®Ø¯Ù…</span>
                </span>
                <button class="btn btn-outline-danger btn-sm ms-3" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <!-- ========== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ========== -->
        <div class="sidebar d-flex flex-column" id="appSidebar">
            <nav class="nav nav-pills flex-column">
                <a class="nav-link" data-module="pos"><i class="bi bi-cart-fill me-2"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ (POS)</a>
                <a class="nav-link" data-module="inventory"><i class="bi bi-box-seam-fill me-2"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
                <a class="nav-link" data-module="cash"><i class="bi bi-currency-dollar me-2"></i> Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
                <a class="nav-link" data-module="accounting"><i class="bi bi-book-half me-2"></i> Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© (COA)</a>
                <a class="nav-link" data-module="settings"><i class="bi bi-gear-fill me-2"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</a>
                
                <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ) -->
                <div id="ownerPanel" style="display: none;">
                    <hr>
                    <h6 class="px-3 text-muted">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h6>
                    <a class="nav-link" data-module="owner"><i class="bi bi-shield-lock me-2"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
                </div>
            </nav>
        </div>

        <!-- ========== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ========== -->
        <div class="main-content" id="mainContent">
            <div class="container-fluid py-4">
                <!-- ========== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ ========== -->
                <div class="module" id="owner">
                    <div class="owner-panel">
                        <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
                        <p class="text-muted">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card kpi-card bg-primary text-white">
                                    <div class="card-body">
                                        <i class="bi bi-people fs-1"></i>
                                        <div class="kpi-value" id="totalUsers">0</div>
                                        <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card kpi-card bg-success text-white">
                                    <div class="card-body">
                                        <i class="bi bi-check-circle fs-1"></i>
                                        <div class="kpi-value" id="activeSubscriptions">0</div>
                                        <div class="kpi-title">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù†Ø´Ø·Ø©</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card kpi-card bg-warning text-white">
                                    <div class="card-body">
                                        <i class="bi bi-clock fs-1"></i>
                                        <div class="kpi-value" id="expiringSubscriptions">0</div>
                                        <div class="kpi-title">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
                                <button class="btn btn-primary btn-sm" id="addUserBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                                                <th>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ</th>
                                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (POSØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ø¥Ù„Ø®) ========== -->
                <!-- ========== Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ========== -->
                <div class="module" id="dashboard">
                    <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    <p class="text-muted">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
                    
                    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card kpi-card bg-primary text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-cash-coin fs-1"></i>
                                    <div class="kpi-value" id="todaySales">0.00 Ø±.ÙŠ</div>
                                    <div class="kpi-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card kpi-card bg-success text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-graph-up fs-1"></i>
                                    <div class="kpi-value" id="todayProfit">0.00 Ø±.ÙŠ</div>
                                    <div class="kpi-title">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card kpi-card bg-info text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-box-seam fs-1"></i>
                                    <div class="kpi-value" id="inventoryValueCost">0.00 Ø±.ÙŠ</div>
                                    <div class="kpi-title">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (ØªÙƒÙ„ÙØ©)</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card kpi-card bg-warning text-white">
                                <div class="card-body text-center">
                                    <i class="bi bi-box-seam fs-1"></i>
                                    <div class="kpi-value" id="inventoryValueSale">0.00 Ø±.ÙŠ</div>
                                    <div class="kpi-title">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨ÙŠØ¹)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø© -->
                    <div class="row">
                        <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">ğŸ›’ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="salesReportsTable">
                                                <tr><td colspan="3" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">ğŸ“¦ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchasesReportsTable">
                                                <tr><td colspan="3" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <i class="bi bi-people fs-1 text-primary"></i>
                                                <h4 id="customersCount">0</h4>
                                                <p class="text-muted mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <i class="bi bi-building fs-1 text-success"></i>
                                                <h4 id="suppliersCount">0</h4>
                                                <p class="text-muted mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <strong>Ø£Ø¹Ù„Ù‰ 5 Ø¹Ù…Ù„Ø§Ø¡:</strong>
                                        <div id="topCustomersList" class="mt-2">
                                            <p class="text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="card-title mb-0">ğŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong>
                                        <span class="float-end fw-bold text-success" id="currentCapital">0.00 Ø±.ÙŠ</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©:</strong>
                                        <span class="float-end fw-bold text-primary" id="totalProfit">0.00 Ø±.ÙŠ</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¨Ø¹Ø¯ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©):</strong>
                                        <span class="float-end fw-bold text-info" id="netProfit">0.00 Ø±.ÙŠ</span>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                                            <i class="bi bi-arrow-clockwise"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„Ø© -->
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="card-title mb-0">ğŸ“‹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="creditSalesTable">
                                                <tr><td colspan="5" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø¬Ù„Ø© -->
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="card-title mb-0">ğŸ“‹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø¬Ù„Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="creditPurchasesTable">
                                                <tr><td colspan="5" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ ========== -->
                <div class="module" id="pos">
                    <div class="pos-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>ğŸ›’ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</h2>
                            <span class="badge bg-success">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: <span id="posBalance">0.00 Ø±.ÙŠ</span></span>
                        </div>

                        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« -->
                        <div class="mb-3 position-relative">
                            <input type="text" class="form-control" id="productSearchInput" 
                                placeholder="ğŸ” Ø¨Ø­Ø« ÙÙˆØ±ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)...">
                            <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
                            <div id="posSearchResults" class="search-results-container" style="display: none;"></div>
                        </div>
                        
                        <!-- Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª -->
                        <div id="categoriesView">
                            <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ´Ø±ÙŠØ· Ø§Ù„ÙØ¦Ø§Øª -->
                            
                            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
                            <div class="quick-suggestions mb-4" id="quickSuggestions">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                            </div>

                            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„ÙØ¦Ø§Øª -->
                            <div class="row g-3" id="categoriesGrid">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                            </div>
                        </div>

                        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                        <div id="productsView" style="display: none;">
                            <!-- Ø±Ø£Ø³ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                <button class="btn btn-outline-primary btn-sm" id="backToCategoriesBtn">
                                    <i class="bi bi-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ¦Ø§Øª
                                </button>
                                <h5 class="mb-0" id="currentCategoryTitle">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                                <div class="text-muted" id="productsCount"></div>
                            </div>

                            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                            <div class="row g-2" id="productsGrid">
                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ========== -->
                <div class="module" id="inventory">
                    <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
                    <div class="d-flex mb-3">
                        <button class="btn btn-primary me-2" id="addProductBtn"><i class="bi bi-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                        <button class="btn btn-success me-2" id="importProductsBtn"><i class="bi bi-cloud-upload me-1"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ (XLSX)</button>
                        <button class="btn btn-info me-2 text-white" id="exportProductsBtn"><i class="bi bi-cloud-download me-1"></i> ØªØµØ¯ÙŠØ± (XLSX)</button>
                        <button class="btn btn-warning" id="recordPurchaseBtn"><i class="bi bi-truck me-1"></i> ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</button>
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙØ±Ø¹ÙŠØ© -->
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a class="nav-link active" data-tab="inventory-items">Ø§Ù„Ø£ØµÙ†Ø§Ù</a></li>
                        <li class="nav-item"><a class="nav-link" data-tab="inventory-purchases">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</a></li>
                        <li class="nav-item"><a class="nav-link" data-tab="inventory-categories">ÙØ¦Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a></li>
                        <li class="nav-item"><a class="nav-link" data-tab="inventory-movements">Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ù</a></li>
                        <li class="nav-item"><a class="nav-link" data-tab="inventory-suppliers">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</a></li>
                        <li class="nav-item"><a class="nav-link" data-tab="inventory-customers">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
                    </ul>

                    <!-- Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                    <div class="tab-content" id="inventoryTabs">
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ØµÙ†Ø§Ù -->
                        <div class="tab-pane fade show active" id="inventory-items">
                            <input type="text" class="form-control mb-3" id="inventorySearchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù...">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø¨ÙŠØ¹</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                    <tbody id="productsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
                        <div class="tab-pane fade" id="inventory-purchases">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                    <tbody id="purchasesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØ¦Ø§Øª -->
                        <div class="tab-pane fade" id="inventory-categories">
                            <div class="d-flex mb-3">
                                <button class="btn btn-primary" id="addCategoryBtn"><i class="bi bi-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                    <tbody id="categoriesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
                        <div class="tab-pane fade" id="inventory-movements">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="movementProductSelect">
                                        <option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ù„Ø¹Ø±Ø¶ Ø­Ø±ÙƒØ§ØªÙ‡</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th></tr></thead>
                                    <tbody id="movementsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
                        <div class="tab-pane fade" id="inventory-suppliers">
                            <div class="d-flex mb-3">
                                <button class="btn btn-primary" id="addSupplierBtn"><i class="bi bi-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                    <tbody id="suppliersTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
                        <div class="tab-pane fade" id="inventory-customers">
                            <div class="d-flex mb-3">
                                <button class="btn btn-primary" id="addCustomerBtn"><i class="bi bi-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                    <tbody id="customersTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ========== -->
                <div class="module" id="cash">
                    <h2>ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h2>
                    <p class="text-muted">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„</p>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card kpi-card bg-light">
                                <div class="card-body">
                                    <i class="bi bi-wallet2 text-primary fs-1"></i>
                                    <div class="kpi-value" id="cashModuleBalance">0.00 Ø±.ÙŠ</div>
                                    <div class="kpi-title">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (YER)</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header"><h5 class="card-title mb-0">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h5></div>
                                <div class="card-body d-grid gap-2">
                                    <button class="btn btn-success" id="depositBtn"><i class="bi bi-plus-circle"></i> Ø¥ÙŠØ¯Ø§Ø¹</button>
                                    <button class="btn btn-danger" id="withdrawBtn"><i class="bi bi-dash-circle"></i> Ø³Ø­Ø¨</button>
                                    <button class="btn btn-info text-white" id="transferBtn"><i class="bi bi-arrow-repeat"></i> ØªØ­ÙˆÙŠÙ„</button>
                                    <button class="btn btn-warning" id="closeShiftBtn"><i class="bi bi-stopwatch"></i> Ø¥Ù‚ÙØ§Ù„ ÙˆØ±Ø¯ÙŠØ©/ØªØ³ÙˆÙŠØ©</button>
                                    <button class="btn btn-outline-success" id="collectDebtsBtn">
                                        <i class="bi bi-cash-coin"></i> ØªØ­ØµÙŠÙ„ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                                    </button>
                                    <button class="btn btn-outline-primary" id="paySuppliersBtn">
                                        <i class="bi bi-credit-card"></i> Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header"><h5 class="card-title mb-0">Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø³Ø¬Ù„</h5></div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th></tr></thead>
                                            <tbody id="cashTransactionsTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ========== -->
                <div class="module" id="accounting">
                    <h2>ğŸ“œ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ÙˆØ´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                    <p class="text-muted">Ø¹Ø±Ø¶ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header"><h5 class="card-title mb-0">Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (COA)</h5></div>
                                <ul class="list-group list-group-flush" id="coaList">
                                    <li class="list-group-item text-center text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between">
                                    <h5 class="card-title mb-0">Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h5>
                                    <button class="btn btn-sm btn-primary" id="addManualEntryBtn"><i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†</th><th>Ø§Ù„Ø¯Ø§Ø¦Ù†</th></tr></thead>
                                            <tbody id="journalEntriesTable">
                                                <tr class="text-center text-muted"><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙŠÙˆÙ…ÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ========== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ========== -->
                <div class="module" id="settings">
                    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                    <p class="text-muted">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <div class="card mb-4">
                        <div class="card-header"><h5 class="card-title mb-0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª</h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
                                    <input type="text" class="form-control" value="Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ (YER)" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</label>
                                    <input type="text" class="form-control" value="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (SAR)" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (425 YER = 1 SAR)</label>
                                    <input type="number" class="form-control" id="exchangeRateInput" value="425">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                                    <input type="number" class="form-control" id="taxRateInput" value="0">
                                </div>
                                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showQuantityFieldSetting" checked>
                                    <label class="form-check-label" for="showQuantityFieldSetting">Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                    <small class="form-text text-muted">Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¹Ø¨Ø± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·</small>
                                </div>
                            </div>
                            <button class="btn btn-success" id="saveSettingsBtn"><i class="bi bi-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h5 class="card-title mb-0">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5></div>
                        <div class="card-body d-grid gap-2">
                            <button class="btn btn-outline-primary" id="backupBtn"><i class="bi bi-cloud-arrow-down"></i> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒØ§Ù…Ù„ (JSON)</button>
                            <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                            <button class="btn btn-outline-success" id="restoreBtn"><i class="bi bi-cloud-arrow-up"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
                <!-- [Ù†ÙØ³ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø³ÙŠØ¶Ø§Ù Ù‡Ù†Ø§] -->
            </div>
        </div>

        <!-- ========== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Modals) ========== -->
        
        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„ -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="userId">
                            <div class="mb-3">
                                <label for="userName" class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                <input type="text" class="form-control" id="userName" required>
                            </div>
                            <div class="mb-3">
                                <label for="userEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="email" class="form-control" id="userEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="userPassword" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" class="form-control" id="userPassword">
                                <small class="form-text text-muted">Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                            </div>
                            <div class="mb-3">
                                <label for="subscriptionType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                                <select class="form-select" id="subscriptionType" required>
                                    <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                                    <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="subscriptionStatus" class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                                <select class="form-select" id="subscriptionStatus" required>
                                    <option value="active">Ù†Ø´Ø·</option>
                                    <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                                    <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="button" class="btn btn-primary" id="saveUserBtn">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£Ø®Ø±Ù‰ -->
    <!-- ========== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Modals) ========== -->
    
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label for="productCode" class="form-label">ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</label>
                            <input type="text" class="form-control" id="productCode" required>
                        </div>
                        <div class="mb-3">
                            <label for="productName" class="form-label">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productPurchasePrice" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„ØªÙƒÙ„ÙØ©)</label>
                                <input type="number" class="form-control" id="productPurchasePrice" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productSalePrice" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                <input type="number" class="form-control" id="productSalePrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productQuantity" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                                <input type="number" class="form-control" id="productQuantity" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productMinQuantity" class="form-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                                <input type="number" class="form-control" id="productMinQuantity" value="5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="productExpiryDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="date" class="form-control" id="productExpiryDate">
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">Ø§Ù„ÙØ¦Ø©</label>
                            <select class="form-select" id="productCategory">
                                <option value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø©</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬ (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)</label>
                            <input type="text" class="form-control" id="productImage" placeholder="ğŸ“¦" maxlength="2">
                            <small class="form-text text-muted">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² ØªØ¹Ø¨ÙŠØ±ÙŠ (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ØªØ­Ø¯ÙŠØ« Ù†Ù…ÙˆØ°Ø¬ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ -->
    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="purchaseModalLabel">ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseSupplier" class="form-label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <select class="form-select" id="purchaseSupplier" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                                <input type="date" class="form-control" id="purchaseDate" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchasePaymentMethod" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                <select class="form-select" id="purchasePaymentMethod" required>
                                    <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                                    <option value="credit">Ø¢Ø¬Ù„</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseInvoiceNumber" class="form-label">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                <input type="text" class="form-control" id="purchaseInvoiceNumber" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</h6>
                            <div id="purchaseItemsContainer">
                                <div class="purchase-item row g-2 mb-2">
                                    <div class="col-md-5">
                                        <select class="form-select product-select" required>
                                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control quantity-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" required min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control price-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" step="0.01" required min="0.01">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger btn-sm remove-item-btn w-100">Ø­Ø°Ù</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addPurchaseItemBtn">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="purchaseTotal" class="form-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                                <input type="number" class="form-control" id="purchaseTotal" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="purchaseNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea class="form-control" id="purchaseNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="savePurchaseBtn">Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© -->
    <div class="modal fade" id="cashOperationModal" tabindex="-1" aria-labelledby="cashOperationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cashOperationModalLabel">Ø¹Ù…Ù„ÙŠØ© Ù†Ù‚Ø¯ÙŠØ©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cashOperationForm">
                        <input type="hidden" id="cashOperationType">
                        <div class="mb-3">
                            <label for="cashAmount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                            <input type="number" class="form-control" id="cashAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="cashDescription" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                            <input type="text" class="form-control" id="cashDescription" required>
                        </div>
                        <div class="mb-3" id="cashAccountContainer" style="display: none;">
                            <label for="cashAccount" class="form-label">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label>
                            <select class="form-select" id="cashAccount">
                                <option value="1020">Ø§Ù„Ø¨Ù†Ùƒ</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveCashOperationBtn">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
    <div class="modal fade" id="journalEntryModal" tabindex="-1" aria-labelledby="journalEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="journalEntryModalLabel">Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ÙŠØ¯ÙˆÙŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="journalEntryForm">
                        <div class="mb-3">
                            <label for="entryDescription" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                            <input type="text" class="form-control" id="entryDescription" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h6>
                                <div id="debitEntriesContainer">
                                    <div class="debit-entry row g-2 mb-2">
                                        <div class="col-md-8">
                                            <select class="form-select debit-account-select" required>
                                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control debit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addDebitEntryBtn">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠÙ†Ø©</button>
                            </div>
                            <div class="col-md-6">
                                <h6>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©</h6>
                                <div id="creditEntriesContainer">
                                    <div class="credit-entry row g-2 mb-2">
                                        <div class="col-md-8">
                                            <select class="form-select credit-account-select" required>
                                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control credit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addCreditEntryBtn">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù†</button>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ†:</strong> <span id="totalDebitAmount">0.00</span> Ø±.ÙŠ
                            <strong class="ms-3">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†:</strong> <span id="totalCreditAmount">0.00</span> Ø±.ÙŠ
                            <strong class="ms-3">Ø§Ù„ÙØ±Ù‚:</strong> <span id="balanceDifference">0.00</span> Ø±.ÙŠ
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveJournalEntryBtn" disabled>Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel">âœ… Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ù†Ø§Ø¬Ø­Ø©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h6>ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: <span id="invoiceNumberDisplay">INV-1000</span></h6>
                        <p>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <span id="paymentMethodDisplay">Ù†Ù‚Ø¯ÙŠ</span></p>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6 class="alert-heading">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</h6>
                        <h4 class="text-center" id="finalTotalDisplay">0.00 Ø±.ÙŠ</h4>
                    </div>
                    
                    <div id="successMessage">
                        <p class="text-center">
                            Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù‚Ù‚: 
                            <span class="success-profit" id="grossProfitDisplay">0.00 Ø±.ÙŠ</span>
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn btn-primary" id="printReceiptBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ -->
    <div class="modal fade" id="whatsappPreviewModal" tabindex="-1" aria-labelledby="whatsappPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="whatsappPreviewModalLabel">ğŸ“± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="whatsapp-preview" id="whatsappMessagePreview">
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-success" id="openWhatsappBtn">
                        <i class="bi bi-whatsapp"></i> ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ -->
    <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalLabel">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <input type="hidden" id="supplierId">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control" id="supplierPhone">
                        </div>
                        <div class="mb-3">
                            <label for="supplierEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" class="form-control" id="supplierEmail">
                        </div>
                        <div class="mb-3">
                            <label for="supplierAddress" class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control" id="supplierAddress" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveSupplierBtn">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="customerEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveCustomerBtn">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div class="modal fade" id="collectionModal" tabindex="-1" aria-labelledby="collectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collectionModalLabel">ğŸ’° ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="collectionForm">
                        <div class="mb-3">
                            <label for="collectionCustomerSelect" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <select class="form-select" id="collectionCustomerSelect" required>
                                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="collectionAmount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„</label>
                            <input type="number" class="form-control" id="collectionAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="collectionDescription" class="form-label">ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                            <input type="text" class="form-control" id="collectionDescription" placeholder="ÙˆØµÙ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„..." required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-success" id="executeCollectionBtn">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ØµÙŠÙ„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
    <div class="modal fade" id="supplierPaymentModal" tabindex="-1" aria-labelledby="supplierPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierPaymentModalLabel">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierPaymentForm">
                        <div class="mb-3">
                            <label for="supplierPaymentSelect" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                            <select class="form-select" id="supplierPaymentSelect" required>
                                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPaymentAmount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯</label>
                            <input type="number" class="form-control" id="supplierPaymentAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPaymentDescription" class="form-label">ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                            <input type="text" class="form-control" id="supplierPaymentDescription" placeholder="ÙˆØµÙ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø¯Ø§Ø¯..." required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-success" id="executeSupplierPaymentBtn">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø¯Ø§Ø¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ØªØ­Ø¯ÙŠØ« Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
    <div id="posCart">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h5>
            <button class="btn btn-sm btn-outline-secondary" id="closeCartBtn">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="p-3" style="height: calc(100% - 120px); overflow-y: auto;">
            <div id="cartItemsList"></div>
            <!-- ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙÙŠ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
            <div class="border-top pt-3 mt-3">
                <div class="mb-3">
                    <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                    <select class="form-select" id="customerSelect">
                        <option value="">Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                    <select class="form-select" id="paymentMethodSelect">
                        <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                        <option value="credit">Ø¢Ø¬Ù„</option>
                        <option value="card">Ø¨Ø·Ø§Ù‚Ø©</option>
                    </select>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø­Ø³Ù† -->
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Ø§Ù„Ø®ØµÙ…:</label>
                        <select class="form-select form-select-sm" id="discountType">
                            <option value="fixed">Ù‚ÙŠÙ…Ø© Ø«Ø§Ø¨ØªØ©</option>
                            <option value="percentage">Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Ø§Ù„Ù‚ÙŠÙ…Ø©:</label>
                        <input type="number" class="form-control form-control-sm" id="discountInput" value="0" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="applyTaxCheckbox" checked>
                            <label class="form-check-label" for="applyTaxCheckbox">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Ø§Ù„Ù†Ø³Ø¨Ø©:</label>
                        <input type="number" class="form-control form-control-sm" id="taxRateInput" value="0" min="0" max="100" step="0.1" disabled>
                    </div>
                </div>
                
                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª -->
                <div class="totals-breakdown mb-3">
                    <div class="d-flex justify-content-between small border-bottom pb-1">
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                        <span id="cartSubtotal">0.00 Ø±.ÙŠ</span>
                    </div>
                    <div class="d-flex justify-content-between small text-danger border-bottom pb-1">
                        <span>Ø§Ù„Ø®ØµÙ…:</span>
                        <span id="cartDiscount">0.00 Ø±.ÙŠ</span>
                    </div>
                    <div class="d-flex justify-content-between small text-info border-bottom pb-1">
                        <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                        <span id="cartTax">0.00 Ø±.ÙŠ</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold mt-2">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                        <span id="cartTotal" class="text-success">0.00 Ø±.ÙŠ</span>
                    </div>
                </div>
                
                <button class="btn btn-success w-100 mb-2" id="saveInvoiceBtn">âœ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                <button class="btn btn-outline-primary w-100 mb-2" id="printInvoiceBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn btn-outline-success w-100" id="shareWhatsappBtn">ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>
        </div>
    </div>


    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© -->
    <button class="btn btn-primary fab-cart" id="fabCartBtn">
        <i class="bi bi-cart-fill"></i>
        <span class="cart-counter" id="cartCounter">0</span>
    </button>

    <div class="floating-cart" id="floatingCartBtn" style="display: none;">
        <div class="floating-cart-content">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø©:</span>
            <span class="fw-bold text-success" id="floatingCartTotal">0.00 Ø±.ÙŠ</span>
        </div>
    </div>
    
    <!-- Ø¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ© -->
    <select class="form-select d-none" id="customerSelect">
        <option value="">Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
    </select>
    
    <!-- Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚Øª -->
    <div id="temporaryNotification" class="toast-notification" style="display: none;">
        ØªÙ… Ø¥Ø¶Ø§ÙØ© <span id="notificationProductName"></span> Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
    </div>
        <!-- [Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§] -->


    <!-- Ù…ÙƒØªØ¨Ø§Øª JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== ØªÙ‡ÙŠØ¦Ø© Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDwefVPKU85AHzA0LU4xav23vI0zwNjdnc",
            authDomain: "erp-m-caaf4.firebaseapp.com",
            projectId: "erp-m-caaf4",
            storageBucket: "erp-m-caaf4.firebasestorage.app",
            messagingSenderId: "149444197418",
            appId: "1:149444197418:web:a170ad50d3760f9192d753"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase

        // ==================== ØªÙ‡ÙŠØ¦Ø© Firebase Ø§Ù„Ù…ØµØ­Ø­Ø© ====================
        // Ø­Ù„ ØªØ¶Ø§Ø±Ø¨ Ù…ÙƒØªØ¨Ø§Øª Firebase
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            console.log('Firebase already initialized, using existing app');
        } else {
            try {
                // ØªÙ‡ÙŠØ¦Ø© Firebase
                firebase.initializeApp(firebaseConfig);
                console.log('âœ… Firebase initialized successfully');
            } catch (error) {
                console.error('âŒ Firebase initialization error:', error);
            }
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§Øª Firebase Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        window.firebaseAuth = auth;
        window.firestoreDB = firestore;


        // ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
        let useOfflineMode = false;
        let currentUser = null;
        let userRole = 'user';
        let userSubscription = null;

        // ğŸ”§ ØªØ­Ø¯ÙŠØ« ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let localDB;
        let currentCart = [];
        let invoiceCounter = 1000;
        let categories = [];
        let suppliers = [];
        let customers = []; // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯
        let salesHistory = JSON.parse(localStorage.getItem('pos_sales')) || [];

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        let currentView = 'categories';
        let currentCategoryId = null;
        let currentCategoryName = '';
        // Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const DEFAULT_ACCOUNTS = [
            // === Ø§Ù„Ø£ØµÙˆÙ„ ===
            { code: '1000', name: 'Ø§Ù„Ø£ØµÙˆÙ„', type: 'header', parentCode: null },
            { code: '1010', name: 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', type: 'asset', parentCode: '1000', balance: 0.00 },
            { code: '1020', name: 'Ø§Ù„Ø¨Ù†Ùƒ', type: 'asset', parentCode: '1000', balance: 0.00 },
            { code: '1030', name: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', type: 'asset', parentCode: '1000', balance: 0.00 },
            
            // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø³ÙŠØ´Ù…Ù„ Ø­Ø³Ø§Ø¨Ø§Øª ÙØ±Ø¹ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            { code: '1040', name: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', type: 'header', parentCode: '1000' },
            { code: '1040000', name: 'Ø¹Ù…Ù„Ø§Ø¡ Ù†Ù‚Ø¯ÙŠÙˆÙ†', type: 'asset', parentCode: '1040', balance: 0.00 },
            
            // === Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ===
            { code: '2000', name: 'Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', type: 'header', parentCode: null },
            
            // Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - Ø³ÙŠØ´Ù…Ù„ Ø­Ø³Ø§Ø¨Ø§Øª ÙØ±Ø¹ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            { code: '2010', name: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©', type: 'header', parentCode: '2000' },
            { code: '2010000', name: 'Ù…ÙˆØ±Ø¯ÙŠÙ† Ù†Ù‚Ø¯ÙŠÙˆÙ†', type: 'liability', parentCode: '2010', balance: 0.00 },
            
            { code: '2020', name: 'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„', type: 'equity', parentCode: '2000', balance: 0.00 },
            { code: '2030', name: 'Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©', type: 'liability', parentCode: '2000', balance: 0.00 },
            
            // === Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ===
            { code: '3000', name: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª', type: 'header', parentCode: null },
            { code: '3010', name: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', type: 'revenue', parentCode: '3000', balance: 0.00 },
            { code: '3020', name: 'ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©', type: 'expense', parentCode: '3000', balance: 0.00 },
            { code: '3030', name: 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©', type: 'expense', parentCode: '3000', balance: 0.00 },
            { code: '3040', name: 'Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡', type: 'expense', parentCode: '3000', balance: 0.00 },
            { code: '3050', name: 'Ø£Ø±Ø¨Ø§Ø­ Ù…Ø­ØªØ¬Ø²Ø©', type: 'equity', parentCode: '2000', balance: 0.00 }
        ];

        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ====================
        async function setupOwnerAccount() {
            const ownerEmail = 'akrm.azzan.aa@gmail.com';
            const ownerPassword = '123456';
            
            try {
                console.log('ğŸ‘‘ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ...');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
                let userCredential;
                try {
                    userCredential = await window.firebaseAuth.signInWithEmailAndPassword(ownerEmail, ownerPassword);
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } catch (signInError) {
                    console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', signInError.code);
                    
                    if (signInError.code === 'auth/user-not-found') {
                        console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯...');
                        userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(ownerEmail, ownerPassword);
                        
                        await userCredential.user.updateProfile({
                            displayName: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…'
                        });
                        
                        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                    } else if (signInError.code === 'auth/wrong-password') {
                        throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ');
                    } else {
                        throw signInError;
                    }
                }

                // Ø§Ù„Ø¢Ù† ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                const userDoc = await window.firestoreDB.collection('users').doc(userCredential.user.uid).get();
                
                if (!userDoc.exists) {
                    console.log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Firestore...');
                    await window.firestoreDB.collection('users').doc(userCredential.user.uid).set({
                        name: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…',
                        email: ownerEmail,
                        role: 'owner',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        subscription: {
                            type: 'owner',
                            status: 'active',
                            startDate: firebase.firestore.FieldValue.serverTimestamp(),
                            endDate: null,
                            features: {
                                maxUsers: 100,
                                maxProducts: 10000,
                                maxStorage: '10GB',
                                advancedReports: true,
                                apiAccess: true
                            }
                        },
                        company: {
                            name: 'Ø´Ø±ÙƒØªÙŠ',
                            phone: '',
                            address: '',
                            taxNumber: ''
                        }
                    });
                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    console.log('âœ… ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ù…Ø§Ù„Ùƒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ†
                    const userData = userDoc.data();
                    if (userData.role !== 'owner') {
                        console.log('ğŸ”„ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø§Ù„Ùƒ...');
                        await window.firestoreDB.collection('users').doc(userCredential.user.uid).update({
                            role: 'owner',
                            subscription: {
                                type: 'owner',
                                status: 'active',
                                startDate: firebase.firestore.FieldValue.serverTimestamp(),
                                endDate: null,
                                features: {
                                    maxUsers: 100,
                                    maxProducts: 10000,
                                    maxStorage: '10GB',
                                    advancedReports: true,
                                    apiAccess: true
                                }
                            }
                        });
                        console.log('âœ… ØªÙ… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø§Ù„Ùƒ');
                    }
                }
                
                return userCredential;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ:', error);
                
                // ØªÙ‚Ø¯ÙŠÙ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹
                let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ: ';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage += 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
                        break;
                    case 'auth/user-disabled':
                        errorMessage += 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„';
                        break;
                    case 'auth/user-not-found':
                        errorMessage += 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage += 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                alert(errorMessage);
                throw error;
            }
        }

        async function createOwnerAccount(email, password) {
            try {
                console.log('ğŸ‘‘ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ...');
                
                const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…'
                });

                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Firestore
                await window.firestoreDB.collection('users').doc(userCredential.user.uid).set({
                    name: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…',
                    email: email,
                    role: 'owner',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: {
                        type: 'owner',
                        status: 'active',
                        startDate: firebase.firestore.FieldValue.serverTimestamp(),
                        endDate: null,
                        features: {
                            maxUsers: 100,
                            maxProducts: 10000,
                            maxStorage: '10GB',
                            advancedReports: true,
                            apiAccess: true
                        }
                    },
                    company: {
                        name: 'Ø´Ø±ÙƒØªÙŠ',
                        phone: '',
                        address: '',
                        taxNumber: ''
                    }
                });

                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
                alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù….');
                
                return userCredential;
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ:', error);
                alert('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ: ' + error.message);
                throw error;
            }
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ====================
        function initAuth() {
            window.firebaseAuth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    showApp();
                } else {
                    showLogin();
                }
            });
        }

        async function loadUserData() {
            try {
                const userDoc = await window.firestoreDB.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userRole = userData.role || 'user';
                    userSubscription = userData.subscription;
                    
                    updateUIForUser();
                    checkSubscriptionStatus();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUIForUser() {
            document.getElementById('userDisplayName').textContent = currentUser.displayName || currentUser.email;
            document.getElementById('userRole').textContent = userRole === 'owner' ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ®Ø¯Ù…';
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ
            if (userRole === 'owner') {
                document.getElementById('ownerPanel').style.display = 'block';
                loadUsersList();
            } else {
                document.getElementById('ownerPanel').style.display = 'none';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
            updateSubscriptionUI();
        }

        function checkSubscriptionStatus() {
            if (userRole === 'owner') return; // Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
            
            if (!userSubscription || userSubscription.status !== 'active') {
                showSubscriptionAlert();
            }
        }

        function showSubscriptionAlert() {
            const alertHtml = `
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>ØªÙ†Ø¨ÙŠÙ‡!</strong> Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·. ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù….
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.querySelector('.main-content').insertAdjacentHTML('afterbegin', alertHtml);
        }

        function updateSubscriptionUI() {
            const subscriptionBadge = document.createElement('span');
            subscriptionBadge.className = 'badge ms-2';
            
            if (userRole === 'owner') {
                subscriptionBadge.className += ' bg-success';
                subscriptionBadge.textContent = 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…';
            } else if (userSubscription && userSubscription.status === 'active') {
                subscriptionBadge.className += ' bg-success';
                subscriptionBadge.textContent = 'Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·';
            } else {
                subscriptionBadge.className += ' bg-danger';
                subscriptionBadge.textContent = 'Ø§Ø´ØªØ±Ø§Ùƒ ØºÙŠØ± Ù†Ø´Ø·';
            }
            
            document.getElementById('userRole').after(subscriptionBadge);
        }

        // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ====================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await window.firebaseAuth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                return;
            }
            
            try {
                const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                await window.firestoreDB.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    subscription: {
                        type: 'monthly',
                        status: 'inactive',
                        startDate: null,
                        endDate: null
                    }
                });
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.firebaseAuth.signOut();
        });

        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'block';
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
        });

        // Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
        document.getElementById('ownerLoginBtn').addEventListener('click', async () => {
            if (!confirm('Ø³ÙŠØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                return;
            }
            
            const button = document.getElementById('ownerLoginBtn');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                button.disabled = true;
                
                await setupOwnerAccount();
                // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ù„Ø£Ù† onAuthStateChanged Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§Ù„Ùƒ: ' + error.message);
                
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙƒÙ…Ø§Ù„Ùƒ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
        document.getElementById('quickOwnerLogin').addEventListener('click', async () => {
            const button = document.getElementById('quickOwnerLogin');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="bi bi-lightning-charge"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹...';
                button.disabled = true;
                
                await setupOwnerAccount();
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹: ' + error.message);
                
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // ==================== ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase ====================
        async function checkFirebaseConnection() {
            try {
                if (!window.firestoreDB) {
                    console.warn('âš ï¸ Firestore ØºÙŠØ± Ù…Ù‡ÙŠØ¦ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    window.firestoreDB = firebase.firestore();
                    window.firebaseAuth = firebase.auth();
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ§Øª
                await window.firestoreDB.collection('users').limit(1).get();
                console.log('âœ… Ø§ØªØµØ§Ù„ Firebase Ù†Ø´Ø· ÙˆÙŠØ¹Ù…Ù„');
                return true;
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase:', error);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (error.code === 'permission-denied' || error.code === 'missing-or-insufficient-permissions') {
                    console.warn('âš ï¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø´Ø· - ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¹Ù…Ù„');
                    return true;
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©
                if (error.code === 'unavailable' || error.code === 'network-request-failed') {
                    console.warn('âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©');
                    alert('âš ï¸ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ.');
                    return false;
                }
                
                console.warn('âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error.code);
                return false;
            }
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
            checkFirebaseConnection().then(connected => {
                if (connected) {
                    initAuth();
                }
            });
        });

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ ====================
        async function loadUsersList() {
            try {
                const usersSnapshot = await db.collection('users').where('role', '==', 'user').get();
                const users = [];
                
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                updateUsersTable(users);
                updateKPIs(users);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function updateUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = user.subscription.status === 'active' ? 'subscription-active' : 'subscription-expired';
                
                const endDate = user.subscription.endDate ? 
                    new Date(user.subscription.endDate.seconds * 1000).toLocaleDateString('ar-YE') : 
                    'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.createdAt.seconds * 1000).toLocaleDateString('ar-YE')}</td>
                    <td>
                        <span class="badge ${user.subscription.status === 'active' ? 'bg-success' : 'bg-danger'}">
                            ${user.subscription.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                        </span>
                    </td>
                    <td>${endDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="${user.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', () => editUser(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteUser(btn.dataset.id));
            });
        }

        function updateKPIs(users) {
            document.getElementById('totalUsers').textContent = users.length;
            
            const activeSubscriptions = users.filter(user => 
                user.subscription.status === 'active'
            ).length;
            document.getElementById('activeSubscriptions').textContent = activeSubscriptions;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const expiringSubscriptions = users.filter(user => {
                if (!user.subscription.endDate) return false;
                const endDate = new Date(user.subscription.endDate.seconds * 1000);
                return endDate <= weekFromNow && endDate >= now;
            }).length;
            
            document.getElementById('expiringSubscriptions').textContent = expiringSubscriptions;
        }

        async function editUser(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const user = userDoc.data();
                
                document.getElementById('userId').value = userId;
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('subscriptionType').value = user.subscription.type;
                document.getElementById('subscriptionStatus').value = user.subscription.status;
                
                const modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading user for edit:', error);
            }
        }

        document.getElementById('saveUserBtn').addEventListener('click', async () => {
            const userId = document.getElementById('userId').value;
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                subscription: {
                    type: document.getElementById('subscriptionType').value,
                    status: document.getElementById('subscriptionStatus').value,
                    startDate: firebase.firestore.FieldValue.serverTimestamp(),
                    endDate: calculateEndDate(document.getElementById('subscriptionType').value)
                }
            };
            
            try {
                if (userId) {
                    // ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
                    await db.collection('users').doc(userId).update(userData);
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    const password = document.getElementById('userPassword').value;
                    if (!password) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯');
                        return;
                    }
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Firebase Ø£ÙˆÙ„Ø§Ù‹
                    const userCredential = await auth.createUserWithEmailAndPassword(userData.email, password);
                    await userCredential.user.updateProfile({ displayName: userData.name });
                    
                    // Ø«Ù… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    await db.collection('users').doc(userCredential.user.uid).set({
                        ...userData,
                        role: 'user',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                modal.hide();
                
                loadUsersList();
                alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + error.message);
            }
        });

        async function deleteUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
            
            try {
                await db.collection('users').doc(userId).delete();
                loadUsersList();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + error.message);
            }
        }

        document.getElementById('addUserBtn').addEventListener('click', () => {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        });

        function calculateEndDate(subscriptionType) {
            const now = new Date();
            let endDate = new Date();
            
            switch (subscriptionType) {
                case 'monthly':
                    endDate.setMonth(now.getMonth() + 1);
                    break;
                case 'quarterly':
                    endDate.setMonth(now.getMonth() + 3);
                    break;
                case 'yearly':
                    endDate.setFullYear(now.getFullYear() + 1);
                    break;
            }
            
            return firebase.firestore.Timestamp.fromDate(endDate);
        }

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====================
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
        }

        // ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
            
            // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('appSidebar').classList.toggle('show');
            });
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    const moduleId = this.dataset.module;
                    showModule(moduleId);
                });
            });
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
                
                checkFirebaseConnection().then(connected => {
                    if (connected) {
                        console.log('ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ Firebase - ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
                        initAuth();
                    } else {
                        console.log('ğŸŸ¡ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Firebase - ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ');
                        useOfflineMode = true;
                        initLocalSystem();
                        showApp();
                        alert('âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø©.');
                    }
                }).catch(error => {
                    console.error('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    useOfflineMode = true;
                    initLocalSystem();
                    showApp();
                });
            });

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
            initLocalSystem();
        });

        // ==================== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ ====================
        function initLocalSystem() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
            loadFallbackLibraries().then(() => {
                initDatabase();
                startBalanceAutoRefresh();
            });

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'bi bi-moon' : 'bi bi-sun';
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
            setupLocalEventListeners();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            setTimeout(() => {
                loadSettings();
                updateBalance();
                loadProductsForPOS();
                loadCategories();
                loadSuppliers();
                loadCustomers();
                updateCartCount();
                updateCartDisplay();
                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            }, 1000);
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ ====================
        // [Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ù‡Ù†Ø§]

         // ==================== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ====================
        function loadFallbackLibraries() {
            return new Promise((resolve) => {
                const libraries = [
                    {
                        name: 'Bootstrap',
                        check: () => typeof bootstrap !== 'undefined',
                        url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'
                    },
                    {
                        name: 'Chart.js',
                        check: () => typeof Chart !== 'undefined', 
                        url: 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'
                    },
                    {
                        name: 'XLSX',
                        check: () => typeof XLSX !== 'undefined',
                        url: 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'
                    }
                ];

                let loadedCount = 0;
                const totalLibraries = libraries.length;

                function checkAllLoaded() {
                    loadedCount++;
                    if (loadedCount === totalLibraries) {
                        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                        resolve();
                    }
                }

                libraries.forEach(lib => {
                    if (!lib.check()) {
                        console.log(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${lib.name} Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ...`);
                        const script = document.createElement('script');
                        script.src = lib.url;
                        script.onload = checkAllLoaded;
                        script.onerror = () => {
                            console.error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ${lib.name}`);
                            checkAllLoaded();
                        };
                        document.head.appendChild(script);
                    } else {
                        console.log(`${lib.name} Ù…Ø­Ù…Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹`);
                        checkAllLoaded();
                    }
                });
            });
        }

        /**
        * ØªÙ‡ÙŠØ¦Ø© IndexedDB
        */
        function initDatabase() {
            const request = indexedDB.open('ERP12_Database', 1); // â­â­â­â­â­â­

            request.onerror = function(event) {
                console.error('ÙØ´Ù„ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', event.target.error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!');
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('ØªÙ… ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                initializeChartOfAccounts().then(() => {
                    updateBalance();
                    loadProductsForPOS();
                    loadCategories();
                    loadSuppliers();
                });
            };

            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                const newVersion = event.newVersion;
                
                console.log(`Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${oldVersion} Ø¥Ù„Ù‰ ${newVersion}`);
                
                // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                const storeNames = ['products', 'invoices', 'customers', 'suppliers', 'cashTransactions', 'settings', 'chartOfAccounts', 'journalEntries', 'purchaseInvoices', 'categories'];
                
                // Ø­Ø°Ù Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                Array.from(db.objectStoreNames).forEach(storeName => {
                    if (!storeNames.includes(storeName)) {
                        db.deleteObjectStore(storeName);
                    }
                });

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³
                if (!db.objectStoreNames.contains('products')) {
                    const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    productsStore.createIndex('code', 'code', { unique: true });
                    productsStore.createIndex('categoryId', 'categoryId', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØ¦Ø§Øª
                    productsStore.createIndex('name', 'name', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
                } else if (oldVersion < 4) {
                    // â­ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
                    const transaction = event.currentTarget.transaction;
                    const productsStore = transaction.objectStore('products');
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    if (!productsStore.indexNames.contains('categoryId')) {
                        productsStore.createIndex('categoryId', 'categoryId', { unique: false });
                    }
                    if (!productsStore.indexNames.contains('name')) {
                        productsStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('invoices')) {
                    const invoicesStore = db.createObjectStore('invoices', { keyPath: 'id', autoIncrement: true });
                    invoicesStore.createIndex('invoiceNumber', 'invoiceNumber', { unique: true });
                    invoicesStore.createIndex('date', 'date', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const invoicesStore = transaction.objectStore('invoices');
                    if (!invoicesStore.indexNames.contains('date')) {
                        invoicesStore.createIndex('date', 'date', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('customers')) {
                    const customersStore = db.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                    customersStore.createIndex('accCode', 'accCode', { unique: true });
                    customersStore.createIndex('name', 'name', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const customersStore = transaction.objectStore('customers');
                    if (!customersStore.indexNames.contains('name')) {
                        customersStore.createIndex('name', 'name', { unique: false });
                    }
                }

                if (!db.objectStoreNames.contains('suppliers')) {
                    const suppliersStore = db.createObjectStore('suppliers', { keyPath: 'id', autoIncrement: true });
                    suppliersStore.createIndex('accCode', 'accCode', { unique: true });
                    suppliersStore.createIndex('name', 'name', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const suppliersStore = transaction.objectStore('suppliers');
                    if (!suppliersStore.indexNames.contains('name')) {
                        suppliersStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('cashTransactions')) {
                    const cashStore = db.createObjectStore('cashTransactions', { keyPath: 'id', autoIncrement: true });
                    cashStore.createIndex('date', 'date', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                    cashStore.createIndex('type', 'type', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†ÙˆØ¹
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const cashStore = transaction.objectStore('cashTransactions');
                    if (!cashStore.indexNames.contains('date')) {
                        cashStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!cashStore.indexNames.contains('type')) {
                        cashStore.createIndex('type', 'type', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                
                if (!db.objectStoreNames.contains('chartOfAccounts')) {
                    const coaStore = db.createObjectStore('chartOfAccounts', { keyPath: 'code' });
                    coaStore.createIndex('parentCode', 'parentCode', { unique: false });
                    coaStore.createIndex('type', 'type', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†ÙˆØ¹
                    coaStore.createIndex('customerId', 'customerId', { unique: false }); // â­ Ø¬Ø¯ÙŠØ¯
                    coaStore.createIndex('supplierId', 'supplierId', { unique: false }); // â­ Ø¬Ø¯ÙŠØ¯
                    coaStore.createIndex('accountType', 'accountType', { unique: false }); // â­ Ø¬Ø¯ÙŠØ¯
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const coaStore = transaction.objectStore('chartOfAccounts');
                    if (!coaStore.indexNames.contains('type')) {
                        coaStore.createIndex('type', 'type', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('journalEntries')) {
                    const journalStore = db.createObjectStore('journalEntries', { keyPath: 'id', autoIncrement: true });
                    journalStore.createIndex('date', 'date', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const journalStore = transaction.objectStore('journalEntries');
                    if (!journalStore.indexNames.contains('date')) {
                        journalStore.createIndex('date', 'date', { unique: false });
                    }
                }

                if (!db.objectStoreNames.contains('purchaseInvoices')) {
                    const purchaseStore = db.createObjectStore('purchaseInvoices', { keyPath: 'id', autoIncrement: true });
                    purchaseStore.createIndex('date', 'date', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                    purchaseStore.createIndex('supplierId', 'supplierId', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙˆØ±Ø¯
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const purchaseStore = transaction.objectStore('purchaseInvoices');
                    if (!purchaseStore.indexNames.contains('date')) {
                        purchaseStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!purchaseStore.indexNames.contains('supplierId')) {
                        purchaseStore.createIndex('supplierId', 'supplierId', { unique: false });
                    }
                }
                
                if (!db.objectStoreNames.contains('categories')) {
                    const categoriesStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    categoriesStore.createIndex('name', 'name', { unique: false }); // â­ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
                } else if (oldVersion < 4) {
                    const transaction = event.currentTarget.transaction;
                    const categoriesStore = transaction.objectStore('categories');
                    if (!categoriesStore.indexNames.contains('name')) {
                        categoriesStore.createIndex('name', 'name', { unique: false });
                    }
                }
                
                console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙÙ‡Ø§Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­.');
            };
        }
         // ==================== 4.1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†Ù…Ø· ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ====================
        
        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨ÙŠÙ† Ø§Ù„ÙØ§ØªØ­ ÙˆØ§Ù„Ø¯Ø§ÙƒÙ†
         */
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            document.getElementById('themeIcon').className = newTheme === 'dark' ? 'bi bi-moon' : 'bi bi-sun';
            localStorage.setItem('theme', newTheme);
        }

        /**
         * Ø¹Ø±Ø¶ ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ù‚ÙŠØ©
         * @param {string} moduleId - Ù…ÙØ¹Ø±Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§ (Ù…Ø«Ù„ 'dashboard').
         */
        function showModule(moduleId) {
            document.querySelectorAll('.module').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(moduleId).classList.add('active');

            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.sidebar .nav-link[data-module="${moduleId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // ØªØ­Ø¯ÙŠØ«Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø§Øª

            if (moduleId === 'dashboard') {
                showDashboard();
            } else if (moduleId === 'pos') {
                initializePOSModule();
            } else if (moduleId === 'inventory') {
                showSubTab('inventory-items');
                loadProductsTable();
            } else if (moduleId === 'inventory') {
                 // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                 showSubTab('inventory-items');
                 loadProductsTable();
            } else if (moduleId === 'accounting') {
                displayChartOfAccounts();
                loadJournalEntries();
            } else if (moduleId === 'cash') {
                loadCashTransactions();

            }
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ====================

        /**
        * ØªØ­Ø¯ÙŠØ« ÙˆØ¥Ø¸Ù‡Ø§Ø± ÙˆØ­Ø¯Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        */
        function showDashboard() {
            loadDashboardData();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        */
        async function loadDashboardData() {
            try {
                console.log('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
                
                await Promise.all([
                    loadTodaySales(),
                    loadTodayPurchases(),
                    loadInventoryValues(),
                    loadSalesReports(),
                    loadPurchasesReports(),
                    loadCustomersSuppliersCount(),
                    loadCapitalAndProfit(),
                    loadCreditSales(),
                    loadCreditPurchases()
                ]);
                
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        */
        async function loadTodaySales() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const invoices = await getAllInvoices();
                
                const todayInvoices = invoices.filter(invoice => 
                    invoice.date.startsWith(today)
                );
                
                const todaySales = todayInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                let todayProfit = 0;
                todayInvoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            const cost = item.purchasePrice * item.quantity;
                            const revenue = item.price * item.quantity;
                            todayProfit += (revenue - cost);
                        });
                    }
                });
                
                document.getElementById('todaySales').textContent = todaySales.toFixed(2) + ' Ø±.ÙŠ';
                document.getElementById('todayProfit').textContent = todayProfit.toFixed(2) + ' Ø±.ÙŠ';
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        */
        async function loadTodayPurchases() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                const todayPurchases = purchases.filter(purchase => 
                    purchase.date.startsWith(today)
                );
                
                const todayPurchasesTotal = todayPurchases.reduce((sum, purchase) => sum + purchase.total, 0);
                
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                console.log('Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:', todayPurchasesTotal);
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        */
        async function loadInventoryValues() {
            try {
                const products = await getAllProducts();
                
                // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
                const inventoryValueCost = products.reduce((sum, product) => 
                    sum + (product.purchasePrice * product.quantity), 0
                );
                
                // Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
                const inventoryValueSale = products.reduce((sum, product) => 
                    sum + (product.salePrice * product.quantity), 0
                );
                
                document.getElementById('inventoryValueCost').textContent = inventoryValueCost.toFixed(2) + ' Ø±.ÙŠ';
                document.getElementById('inventoryValueSale').textContent = inventoryValueSale.toFixed(2) + ' Ø±.ÙŠ';
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        */
        async function loadSalesReports() {
            try {
                const invoices = await getAllInvoices();
                
                // ØªØµÙ†ÙŠÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                const cashInvoices = invoices.filter(inv => inv.paymentMethod === 'cash');
                const creditInvoices = invoices.filter(inv => inv.paymentMethod === 'credit');
                
                const tbody = document.getElementById('salesReportsTable');
                tbody.innerHTML = '';
                
                // ÙÙˆØ§ØªÙŠØ± Ù†Ù‚Ø¯ÙŠØ©
                const cashRow = document.createElement('tr');
                cashRow.innerHTML = `
                    <td>ÙÙˆØ§ØªÙŠØ± Ù†Ù‚Ø¯ÙŠØ©</td>
                    <td>${cashInvoices.length}</td>
                    <td>${cashInvoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(cashRow);
                
                // ÙÙˆØ§ØªÙŠØ± Ø¢Ø¬Ù„Ø©
                const creditRow = document.createElement('tr');
                creditRow.innerHTML = `
                    <td>ÙÙˆØ§ØªÙŠØ± Ø¢Ø¬Ù„Ø©</td>
                    <td>${creditInvoices.length}</td>
                    <td>${creditInvoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(creditRow);
                
                // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                const totalRow = document.createElement('tr');
                totalRow.className = 'fw-bold table-active';
                totalRow.innerHTML = `
                    <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>${invoices.length}</td>
                    <td>${invoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(totalRow);
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        */
        async function loadPurchasesReports() {
            try {
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                // ØªØµÙ†ÙŠÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                const cashPurchases = purchases.filter(p => p.paymentMethod === 'cash');
                const creditPurchases = purchases.filter(p => p.paymentMethod === 'credit');
                
                const tbody = document.getElementById('purchasesReportsTable');
                tbody.innerHTML = '';
                
                // ÙÙˆØ§ØªÙŠØ± Ù†Ù‚Ø¯ÙŠØ©
                const cashRow = document.createElement('tr');
                cashRow.innerHTML = `
                    <td>Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ù‚Ø¯ÙŠØ©</td>
                    <td>${cashPurchases.length}</td>
                    <td>${cashPurchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(cashRow);
                
                // ÙÙˆØ§ØªÙŠØ± Ø¢Ø¬Ù„Ø©
                const creditRow = document.createElement('tr');
                creditRow.innerHTML = `
                    <td>Ù…Ø´ØªØ±ÙŠØ§Øª Ø¢Ø¬Ù„Ø©</td>
                    <td>${creditPurchases.length}</td>
                    <td>${creditPurchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(creditRow);
                
                // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                const totalRow = document.createElement('tr');
                totalRow.className = 'fw-bold table-active';
                totalRow.innerHTML = `
                    <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                    <td>${purchases.length}</td>
                    <td>${purchases.reduce((sum, p) => sum + p.total, 0).toFixed(2)} Ø±.ÙŠ</td>
                `;
                tbody.appendChild(totalRow);
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        */
        async function loadCustomersSuppliersCount() {
            try {
                const [customers, suppliers] = await Promise.all([
                    loadCustomers(),
                    loadSuppliers()
                ]);
                
                document.getElementById('customersCount').textContent = customers.length;
                document.getElementById('suppliersCount').textContent = suppliers.length;
                
                // Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ 5 Ø¹Ù…Ù„Ø§Ø¡
                const topCustomers = customers
                    .filter(c => c.balance > 0)
                    .sort((a, b) => (b.balance || 0) - (a.balance || 0))
                    .slice(0, 5);
                
                const topCustomersList = document.getElementById('topCustomersList');
                topCustomersList.innerHTML = '';
                
                if (topCustomers.length === 0) {
                    topCustomersList.innerHTML = '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>';
                } else {
                    topCustomers.forEach(customer => {
                        const customerDiv = document.createElement('div');
                        customerDiv.className = 'd-flex justify-content-between align-items-center border-bottom py-1';
                        customerDiv.innerHTML = `
                            <span>${customer.name}</span>
                            <span class="text-danger fw-bold">${(customer.balance || 0).toFixed(2)} Ø±.ÙŠ</span>
                        `;
                        topCustomersList.appendChild(customerDiv);
                    });
                }
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
        */
        async function loadCapitalAndProfit() {
            try {
                // Ø¬Ù„Ø¨ Ø­Ø³Ø§Ø¨ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
                const capitalAccount = await new Promise((resolve) => {
                    const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                    const store = transaction.objectStore('chartOfAccounts');
                    const request = store.get('2020'); // ÙƒÙˆØ¯ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
                    request.onsuccess = () => resolve(request.result);
                });
                
                // Ø¬Ù„Ø¨ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©
                const retainedEarnings = await new Promise((resolve) => {
                    const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                    const store = transaction.objectStore('chartOfAccounts');
                    const request = store.get('3050'); // ÙƒÙˆØ¯ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©
                    request.onsuccess = () => resolve(request.result);
                });
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
                const invoices = await getAllInvoices();
                let totalProfit = 0;
                
                invoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            const cost = (item.purchasePrice || 0) * item.quantity;
                            const revenue = item.price * item.quantity;
                            totalProfit += (revenue - cost);
                        });
                    }
                });
                
                // Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¨Ø¹Ø¯ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ)
                const netProfit = totalProfit; // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø®ØµÙ… Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
                
                document.getElementById('currentCapital').textContent = 
                    ((capitalAccount?.balance || 0) + (retainedEarnings?.balance || 0)).toFixed(2) + ' Ø±.ÙŠ';
                
                document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' Ø±.ÙŠ';
                document.getElementById('netProfit').textContent = netProfit.toFixed(2) + ' Ø±.ÙŠ';
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„Ø©
        */
        async function loadCreditSales() {
            try {
                const invoices = await getAllInvoices();
                const creditInvoices = invoices.filter(inv => inv.paymentMethod === 'credit');
                
                const tbody = document.getElementById('creditSalesTable');
                tbody.innerHTML = '';
                
                if (creditInvoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨ÙŠØ¹ Ø¢Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                
                creditInvoices.forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${new Date(invoice.date).toLocaleDateString('ar-YE')}</td>
                        <td>${invoice.total.toFixed(2)} Ø±.ÙŠ</td>
                        <td><span class="badge bg-warning">Ø¢Ø¬Ù„</span></td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„Ø©:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø¬Ù„Ø©
        */
        async function loadCreditPurchases() {
            try {
                const purchases = await new Promise((resolve) => {
                    const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                    const store = transaction.objectStore('purchaseInvoices');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
                
                const creditPurchases = purchases.filter(p => p.paymentMethod === 'credit');
                
                const tbody = document.getElementById('creditPurchasesTable');
                tbody.innerHTML = '';
                
                if (creditPurchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø´Ø±Ø§Ø¡ Ø¢Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                
                creditPurchases.forEach(purchase => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${purchase.invoiceNumber || purchase.id}</td>
                        <td>${purchase.supplierName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${new Date(purchase.date).toLocaleDateString('ar-YE')}</td>
                        <td>${purchase.total.toFixed(2)} Ø±.ÙŠ</td>
                        <td><span class="badge bg-warning">Ø¢Ø¬Ù„</span></td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø¬Ù„Ø©:', error);
            }
        }

        /**
        * ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        */
        function refreshDashboard() {
            loadDashboardData();
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
        }

        /**
         * Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
         */
        function showSubTab(tabId) {
            document.querySelectorAll('#inventoryTabs .tab-pane').forEach(el => el.classList.remove('show', 'active'));
            document.getElementById(tabId).classList.add('show', 'active');
            
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-tabs .nav-link[data-tab="${tabId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (tabId === 'inventory-items') {
                loadProductsTable();
            } else if (tabId === 'inventory-purchases') {
                loadPurchasesTable();
            } else if (tabId === 'inventory-categories') {
                loadCategoriesTable();
            } else if (tabId === 'inventory-movements') {
                loadMovementsProductSelect();
            } else if (tabId === 'inventory-suppliers') {
                loadSuppliersTable();
            } else if (tabId === 'inventory-customers') { // â­ Ø¬Ø¯ÙŠØ¯
                loadCustomersTable();
            }
        }
        /**
         * ØªÙ‡ÙŠØ¦Ø© Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„.
         */
        function initializeChartOfAccounts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');

                const countRequest = store.count();
                countRequest.onsuccess = function() {
                    if (countRequest.result === 0) {
                        console.log('ØªÙ‡ÙŠØ¦Ø© Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©...');
                        DEFAULT_ACCOUNTS.forEach(account => {
                            store.add(account);
                        });
                        transaction.oncomplete = () => {
                            console.log('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.');
                            resolve(true);
                        };
                    } else {
                        resolve(false);
                    }
                };

                countRequest.onerror = (e) => reject(e.target.error);
            });
        }
        
        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        async function loadProductsForPurchase() {
            try {
                const products = await getAllProducts();
                const productSelects = document.querySelectorAll('.product-select');
                
                productSelects.forEach(select => {
                    // Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
                    
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.code})`;
                        select.appendChild(option);
                    });
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    if (currentValue) {
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø´Ø±Ø§Ø¡:', error);
            }
        }

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        async function loadCustomers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    customers = request.result;
                    resolve(customers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        function getAllInvoices() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© Ù…Ø²Ø¯ÙˆØ¬.
         */
        function createJournalEntry(description, debits, credits, refType, refId, transaction) {
            return new Promise((resolve, reject) => {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù…Ø¹Ø§Ù…Ù„Ø©ØŒ Ù†Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                if (!transaction) {
                    transaction = db.transaction(['journalEntries', 'chartOfAccounts'], 'readwrite');
                }
                
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§Ø²Ù† Ø§Ù„Ù‚ÙŠØ¯
                const totalDebits = debits.reduce((sum, item) => sum + item.amount, 0);
                const totalCredits = credits.reduce((sum, item) => sum + item.amount, 0);
                const difference = Math.abs(totalDebits - totalCredits);
                
                if (difference > 0.01) {
                    reject(new Error(`Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†. Ø§Ù„Ù…Ø¯ÙŠÙ†: ${totalDebits.toFixed(2)}ØŒ Ø§Ù„Ø¯Ø§Ø¦Ù†: ${totalCredits.toFixed(2)}ØŒ Ø§Ù„ÙØ±Ù‚: ${difference.toFixed(2)}`));
                    return;
                }
                
                const entry = {
                    date: new Date().toISOString(),
                    description: description,
                    debits: debits,
                    credits: credits,
                    refType: refType,
                    refId: refId,
                    balanced: true,
                    totalAmount: totalDebits,
                    createdAt: new Date().toISOString()
                };
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯
                const journalRequest = journalStore.add(entry);

                journalRequest.onsuccess = function() {
                    const entryId = journalRequest.result;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    const updatePromises = [];
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                    debits.forEach(debitEntry => {
                        updatePromises.push(new Promise((resolveUpdate, rejectUpdate) => {
                            const accountRequest = coaStore.get(debitEntry.accountCode);
                            accountRequest.onsuccess = function(e) {
                                const account = e.target.result;
                                if (account) {
                                    account.balance = (account.balance || 0) + debitEntry.amount;
                                    account.lastUpdated = new Date().toISOString();
                                    
                                    const putRequest = coaStore.put(account);
                                    putRequest.onsuccess = () => resolveUpdate();
                                    putRequest.onerror = (e) => rejectUpdate(e.target.error);
                                } else {
                                    rejectUpdate(new Error(`Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${debitEntry.accountCode}`));
                                }
                            };
                            accountRequest.onerror = (e) => rejectUpdate(e.target.error);
                        }));
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©
                    credits.forEach(creditEntry => {
                        updatePromises.push(new Promise((resolveUpdate, rejectUpdate) => {
                            const accountRequest = coaStore.get(creditEntry.accountCode);
                            accountRequest.onsuccess = function(e) {
                                const account = e.target.result;
                                if (account) {
                                    account.balance = (account.balance || 0) - creditEntry.amount;
                                    account.lastUpdated = new Date().toISOString();
                                    
                                    const putRequest = coaStore.put(account);
                                    putRequest.onsuccess = () => resolveUpdate();
                                    putRequest.onerror = (e) => rejectUpdate(e.target.error);
                                } else {
                                    rejectUpdate(new Error(`Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${creditEntry.accountCode}`));
                                }
                            };
                            accountRequest.onerror = (e) => rejectUpdate(e.target.error);
                        }));
                    });
                    
                    // Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    Promise.all(updatePromises)
                        .then(() => {
                            console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ: ${description}`);
                            resolve(entryId);
                        })
                        .catch(error => {
                            console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', error);
                            reject(error);
                        });
                };
                
                journalRequest.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        /**
         * Ø¬Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         */
        async function updateBalance() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error('âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                    reject(new Error("Database not initialized"));
                    return;
                }
                
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                
                const request = store.get('1010'); // ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                
                request.onsuccess = function() {
                    const cashAccount = request.result;
                    const balance = cashAccount ? (cashAccount.balance || 0.00) : 0.00;
                    
                    console.log('ğŸ’° ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:', balance.toFixed(2));
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶
                    const balanceElements = [
                        'currentBalance',
                        'posBalance', 
                        'cashModuleBalance'
                    ];
                    
                    balanceElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = `${balance.toFixed(2)} Ø±.ÙŠ`;
                        }
                    });
                    
                    resolve(balance);
                };
                
                request.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯:', e.target.error);
                    reject(e.target.error);
                };
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
                transaction.oncomplete = () => {
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯');
                };
            });
        }

        // Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±ØµÙŠØ¯ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
        function startBalanceAutoRefresh() {
            setInterval(async () => {
                try {
                    await updateBalance();
                } catch (error) {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±ØµÙŠØ¯:', error);
                }
            }, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†
        }

        // ==================== 4.3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ====================

        /**
         * Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† IndexedDB
         */
        function getAllProducts() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Ø¬Ù„Ø¨ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† IndexedDB
         */
        function loadCategories() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['categories'], 'readonly');
                const store = transaction.objectStore('categories');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    categories = request.result;
                    resolve(categories);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…Ù† IndexedDB
         */
        function loadSuppliers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readonly');
                const store = transaction.objectStore('suppliers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    suppliers = request.result;
                    resolve(suppliers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Ø­ÙØ¸ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ù‡
         */
        function saveProduct(product) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† ID)ØŒ Ù†Ø¶ÙŠÙÙ‡
                if (!product.id) {
                    const request = store.add(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ø­Ø¯Ø«Ù‡
                    const request = store.put(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                }
            });
        }

        /**
         * Ø­Ø°Ù ØµÙ†Ù
         */
        function deleteProduct(id) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve(true);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
         */
        async function loadProductsTable() {
            try {
                const products = await getAllProducts();
                const tbody = document.getElementById('productsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    if (product.quantity <= (product.minQuantity || 5)) {
                        row.classList.add('low-stock');
                    }
                    
                    if (product.expiryDate && new Date(product.expiryDate) < new Date()) {
                        row.classList.add('expired');
                    }
                    
                    row.innerHTML = `
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.purchasePrice.toFixed(2)} Ø±.ÙŠ</td>
                        <td>${product.salePrice.toFixed(2)} Ø±.ÙŠ</td>
                        <td>${product.expiryDate ? new Date(product.expiryDate).toLocaleDateString('ar-YE') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-product-btn" data-id="${product.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-sm btn-outline-danger delete-product-btn" data-id="${product.id}">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
            }
        }

        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ - Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
        */
        async function openProductModal(productId = null) {
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            const form = document.getElementById('productForm');
            
            // â­ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await loadSettings();
            
            // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ¦Ø§Øª
            const categorySelect = document.getElementById('productCategory');
            categorySelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø©</option>';
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
            
            // â­ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
            await setupQuantityFieldVisibility();
            
            if (productId) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                document.getElementById('productModalLabel').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù';
                
                try {
                    const product = await getProductById(parseInt(productId));
                    if (product) {
                        document.getElementById('productId').value = product.id;
                        document.getElementById('productCode').value = product.code;
                        document.getElementById('productName').value = product.name;
                        document.getElementById('productPurchasePrice').value = product.purchasePrice;
                        document.getElementById('productSalePrice').value = product.salePrice;
                        
                        // â­ Ø§Ø­ØªØ±Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        const showQuantityField = await getSetting('showQuantityField', true);
                        if (showQuantityField) {
                            document.getElementById('productQuantity').value = product.quantity;
                        } else {
                            document.getElementById('productQuantity').value = '0';
                        }
                        
                        document.getElementById('productMinQuantity').value = product.minQuantity || 5;
                        document.getElementById('productExpiryDate').value = product.expiryDate || '';
                        document.getElementById('productCategory').value = product.categoryId || '';
                        document.getElementById('productImage').value = product.image || 'ğŸ“¦';
                    }
                } catch (error) {
                    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬:', error);
                }
            } else {
                // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                document.getElementById('productModalLabel').textContent = 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
                form.reset();
                document.getElementById('productId').value = '';
                
                // â­ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ…ÙŠØ© ØµÙØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù…Ø®ÙÙŠØ§Ù‹
                const showQuantityField = await getSetting('showQuantityField', true);
                if (!showQuantityField) {
                    document.getElementById('productQuantity').value = '0';
                }
            }
            
            modal.show();
        }

        /**
        * Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        */
        async function getSetting(key, defaultValue = null) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(defaultValue);
                    return;
                }
                
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                
                request.onsuccess = function() {
                    if (request.result) {
                        resolve(request.result.value);
                    } else {
                        resolve(defaultValue);
                    }
                };
                
                request.onerror = () => resolve(defaultValue);
            });
        }

        /**
        * Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
        */
        async function setupQuantityFieldVisibility() {
            try {
                const showQuantityField = await getSetting('showQuantityField', true);
                const quantityField = document.getElementById('productQuantity');
                const quantityLabel = document.querySelector('label[for="productQuantity"]');
                
                if (quantityField && quantityLabel) {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
                    const existingNotes = quantityField.parentNode.querySelectorAll('.quantity-field-note');
                    existingNotes.forEach(note => note.remove());
                    
                    if (!showQuantityField) {
                        quantityField.style.display = 'none';
                        quantityLabel.style.display = 'none';
                        quantityField.value = '0';
                        quantityField.readOnly = true;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
                        const note = document.createElement('small');
                        note.className = 'form-text text-muted d-block quantity-field-note';
                        note.textContent = 'âš ï¸ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø®ÙÙŠ. ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¹Ø¨Ø± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·';
                        quantityField.parentNode.appendChild(note);
                        
                        console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©');
                    } else {
                        quantityField.style.display = 'block';
                        quantityLabel.style.display = 'block';
                        quantityField.readOnly = false;
                        quantityField.placeholder = 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©';
                        
                        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©');
                    }
                }
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©:', error);
            }
        }

        /**
        * Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
        */
        async function saveQuantityFieldSetting() {
            const showQuantityField = document.getElementById('showQuantityFieldSetting').checked;
            
            try {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                await store.put({ key: 'showQuantityField', value: showQuantityField });
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ÙØªÙˆØ­Ø©
                await applyQuantityFieldSettingToAllModals(showQuantityField);
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬.');
            } catch (error) {
                console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        */
        async function applyQuantityFieldSettingToAllModals(showQuantityField) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const productModal = document.getElementById('productModal');
            if (productModal && productModal.style.display !== 'none') {
                await setupQuantityFieldVisibility();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
            if (currentView === 'products' && currentCategoryId) {
                await loadProductsForCategory(currentCategoryId);
            }
        }

        /**
        * Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ - Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª (Ø¥Ø¶Ø§ÙØ© Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„)
        */
        async function saveProductFromForm() {
            const form = document.getElementById('productForm');
            const productId = document.getElementById('productId').value;
            
            // â­ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
            const showQuantityField = await getSetting('showQuantityField', true);
            
            const product = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value) || 0,
                salePrice: parseFloat(document.getElementById('productSalePrice').value),
                // â­ Ø§Ø­ØªØ±Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ©
                quantity: showQuantityField ? (parseInt(document.getElementById('productQuantity').value) || 0) : 0,
                minQuantity: parseInt(document.getElementById('productMinQuantity').value) || 5,
                expiryDate: document.getElementById('productExpiryDate').value || null,
                categoryId: document.getElementById('productCategory').value || null,
                image: document.getElementById('productImage').value || 'ğŸ“¦'
            };
            
            if (productId) {
                product.id = parseInt(productId);
            }

            try {
                const savedProductId = await saveProduct(product);
                
                // âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª: Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ÙƒØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                const inventoryValue = product.purchasePrice * product.quantity;
                
                if ((!productId || productId === '') && inventoryValue > 0) {
                    await recordManualInventoryAsCapital(product, inventoryValue, savedProductId);
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                
                loadProductsTable();
                loadProductsForPOS();
                displayChartOfAccounts();
                updateBalance();
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ© ÙƒØ±Ø£Ø³ Ù…Ø§Ù„ (Ø­Ù„ Ù…Ø¤Ù‚Øª)
        */
        async function recordManualInventoryAsCapital(product, inventoryValue, productId) {
            try {
                const description = `Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙŠØ¯ÙˆÙŠ - ${product.name} (${product.code})`;
                
                const debits = [{
                    accountCode: '1030', // Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    amount: inventoryValue,
                    description: `Ù…Ø®Ø²ÙˆÙ† Ù…Ø¶Ø§Ù ÙŠØ¯ÙˆÙŠØ§Ù‹: ${product.name}`
                }];
                
                const credits = [{
                    accountCode: '2020', // Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
                    amount: inventoryValue,
                    description: 'ØªÙ…ÙˆÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† ÙŠØ¯ÙˆÙŠ (Ø­Ù„ Ù…Ø¤Ù‚Øª)'
                }];
                
                await createJournalEntry(
                    description,
                    debits,
                    credits,
                    'ManualInventory_Capital',
                    productId
                );
                
                console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¤Ù‚Øª: ${inventoryValue.toFixed(2)} Ø±.ÙŠ Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„`);
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¤Ù‚Øª:', error);
            }
        }
        /**
        * Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        */
        async function handleInventoryUpdate(updatedProduct, newValue, productId) {
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                const oldProduct = await getProductById(productId);
                const oldValue = oldProduct.purchasePrice * oldProduct.quantity;
                const valueDifference = newValue - oldValue;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©ØŒ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„
                if (Math.abs(valueDifference) > 0.01) {
                    await recordInventoryAdjustmentJournalEntry(
                        oldProduct, 
                        updatedProduct, 
                        valueDifference, 
                        productId
                    );
                }
            } catch (error) {
                console.error('ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error);
            }
        }

        /**
        * ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        */
        async function recordInventoryAdjustmentJournalEntry(oldProduct, newProduct, valueDifference, productId) {
            try {
                const description = `ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† - ${newProduct.name} (${newProduct.code})`;
                
                if (valueDifference > 0) {
                    // Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    const debits = [{
                        accountCode: '1030',
                        amount: valueDifference,
                        description: `Ø²ÙŠØ§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ†: ${newProduct.name}`
                    }];
                    
                    const credits = [{
                        accountCode: '2020',
                        amount: valueDifference,
                        description: 'ØªÙ…ÙˆÙŠÙ„ Ø²ÙŠØ§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ†'
                    }];
                    
                    await createJournalEntry(description, debits, credits, 'InventoryAdjustment', productId);
                } else {
                    // Ù†Ù‚ØµØ§Ù† ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    const debits = [{
                        accountCode: '2020',
                        amount: Math.abs(valueDifference),
                        description: 'ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ù„Ù†Ù‚ØµØ§Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'
                    }];
                    
                    const credits = [{
                        accountCode: '1030',
                        amount: Math.abs(valueDifference),
                        description: `Ù†Ù‚ØµØ§Ù† Ù…Ø®Ø²ÙˆÙ†: ${newProduct.name}`
                    }];
                    
                    await createJournalEntry(description, debits, credits, 'InventoryAdjustment', productId);
                }
                
                console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${valueDifference.toFixed(2)} Ø±.ÙŠ`);
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error);
            }
        }        
        /**
         * Ø­Ø°Ù Ù…Ù†ØªØ¬
         */
        async function deleteProductHandler(productId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                try {
                    await deleteProduct(parseInt(productId));
                    loadProductsTable();
                    loadProductsForPOS();
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                } catch (error) {
                    console.error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬:', error);
                    alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                }
            }
        }

        /**
         * Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù…Ù„Ù Excel
         */
        function importProductsFromExcel(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯.');
                        return;
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                    const requiredColumns = ['ÙƒÙˆØ¯', 'Ø§Ø³Ù…', 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡', 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹', 'Ø§Ù„ÙƒÙ…ÙŠØ©'];
                    const firstRow = jsonData[0];
                    const missingColumns = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));
                    
                    if (missingColumns.length > 0) {
                        alert(`Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${missingColumns.join(', ')}`);
                        return;
                    }
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
                    let totalInventoryValue = 0;
                    const products = jsonData.map(row => {
                        const purchasePrice = parseFloat(row['Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡']) || 0;
                        const quantity = parseInt(row['Ø§Ù„ÙƒÙ…ÙŠØ©']) || 0;
                        const productValue = purchasePrice * quantity;
                        totalInventoryValue += productValue;
                        
                        return {
                            code: row['ÙƒÙˆØ¯'],
                            name: row['Ø§Ø³Ù…'],
                            purchasePrice: purchasePrice,
                            salePrice: parseFloat(row['Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹']) || 0,
                            quantity: quantity,
                            minQuantity: parseInt(row['Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰']) || 5,
                            expiryDate: row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'] || null,
                            categoryId: null,
                            image: row['Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬'] || 'ğŸ“¦',
                            importValue: productValue // Ø­ÙØ¸ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„ÙƒÙ„ Ù…Ù†ØªØ¬
                        };
                    });
                    
                    console.log('ğŸ§® Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯:', totalInventoryValue.toFixed(2));
                    
                    if (totalInventoryValue <= 0) {
                        alert('Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
                        return;
                    }
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
                    const transaction = db.transaction([
                        'products', 
                        'journalEntries', 
                        'chartOfAccounts'
                    ], 'readwrite');
                    
                    const productsStore = transaction.objectStore('products');
                    const journalStore = transaction.objectStore('journalEntries');
                    const coaStore = transaction.objectStore('chartOfAccounts');
                    
                    // 1. Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    let importedCount = 0;
                    for (const product of products) {
                        try {
                            await productsStore.add(product);
                            importedCount++;
                        } catch (error) {
                            console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬:', product.code, error);
                        }
                    }
                    
                    // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
                    const journalEntry = {
                        date: new Date().toISOString(),
                        description: `Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø®Ø²ÙˆÙ† Ø£ÙˆÙ„ÙŠ - ${importedCount} Ù…Ù†ØªØ¬`,
                        debits: [{
                            accountCode: '1030',
                            amount: totalInventoryValue,
                            description: 'Ù…Ø®Ø²ÙˆÙ† Ù…Ø³ØªÙˆØ±Ø¯ Ù…Ù† Ù…Ù„Ù Excel'
                        }],
                        credits: [{
                            accountCode: '2020',
                            amount: totalInventoryValue,
                            description: 'ØªÙ…ÙˆÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† Ø£ÙˆÙ„ÙŠ'
                        }],
                        refType: 'InventoryImport',
                        refId: `IMPORT-${Date.now()}`,
                        balanced: true,
                        totalAmount: totalInventoryValue,
                        importedProducts: importedCount,
                        totalValue: totalInventoryValue,
                        createdAt: new Date().toISOString()
                    };
                    
                    await journalStore.add(journalEntry);
                    
                    // 3. ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (1030)
                    const inventoryAccountRequest = coaStore.get('1030');
                    inventoryAccountRequest.onsuccess = function() {
                        const inventoryAccount = inventoryAccountRequest.result;
                        if (inventoryAccount) {
                            inventoryAccount.balance = (inventoryAccount.balance || 0) + totalInventoryValue;
                            coaStore.put(inventoryAccount);
                        }
                    };
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (2020)
                    const capitalAccountRequest = coaStore.get('2020');
                    capitalAccountRequest.onsuccess = function() {
                        const capitalAccount = capitalAccountRequest.result;
                        if (capitalAccount) {
                            capitalAccount.balance = (capitalAccount.balance || 0) + totalInventoryValue;
                            coaStore.put(capitalAccount);
                        }
                    };
                    
                    transaction.oncomplete = async () => {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                        loadProductsTable();
                        loadProductsForPOS();
                        displayChartOfAccounts();
                        updateBalance();
                        
                        // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©
                        alert(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!

        â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${importedCount} Ù…Ù†ØªØ¬
        â€¢ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${totalInventoryValue.toFixed(2)} Ø±.ÙŠ
        â€¢ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

        ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©.`);
                    };
                    
                } catch (error) {
                    console.error('âŒ ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
                    alert('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        /**
        * ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
        */
        async function recordInventoryImportJournalEntry(products, totalValue) {
            try {
                const description = `Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø®Ø²ÙˆÙ† Ø£ÙˆÙ„ÙŠ - ${products.length} Ù…Ù†ØªØ¬`;
                
                const debits = [{
                    accountCode: '1030', // Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    amount: totalValue,
                    description: 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'
                }];
                
                const credits = [{
                    accountCode: '2020', // Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
                    amount: totalValue,
                    description: 'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯'
                }];
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                await createJournalEntry(
                    description,
                    debits,
                    credits,
                    'InventoryImport',
                    null
                );
                
                console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù‚ÙŠÙ…Ø©: ${totalValue.toFixed(2)} Ø±.ÙŠ`);
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
                throw error;
            }
        }        

        /**
        * ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        */
        async function updateInventoryAccount() {
            try {
                const products = await getAllProducts();
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
                const totalInventoryValue = products.reduce((total, product) => {
                    return total + (product.purchasePrice * product.quantity);
                }, 0);

                // ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (1030) ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                
                const inventoryAccount = await new Promise((resolve) => {
                    const request = store.get('1030'); // ÙƒÙˆØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                    request.onsuccess = () => resolve(request.result);
                });

                if (inventoryAccount) {
                    inventoryAccount.balance = totalInventoryValue;
                    await store.put(inventoryAccount);
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', totalInventoryValue.toFixed(2), 'Ø±.ÙŠ');
                }

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error);
            }
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù Excel
         */
        async function exportProductsToExcel() {
            try {
                const products = await getAllProducts();
                
                if (products.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.');
                    return;
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Excel
                const exportData = products.map(product => ({
                    'ÙƒÙˆØ¯': product.code,
                    'Ø§Ø³Ù…': product.name,
                    'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡': product.purchasePrice,
                    'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹': product.salePrice,
                    'Ø§Ù„ÙƒÙ…ÙŠØ©': product.quantity,
                    'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰': product.minQuantity || 5,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': product.expiryDate || '',
                    'Ø§Ù„ÙØ¦Ø©': product.categoryId ? (categories.find(c => c.id === product.categoryId)?.name || '') : '',
                    'Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬': product.image || 'ğŸ“¦'
                }));
                
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                
                // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                XLSX.writeFile(workbook, 'Ù…Ù†ØªØ¬Ø§Øª_Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.xlsx');
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
                alert('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }
        // ==================== 4.4. POS Logic ====================
        /**
        * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
        */
        async function loadCategoriesView() {
            try {
                const [categories, products] = await Promise.all([
                    loadCategories(),
                    getAllProducts()
                ]);
                
                const categoriesGrid = document.getElementById('categoriesGrid');
                if (!categoriesGrid) return;
                
                categoriesGrid.innerHTML = '';
                
                if (categories.length === 0) {
                    categoriesGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ù…Ø³Ø¬Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.
                            </div>
                        </div>
                    `;
                    return;
                }

                // Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© "Ø§Ù„ÙƒÙ„" Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­
                const allProductsCount = products.length;
                const allCategoryCard = document.createElement('div');
                allCategoryCard.className = 'col-6 col-md-4 col-lg-3 mb-3';
                allCategoryCard.innerHTML = `
                    <div class="category-card" data-category-id="all">
                        <div class="category-icon">ğŸ“¦</div>
                        <div class="category-name">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                        <div class="category-count">${allProductsCount} Ù…Ù†ØªØ¬</div>
                    </div>
                `;
                allCategoryCard.addEventListener('click', () => showProductsView('all', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª'));
                categoriesGrid.appendChild(allCategoryCard);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø§Øª Ù…Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«
                categories.forEach(category => {
                    const categoryProductsCount = products.filter(p => p.categoryId === category.id).length;
                    
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'col-6 col-md-4 col-lg-3 mb-3';
                    categoryCard.innerHTML = `
                        <div class="category-card" data-category-id="${category.id}">
                            <div class="category-icon">${category.icon || 'â­'}</div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-count">${categoryProductsCount} Ù…Ù†ØªØ¬</div>
                        </div>
                    `;
                    categoryCard.addEventListener('click', () => showProductsView(category.id, category.name));
                    categoriesGrid.appendChild(categoryCard);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª:', error);
                const categoriesGrid = document.getElementById('categoriesGrid');
                if (categoriesGrid) {
                    categoriesGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger text-center">
                                ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
                            </div>
                        </div>
                    `;
                }
            }
        }

        /**
        * Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©
        */
        async function showProductsView(categoryId, categoryName) {
            try {
                currentView = 'products';
                currentCategoryId = categoryId;
                currentCategoryName = categoryName;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('categoriesView').style.display = 'none';
                document.getElementById('productsView').style.display = 'block';
                document.getElementById('currentCategoryTitle').textContent = categoryName;
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©
                await loadProductsForCategory(categoryId);
                
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª
        */
        function showCategoriesView() {
            currentView = 'categories';
            currentCategoryId = null;
            currentCategoryName = '';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('categoriesView').style.display = 'block';
            document.getElementById('productsView').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø­Ø«
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.placeholder = 'ğŸ” Ø¨Ø­Ø« ÙÙˆØ±ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)...';
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©
        */
        async function loadProductsForCategory(categoryId) {
            try {
                const products = await getAllProducts();
                const productsGrid = document.getElementById('productsGrid');
                const productsCount = document.getElementById('productsCount');
                
                if (!productsGrid || !productsCount) return;
                
                productsGrid.innerHTML = '';
                
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                let filteredProducts = products;
                if (categoryId !== 'all') {
                    filteredProducts = products.filter(product => product.categoryId == categoryId);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                productsCount.textContent = `${filteredProducts.length} Ù…Ù†ØªØ¬`;
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.
                            </div>
                        </div>
                    `;
                    return;
                }

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                filteredProducts.forEach(product => {
                    const cartItem = currentCart.find(item => item.id === product.id);
                    const quantityInCart = cartItem ? cartItem.quantity : 0;
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'col-4 mb-3';
                    productElement.innerHTML = `
                        <div class="card product-card h-100 ${quantityInCart > 0 ? 'added' : ''}" 
                            data-product-id="${product.id}" 
                            data-product-price="${product.salePrice}" 
                            data-product-cost="${product.purchasePrice}">
                            ${quantityInCart > 0 ? `<div class="quantity-badge">${quantityInCart}</div>` : ''}
                            <div class="card-body p-2 text-center">
                                <div class="product-image mb-1">${product.image || 'ğŸ“¦'}</div>
                                <h6 class="card-title mb-0" style="font-size: 0.8rem;">${product.name}</h6>
                                <p class="card-text text-muted small mb-1">${product.code}</p>
                                <div class="d-flex justify-content-around align-items-center">
                                    <span class="fw-bold text-primary" style="font-size: 0.8rem;">${product.salePrice.toFixed(2)} Ø±.ÙŠ</span>
                                    <span class="badge ${product.quantity > (product.minQuantity || 5) ? 'bg-success' : 'bg-danger'}" style="font-size: 0.6rem;">
                                        ${product.quantity}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    
                    productsGrid.appendChild(productElement);
                });
                
            } catch(error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ¦Ø©:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <p class="alert alert-danger text-center">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</p>
                        </div>
                    `;
                }
            }
        }

        /**
        * ØªÙ‡ÙŠØ¦Ø© ÙˆØ­Ø¯Ø© Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        */
        function initializePOSModule() {
            loadCategoriesView();
            loadQuickSuggestions();
            updateCartDisplay();
            updateCartCount();
            updateFloatingCart();
            loadCustomersForPOS();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
            currentView = 'categories';
            currentCategoryId = null;
            document.getElementById('categoriesView').style.display = 'block';
            document.getElementById('productsView').style.display = 'none';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
            setupInstantSearch();
        }

        /**
        * Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
        */
        function setupInstantSearch() {
            const searchInput = document.getElementById('productSearchInput');
            const resultsContainer = document.getElementById('posSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 1) {
                    resultsContainer.style.display = 'none';
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const results = await performInstantSearch(query);
                    renderSearchResults(results, resultsContainer);
                }, 300);
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                }, 200);
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Øµ
            searchInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length > 0) {
                    performInstantSearch(query).then(results => {
                        renderSearchResults(results, resultsContainer);
                    });
                }
            });
        }
        /**
        * Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        */
        function renderSearchResults(results, container) {
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="p-3 text-center text-muted">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©
                    </div>
                `;
                container.style.display = 'block';
                return;
            }
            
            results.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item p-3 border-bottom';
                resultItem.style.cursor = 'pointer';
                
                resultItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold">${product.name}</div>
                            <div class="text-muted small">ÙƒÙˆØ¯: ${product.code}</div>
                            <div class="text-success fw-bold mt-1">${product.salePrice.toFixed(2)} Ø±.ÙŠ</div>
                        </div>
                        <div class="text-end">
                            <span class="badge ${product.quantity > 0 ? 'bg-success' : 'bg-danger'}">
                                ${product.quantity} Ù…ØªÙˆÙØ±
                            </span>
                        </div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    container.style.display = 'none';
                    document.getElementById('productSearchInput').value = '';
                });
                
                container.appendChild(resultItem);
            });
            
            container.style.display = 'block';
        }

        async function loadProductsForPOS(categoryId = null) {
            try {
                const products = await getAllProducts();
                const productsGrid = document.getElementById('productsGrid');
                if (!productsGrid) return;
                
                productsGrid.innerHTML = '';
                
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                let filteredProducts = products;
                if (categoryId && categoryId !== 'all') {
                    filteredProducts = products.filter(product => product.categoryId == categoryId);
                }
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ${categoryId ? 'ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©' : 'Ù…Ø³Ø¬Ù„Ø©'}.
                            </div>
                        </div>
                    `;
                    return;
                }

                filteredProducts.forEach(product => {
                    const cartItem = currentCart.find(item => item.id === product.id);
                    const quantityInCart = cartItem ? cartItem.quantity : 0;
                    
                    const productElement = document.createElement('div');
                    productElement.className = 'col-4 mb-3';
                    productElement.innerHTML = `
                        <div class="card product-card h-100 ${quantityInCart > 0 ? 'added' : ''}" 
                            data-product-id="${product.id}" 
                            data-product-price="${product.salePrice}" 
                            data-product-cost="${product.purchasePrice}">
                            ${quantityInCart > 0 ? `<div class="quantity-badge">${quantityInCart}</div>` : ''}
                            <div class="card-body p-2 text-center">
                                <div class="product-image mb-1">${product.image || 'ğŸ“¦'}</div>
                                <h6 class="card-title mb-0" style="font-size: 0.8rem;">${product.name}</h6>
                                <p class="card-text text-muted small mb-1">${product.code}</p>
                                <div class="d-flex justify-content-around align-items-center">
                                    <span class="fw-bold text-primary" style="font-size: 0.8rem;">${product.salePrice.toFixed(2)} Ø±.ÙŠ</span>
                                    <span class="badge ${product.quantity > (product.minQuantity || 5) ? 'bg-success' : 'bg-danger'}" style="font-size: 0.6rem;">
                                        ${product.quantity}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    productElement.addEventListener('click', () => {
                        addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    });
                    
                    productsGrid.appendChild(productElement);
                });
                
            } catch(error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
                const productsGrid = document.getElementById('productsGrid');
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger text-center">
                                ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                            </div>
                        </div>
                    `;
                }
            }
        }
        /**
        * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† - Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯
        */
        async function performInstantSearch(searchTerm) {
            try {
                const products = await getAllProducts();
                const cleanSearch = searchTerm.toLowerCase().trim();
                
                if (cleanSearch.length < 1) return [];
                
                return products.filter(product => 
                    product.name.toLowerCase().includes(cleanSearch) ||
                    product.code.toLowerCase().includes(cleanSearch) ||
                    this.simpleArabicMatch(product.name, cleanSearch)
                ).slice(0, 8); // Ø£ÙˆÙ„ 8 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
                
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ:', error);
                return [];
            }
        }

        /**
        * Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©
        */
        function simpleArabicMatch(text, search) {
            const cleanText = text
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                .replace(/[Ø©]/g, 'Ù‡')
                .replace(/[ÙŠÙ‰]/g, 'ÙŠ')
                .toLowerCase();
            
            const cleanSearch = search
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                .replace(/[Ø©]/g, 'Ù‡')
                .replace(/[ÙŠÙ‰]/g, 'ÙŠ')
                .toLowerCase();
            
            return cleanText.includes(cleanSearch);
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹
        */
        async function loadCustomersForPOS() {
            try {
                const customers = await loadCustomers();
                const select = document.getElementById('customerSelect');
                
                if (!select) return;
                
                select.innerHTML = '<option value="">Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} ${customer.phone ? `(${customer.phone})` : ''}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', error);
            }
        }

        // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡
        async function getProductById(productId) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.get(parseInt(productId));
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function updateProduct(product) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['products'], 'readwrite');
                const store = transaction.objectStore('products');
                const request = store.put(product);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

 
        /**
        * Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        */
        async function addToCart(productId, name, price, cost) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ÙƒÙ…ÙŠØ©
                const product = await getProductById(productId);
                if (!product) {
                    throw new Error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
                }
                
                const existingItem = currentCart.find(item => item.id === productId);
                const requestedQuantity = (existingItem?.quantity || 0) + 1;
                
                if (product.quantity < requestedQuantity) {
                    throw new Error(`Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©! Ø§Ù„Ù…ØªØ§Ø­: ${product.quantity}ØŒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${requestedQuantity}`);
                }
                
                if (product.quantity <= (product.minQuantity || 5)) {
                    console.warn(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ù†ØªØ¬ "${product.name}" Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯. Ø§Ù„Ù…ØªØ§Ø­: ${product.quantity}`);
                }

                // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    currentCart.push({ 
                        id: productId, 
                        name: name, 
                        price: price, 
                        purchasePrice: cost || price, 
                        quantity: 1 
                    });
                }
                
                updateCartDisplay();
                updateCartCount();
                updateFloatingCart();
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
                
                updateSalesHistory(productId);
                showNotification(name);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©:', error);
                alert(`âŒ ${error.message}`);
            }
        }
        /**
        * Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
        */
        function showNotification(productName) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            let notification = document.getElementById('temporaryNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'temporaryNotification';
                notification.className = 'toast-notification';
                document.body.appendChild(notification);
            }
            
            notification.innerHTML = `ØªÙ… Ø¥Ø¶Ø§ÙØ© <strong>${productName}</strong> Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©`;
            notification.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        /**
        * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
        */
        function checkInvoiceNumberExists(invoiceNumber) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const index = store.index('invoiceNumber');
                const request = index.get(invoiceNumber);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
         */
        function updateCartDisplay() {
            const list = document.getElementById('cartItemsList');
            const totalDisplay = document.getElementById('cartTotal');
            const cartCounter = document.getElementById('cartCounter');
            const subtotalDisplay = document.getElementById('cartSubtotal');
            const discountDisplay = document.getElementById('cartDiscount');
            const taxDisplay = document.getElementById('cartTax');
            
            if (!list || !totalDisplay) return;
            
            let subtotal = 0;
            list.innerHTML = '';

            if (currentCart.length === 0) {
                list.innerHTML = '<p class="text-center text-muted mt-5">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                if (cartCounter) {
                    cartCounter.textContent = '0';
                    cartCounter.style.display = 'none';
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                if (subtotalDisplay) subtotalDisplay.textContent = '0.00 Ø±.ÙŠ';
                if (discountDisplay) discountDisplay.textContent = '0.00 Ø±.ÙŠ';
                if (taxDisplay) taxDisplay.textContent = '0.00 Ø±.ÙŠ';
                if (totalDisplay) totalDisplay.textContent = '0.00 Ø±.ÙŠ';
                
            } else {
                currentCart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
                    itemElement.innerHTML = `
                        <div class="flex-grow-1">
                            <div class="fw-bold">${item.name}</div>
                            <small class="text-muted">${item.quantity} x ${item.price.toFixed(2)} Ø±.ÙŠ</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fw-bold text-primary me-2">${itemTotal.toFixed(2)} Ø±.ÙŠ</span>
                            <button class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(itemElement);
                });
                
                if (cartCounter) {
                    const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
                    cartCounter.textContent = totalItems.toString();
                    cartCounter.style.display = totalItems > 0 ? 'flex' : 'none';
                }
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©
                const discountType = document.getElementById('discountType').value;
                const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
                const applyTax = document.getElementById('applyTaxCheckbox').checked;
                const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;
                
                const discountAmount = discountType === 'percentage' ? (subtotal * discountValue / 100) : discountValue;
                const afterDiscount = Math.max(0, subtotal - discountAmount);
                const taxAmount = applyTax ? (afterDiscount * taxRate / 100) : 0;
                const total = afterDiscount + taxAmount;
                
                // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶
                if (subtotalDisplay) subtotalDisplay.textContent = `${subtotal.toFixed(2)} Ø±.ÙŠ`;
                if (discountDisplay) discountDisplay.textContent = `-${discountAmount.toFixed(2)} Ø±.ÙŠ`;
                if (taxDisplay) taxDisplay.textContent = `${taxAmount.toFixed(2)} Ø±.ÙŠ`;
                if (totalDisplay) totalDisplay.textContent = `${total.toFixed(2)} Ø±.ÙŠ`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
            updateFloatingCart();
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© (Ø¹Ù„Ù‰ Ø²Ø± FAB)
         */
        function updateCartCount() {
            const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCounter = document.getElementById('cartCounter');
            if (cartCounter) {
                cartCounter.textContent = totalItems.toString();
                cartCounter.style.display = totalItems > 0 ? 'flex' : 'none';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            updateProductBadges();
        }

        function updateProductBadges() {
            document.querySelectorAll('.product-card').forEach(card => {
                const productId = parseInt(card.dataset.productId);
                const cartItem = currentCart.find(item => item.id === productId);
                const quantityInCart = cartItem ? cartItem.quantity : 0;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const existingBadge = card.querySelector('.quantity-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† 0
                if (quantityInCart > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'quantity-badge';
                    badge.textContent = quantityInCart;
                    card.appendChild(badge);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                if (quantityInCart > 0) {
                    card.classList.add('added');
                } else {
                    card.classList.remove('added');
                }
            });
        }
        /**
         * ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
         */
        function updateSalesHistory(productId) {
            try {
                const existingSale = salesHistory.find(sale => sale.productId === productId);
                
                if (existingSale) {
                    existingSale.lastSold = new Date().toISOString();
                    existingSale.saleCount += 1;
                } else {
                    salesHistory.push({
                        productId: productId,
                        lastSold: new Date().toISOString(),
                        saleCount: 1
                    });
                }
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                localStorage.setItem('pos_sales', JSON.stringify(salesHistory));
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
                loadQuickSuggestions();
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', error);
            }
        }
                    
 
        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
         */
        async function loadQuickSuggestions() {
            try {
                const products = await getAllProducts();
                const container = document.getElementById('quickSuggestions');
                if (!container) return;
                
                container.innerHTML = '';
                if (products.length === 0) return;

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
                const sortedProducts = products
                    .map(product => {
                        const saleData = salesHistory.find(sale => sale.productId === product.id) || {
                            lastSold: new Date(0).toISOString(),
                            saleCount: 0
                        };
                        return {
                            ...product,
                            lastSold: saleData.lastSold,
                            saleCount: saleData.saleCount
                        };
                    })
                    .sort((a, b) => {
                        // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø£Ø­Ø¯Ø« Ø¨ÙŠØ¹Ø§Ù‹
                        if (new Date(b.lastSold) - new Date(a.lastSold) !== 0) {
                            return new Date(b.lastSold) - new Date(a.lastSold);
                        }
                        // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹
                        return b.saleCount - a.saleCount;
                    })
                    .slice(0, 7); // Ø£ÙˆÙ„ 7 Ù…Ù†ØªØ¬Ø§Øª

                sortedProducts.forEach(product => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    suggestion.innerHTML = `
                        <div class="suggestion-emoji">${product.image || 'ğŸ“¦'}</div>
                        <div class="suggestion-name">${product.name}</div>
                    `;
                    suggestion.addEventListener('click', () => {
                        addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                        showNotification(product.name);
                    });
                    container.appendChild(suggestion);
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©:', error);
            }
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
         */
        function updateFloatingCart() {
            const floatingCart = document.getElementById('floatingCartBtn');
            const floatingTotal = document.getElementById('floatingCartTotal');
            
            if (!floatingCart || !floatingTotal) return;
            
            if (currentCart.length === 0) {
                floatingCart.style.display = 'none';
            } else {
                floatingCart.style.display = 'flex';
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                let subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©
                const discountType = document.getElementById('discountType')?.value || 'fixed';
                const discountValue = parseFloat(document.getElementById('discountInput')?.value) || 0;
                const taxType = document.getElementById('taxType')?.value || 'fixed';
                const taxValue = parseFloat(document.getElementById('taxInput')?.value) || 0;

                const discountAmount = discountType === 'percentage' ? (subtotal * discountValue / 100) : discountValue;
                const taxedSubtotal = subtotal - discountAmount;
                const taxAmount = taxType === 'percentage' ? (taxedSubtotal * taxValue / 100) : taxValue;
                
                const total = taxedSubtotal + taxAmount;
                floatingTotal.textContent = `${total.toFixed(2)} Ø±.ÙŠ`;
                
                // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„ÙØªØ­ Ø§Ù„Ø³Ù„Ø©
                floatingCart.onclick = function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                };
            }
        }



        /**
        * Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØµØ­Ø­
        */
        async function saveInvoice() {
            if (currentCart.length === 0) {
                alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©! Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.');
                return;
            }
            
            try {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹
                await validateCartStock();
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const discountType = document.getElementById('discountType').value;
                const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
                const applyTax = document.getElementById('applyTaxCheckbox').checked;
                const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;
                const paymentMethod = document.getElementById('paymentMethodSelect').value;
                const customerId = document.getElementById('customerSelect').value;
                
                const discountAmount = discountType === 'percentage' ? (subtotal * discountValue / 100) : discountValue;
                const afterDiscount = Math.max(0, subtotal - discountAmount);
                const taxAmount = applyTax ? (afterDiscount * taxRate / 100) : 0;
                const total = afterDiscount + taxAmount;
                
                console.log('ğŸ§® Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', { 
                    subtotal, 
                    discountAmount, 
                    afterDiscount, 
                    taxAmount, 
                    total,
                    customerId,
                    paymentMethod
                });

                // Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©
                let costOfGoods = 0;
                const productUpdates = [];
                
                for (const item of currentCart) {
                    const product = await getProductById(item.id);
                    if (product) {
                        const itemCost = (product.purchasePrice || 0) * item.quantity;
                        costOfGoods += itemCost;
                        
                        // ØªØ­Ø¶ÙŠØ± ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                        productUpdates.push({
                            product: product,
                            newQuantity: product.quantity - item.quantity,
                            itemName: product.name
                        });
                        
                        console.log(`ğŸ“¦ Ù…Ù†ØªØ¬: ${product.name}, Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}, Ø§Ù„ØªÙƒÙ„ÙØ©: ${itemCost}`);
                    }
                }

                console.log(`ğŸ’° ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: ${costOfGoods}`);

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ­Ø³Ø§Ø¨Ù‡
                let customerAccountCode = '1040000'; // Ø¹Ù…Ù„Ø§Ø¡ Ù†Ù‚Ø¯ÙŠÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
                let customerName = 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ';
                
                if (customerId) {
                    try {
                        const customer = await getCustomerById(parseInt(customerId));
                        if (customer && customer.accCode) {
                            customerAccountCode = customer.accCode;
                            customerName = customer.name;
                            console.log(`âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙØ±Ø¯ÙŠ: ${customerAccountCode} - ${customerName}`);
                        }
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:', error);
                    }
                }

                // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ÙØ±ÙŠØ¯
                let invoiceNumber = `INV-${invoiceCounter}`;
                let isInvoiceNumberUnique = false;
                let attempts = 0;
                
                while (!isInvoiceNumberUnique && attempts < 10) {
                    const existingInvoice = await checkInvoiceNumberExists(invoiceNumber);
                    if (!existingInvoice) {
                        isInvoiceNumberUnique = true;
                    } else {
                        invoiceCounter++;
                        invoiceNumber = `INV-${invoiceCounter}`;
                        attempts++;
                    }
                }

                const invoice = {
                    invoiceNumber: invoiceNumber,
                    date: new Date().toISOString(),
                    customerId: customerId || null,
                    customerName: customerName,
                    customerAccount: customerAccountCode,
                    paymentMethod: paymentMethod,
                    items: JSON.parse(JSON.stringify(currentCart)),
                    subtotal: subtotal,
                    discount: discountAmount,
                    tax: taxAmount,
                    total: total,
                    status: 'completed',
                    costOfGoods: costOfGoods,
                    taxRate: applyTax ? taxRate : 0,
                    createdAt: new Date().toISOString()
                };

                console.log('ğŸ§¾ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', invoice);

                // ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
                await executeInvoiceTransaction(invoice, productUpdates, customerId);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                currentCart = [];
                updateCartDisplay();
                updateCartCount();
                updateFloatingCart();
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                const posCart = document.getElementById('posCart');
                if (posCart) {
                    posCart.classList.remove('show');
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
                
                updateBalance();
                displayChartOfAccounts();
                
                // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø¬Ø§Ø­
                showSuccessModal(invoice);
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯!');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', error);
                alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${error.message}`);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                updateCartDisplay();
                updateCartCount();
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
                updateBalance();
                // ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                displayChartOfAccounts();

            }
        }

        /**
        * ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
        */
        function executeInvoiceTransaction(invoice, productUpdates, customerId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([
                    'invoices', 
                    'products', 
                    'customers',
                    'cashTransactions',
                    'journalEntries',
                    'chartOfAccounts'
                ], 'readwrite');
                
                transaction.onerror = (e) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:', e.target.error);
                    reject(new Error(`ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.target.error}`));
                };
                
                transaction.oncomplete = () => {
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    resolve();
                };
                
                const invoiceStore = transaction.objectStore('invoices');
                const productsStore = transaction.objectStore('products');
                const customersStore = transaction.objectStore('customers');
                const cashStore = transaction.objectStore('cashTransactions');
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                // 1. ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
                for (const update of productUpdates) {
                    update.product.quantity = update.newQuantity;
                    update.product.lastSold = new Date().toISOString();
                    const putRequest = productsStore.put(update.product);
                    putRequest.onerror = (e) => {
                        console.error(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ${update.itemName}:`, e.target.error);
                    };
                }
                
                // 2. Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                console.log('ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©...');
                const invoiceRequest = invoiceStore.add(invoice);
                
                invoiceRequest.onsuccess = (e) => {
                    const invoiceId = e.target.result;
                    invoiceCounter++;
                    console.log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø±Ù‚Ù…: ${invoiceId}`);
                    
                    // 3. ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§ØªÙˆØ±Ø© Ø¢Ø¬Ù„Ø©
                    if (invoice.paymentMethod === 'credit' && customerId) {
                        console.log('ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„...');
                        const customerRequest = customersStore.get(parseInt(customerId));
                        
                        customerRequest.onsuccess = (e) => {
                            const customer = e.target.result;
                            if (customer) {
                                customer.balance = (customer.balance || 0) + invoice.total;
                                customer.lastTransaction = new Date().toISOString();
                                const updateRequest = customersStore.put(customer);
                                updateRequest.onsuccess = () => {
                                    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.balance}`);
                                };
                                updateRequest.onerror = (e) => {
                                    console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:', e.target.error);
                                };
                            }
                        };
                        
                        customerRequest.onerror = (e) => {
                            console.error('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:', e.target.error);
                        };
                    }
                    
                    // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù…Ø¹ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ÙØ±Ø¯ÙŠØ©
                    console.log('ğŸ“’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©...');
                    recordAccountingEntriesInTransaction(invoice, invoiceId, transaction)
                        .then(() => {
                            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©');
                            
                            // 5. ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ù‚Ø¯ÙŠØ©
                            if (invoice.paymentMethod === 'cash') {
                                console.log('ğŸ’µ ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚...');
                                const cashTransaction = {
                                    date: new Date().toISOString(),
                                    type: 'Sale',
                                    amount: invoice.total,
                                    reference: `ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª ${invoice.invoiceNumber}`,
                                    invoiceId: invoiceId,
                                    customerId: customerId || null,
                                    customerName: invoice.customerName
                                };
                                const cashRequest = cashStore.add(cashTransaction);
                                cashRequest.onsuccess = () => {
                                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚');
                                };
                                cashRequest.onerror = (e) => {
                                    console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:', e.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©:', error);
                            reject(error);
                        });
                };
                
                invoiceRequest.onerror = (e) => {
                    reject(new Error(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${e.target.error}`));
                };
            });
        }

        /**
        * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
        */
        async function recordAccountingEntriesInTransaction(invoice, invoiceId, transaction) {
            return new Promise((resolve, reject) => {
                console.log('ğŸ¯ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø¨ÙŠØ¹...');
                
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                const customerAccountCode = invoice.customerAccount || '1040000';
                
                console.log('ğŸ” Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„:', customerAccountCode);
                
                // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø¨ÙŠØ¹
                const revenueDebits = [];
                const revenueCredits = [];
                
                if (invoice.paymentMethod === 'cash') {
                    // ğŸ”¥ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ: Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø§Ø¦Ù†)
                    revenueDebits.push({ 
                        accountCode: '1010', // Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                        amount: invoice.total,
                        description: `Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª Ø¨ÙŠØ¹ Ù†Ù‚Ø¯ÙŠ - ${invoice.customerName}`
                    });
                } else {
                    // ğŸ”¥ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„: Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø§Ø¦Ù†)
                    revenueDebits.push({ 
                        accountCode: customerAccountCode, // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
                        amount: invoice.total,
                        description: `Ø°Ù…Ù… Ø¹Ù…Ù„Ø§Ø¡ - ${invoice.customerName}`
                    });
                }
                
                // Ø§Ù„Ø¯Ø§Ø¦Ù†: Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                revenueCredits.push({ 
                    accountCode: '3010', // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    amount: invoice.subtotal,
                    description: 'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª'
                });
                
                // Ø§Ù„Ø¯Ø§Ø¦Ù†: Ø§Ù„Ø®ØµÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                if (invoice.discount > 0) {
                    revenueDebits.push({
                        accountCode: '3040', // Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡
                        amount: invoice.discount,
                        description: 'Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª'
                    });
                }
                
                // Ø§Ù„Ø¯Ø§Ø¦Ù†: Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
                if (invoice.tax > 0) {
                    revenueCredits.push({ 
                        accountCode: '2030', // Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
                        amount: invoice.tax,
                        description: 'Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø³ØªØ­Ù‚Ø©'
                    });
                }
                
                console.log('ğŸ“’ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„:');
                console.log('Ø§Ù„Ù…Ø¯ÙŠÙ†:', revenueDebits);
                console.log('Ø§Ù„Ø¯Ø§Ø¦Ù†:', revenueCredits);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø²Ù†
                const totalDebit = revenueDebits.reduce((sum, d) => sum + d.amount, 0);
                const totalCredit = revenueCredits.reduce((sum, c) => sum + c.amount, 0);
                const difference = Math.abs(totalDebit - totalCredit);
                
                console.log('âš–ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø²Ù†:', {
                    'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ†': totalDebit,
                    'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†': totalCredit,
                    'Ø§Ù„ÙØ±Ù‚': difference
                });
                
                if (difference > 0.01) {
                    const error = new Error(`Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†! Ø§Ù„Ù…Ø¯ÙŠÙ†: ${totalDebit}, Ø§Ù„Ø¯Ø§Ø¦Ù†: ${totalCredit}`);
                    console.error('âŒ', error.message);
                    reject(error);
                    return;
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
                const revenueEntry = {
                    date: new Date().toISOString(),
                    description: `ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª ${invoice.invoiceNumber} - ${invoice.paymentMethod === 'credit' ? 'Ø¢Ø¬Ù„' : 'Ù†Ù‚Ø¯ÙŠ'} - ${invoice.customerName}`,
                    debits: revenueDebits,
                    credits: revenueCredits,
                    refType: 'Sale',
                    refId: invoiceId,
                    balanced: true,
                    totalAmount: invoice.total,
                    createdAt: new Date().toISOString()
                };
                
                console.log('ğŸ’¾ Ø­ÙØ¸ Ù‚ÙŠØ¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:', revenueEntry);
                
                const revenueRequest = journalStore.add(revenueEntry);
                
                revenueRequest.onsuccess = () => {
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
                    updateAccountBalances(revenueDebits, revenueCredits, coaStore)
                        .then(() => {
                            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª');
                            
                            // Ù‚ÙŠØ¯ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                            if (invoice.costOfGoods > 0) {
                                console.log('ğŸ“¦ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©...');
                                
                                const costEntry = {
                                    date: new Date().toISOString(),
                                    description: `ØªÙƒÙ„ÙØ© Ø¨Ø¶Ø§Ø¹Ø© Ù…Ø¨Ø§Ø¹Ø© - ÙØ§ØªÙˆØ±Ø© ${invoice.invoiceNumber}`,
                                    debits: [{ 
                                        accountCode: '3020', // ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©
                                        amount: invoice.costOfGoods,
                                        description: 'ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©'
                                    }],
                                    credits: [{ 
                                        accountCode: '1030', // Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                                        amount: invoice.costOfGoods,
                                        description: 'ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'
                                    }],
                                    refType: 'COGS',
                                    refId: invoiceId,
                                    balanced: true,
                                    totalAmount: invoice.costOfGoods,
                                    createdAt: new Date().toISOString()
                                };
                                
                                const costRequest = journalStore.add(costEntry);
                                
                                costRequest.onsuccess = () => {
                                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙƒÙ„ÙØ©');
                                    
                                    updateAccountBalances(
                                        [{ accountCode: '3020', amount: invoice.costOfGoods }],
                                        [{ accountCode: '1030', amount: invoice.costOfGoods }],
                                        coaStore
                                    ).then(() => {
                                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙƒÙ„ÙØ©');
                                        resolve();
                                    }).catch(reject);
                                };
                                
                                costRequest.onerror = (e) => {
                                    reject(new Error(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙƒÙ„ÙØ©: ${e.target.error}`));
                                };
                            } else {
                                resolve();
                            }
                        })
                        .catch(reject);
                };
                
                revenueRequest.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:', e.target.error);
                    reject(new Error(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${e.target.error}`));
                };
            });
        }

        async function getCustomerById(customerId) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.get(parseInt(customerId));
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        */
        function updateAccountBalances(debits, credits, coaStore) {
            return new Promise((resolve, reject) => {
                let completed = 0;
                const totalOperations = debits.length + credits.length;
                
                if (totalOperations === 0) {
                    resolve();
                    return;
                }

                const checkCompletion = () => {
                    completed++;
                    if (completed === totalOperations) {
                        resolve();
                    }
                };

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                debits.forEach(debitEntry => {
                    const accountRequest = coaStore.get(debitEntry.accountCode);
                    accountRequest.onsuccess = (e) => {
                        const account = e.target.result;
                        if (account) {
                            account.balance = (account.balance || 0) + debitEntry.amount;
                            account.lastUpdated = new Date().toISOString();
                            account.lastTransaction = debitEntry.description || 'Ø¹Ù…Ù„ÙŠØ© Ù…Ø¯ÙŠÙ†Ø©';
                            
                            const putRequest = coaStore.put(account);
                            putRequest.onsuccess = checkCompletion;
                            putRequest.onerror = (e) => {
                                console.error(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ† ${debitEntry.accountCode}:`, e.target.error);
                                checkCompletion();
                            };
                        } else {
                            console.error(`âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${debitEntry.accountCode}`);
                            checkCompletion();
                        }
                    };
                    accountRequest.onerror = (e) => {
                        console.error(`âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ† ${debitEntry.accountCode}:`, e.target.error);
                        checkCompletion();
                    };
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©
                credits.forEach(creditEntry => {
                    const accountRequest = coaStore.get(creditEntry.accountCode);
                    accountRequest.onsuccess = (e) => {
                        const account = e.target.result;
                        if (account) {
                            account.balance = (account.balance || 0) - creditEntry.amount;
                            account.lastUpdated = new Date().toISOString();
                            account.lastTransaction = creditEntry.description || 'Ø¹Ù…Ù„ÙŠØ© Ø¯Ø§Ø¦Ù†Ø©';
                            
                            const putRequest = coaStore.put(account);
                            putRequest.onsuccess = checkCompletion;
                            putRequest.onerror = (e) => {
                                console.error(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ù† ${creditEntry.accountCode}:`, e.target.error);
                                checkCompletion();
                            };
                        } else {
                            console.error(`âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${creditEntry.accountCode}`);
                            checkCompletion();
                        }
                    };
                    accountRequest.onerror = (e) => {
                        console.error(`âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ù† ${creditEntry.accountCode}:`, e.target.error);
                        checkCompletion();
                    };
                });
            });
        }
        /**
        * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
        */
        async function validateCartStock() {
            const stockErrors = [];
            
            for (const item of currentCart) {
                const product = await getProductById(item.id);
                if (!product) {
                    stockErrors.push(`Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${item.name}`);
                } else if (product.quantity < item.quantity) {
                    stockErrors.push(`Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬: ${product.name}. Ø§Ù„Ù…ØªØ§Ø­: ${product.quantity}ØŒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${item.quantity}`);
                }
            }
            
            if (stockErrors.length > 0) {
                throw new Error(stockErrors.join('\n'));
            }
        }


        /**
        * Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
        */
        function printInvoice() {
            if (currentCart.length === 0) {
                alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
                return;
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            let subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
            const applyTax = document.getElementById('applyTaxCheckbox').checked;
            const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;

            const discountAmount = discountType === 'percentage' ? (subtotal * discountValue / 100) : discountValue;
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const taxAmount = applyTax ? (afterDiscount * taxRate / 100) : 0;
            const total = afterDiscount + taxAmount;

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            const customerSelect = document.getElementById('customerSelect');
            const customerId = customerSelect ? customerSelect.value : '';
            const customerName = customerSelect ? customerSelect.options[customerSelect.selectedIndex].text : 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ';

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            color: #000;
                            direction: rtl;
                        }
                        .invoice-header { 
                            text-align: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .invoice-header h2 { 
                            margin: 0; 
                            color: #333; 
                            font-size: 24px;
                        }
                        .invoice-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            font-size: 14px;
                        }
                        .invoice-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 20px;
                        }
                        .invoice-table th, 
                        .invoice-table td { 
                            padding: 8px; 
                            border: 1px solid #ddd; 
                            text-align: center;
                        }
                        .invoice-table th { 
                            background-color: #f8f9fa; 
                            font-weight: bold;
                        }
                        .invoice-totals {
                            margin-top: 20px;
                            border-top: 2px solid #333;
                            padding-top: 10px;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 5px 0;
                        }
                        .final-total {
                            font-size: 18px;
                            font-weight: bold;
                            color: #28a745;
                            border-top: 1px solid #333;
                            padding-top: 10px;
                        }
                        .footer { 
                            margin-top: 30px; 
                            text-align: center; 
                            color: #666;
                            font-size: 12px;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-header">
                        <h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</p>
                    </div>
                    
                    <div class="invoice-info">
                        <div>
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-YE')}
                        </div>
                        <div>
                            <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date().toLocaleTimeString('ar-YE')}
                        </div>
                    </div>
                    
                    <div class="invoice-info">
                        <div>
                            <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customerName}
                        </div>
                        <div>
                            <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${document.getElementById('paymentMethodSelect').value === 'credit' ? 'Ø¢Ø¬Ù„' : 'Ù†Ù‚Ø¯ÙŠ'}
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentCart.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} Ø±.ÙŠ</td>
                                    <td>${(item.price * item.quantity).toFixed(2)} Ø±.ÙŠ</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="invoice-totals">
                        <div class="total-row">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                            <span>${subtotal.toFixed(2)} Ø±.ÙŠ</span>
                        </div>
                        ${discountAmount > 0 ? `
                        <div class="total-row">
                            <span>Ø§Ù„Ø®ØµÙ…:</span>
                            <span>-${discountAmount.toFixed(2)} Ø±.ÙŠ</span>
                        </div>
                        ` : ''}
                        ${taxAmount > 0 ? `
                        <div class="total-row">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                            <span>${taxAmount.toFixed(2)} Ø±.ÙŠ</span>
                        </div>
                        ` : ''}
                        <div class="total-row final-total">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span>${total.toFixed(2)} Ø±.ÙŠ</span>
                        </div>
                    </div>

                    <div class="footer">
                        <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
                        <p>Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: ${new Date().getFullYear()} Â© Ù†Ø¸Ø§Ù… ERP</p>
                    </div>
                </body>
                </html>
            `;

            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            setTimeout(() => {
                printWindow.print();
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            }, 500);
        }

        /**
        * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        */
        function createWhatsappPreview() {
            if (currentCart.length === 0) {
                alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('whatsappPreviewModal'));
            const preview = document.getElementById('whatsappMessagePreview');

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
            const applyTax = document.getElementById('applyTaxCheckbox').checked;
            const taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;

            const discountAmount = discountType === 'percentage' ? (subtotal * discountValue / 100) : discountValue;
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const taxAmount = applyTax ? (afterDiscount * taxRate / 100) : 0;
            const total = afterDiscount + taxAmount;

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            const customerSelect = document.getElementById('customerSelect');
            const customerName = customerSelect ? customerSelect.options[customerSelect.selectedIndex].text : 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ';
            const paymentMethod = document.getElementById('paymentMethodSelect').value;

            // Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø³Ù‚
            let message = `ğŸ›’ *ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª* ğŸ§¾\n\n`;
            message += `ğŸ“… *Ø§Ù„ØªØ§Ø±ÙŠØ®:* ${new Date().toLocaleDateString('ar-YE')}\n`;
            message += `â° *Ø§Ù„ÙˆÙ‚Øª:* ${new Date().toLocaleTimeString('ar-YE')}\n`;
            message += `ğŸ‘¤ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${customerName}\n`;
            message += `ğŸ’³ *Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:* ${paymentMethod === 'credit' ? 'Ø¢Ø¬Ù„' : 'Ù†Ù‚Ø¯ÙŠ'}\n\n`;
            
            message += `ğŸ“‹ *ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:*\n`;
            message += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
            
            currentCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                message += `â”‚ ${index + 1}. ${item.name}\n`;
                message += `â”‚    ${item.quantity} Ã— ${item.price.toFixed(2)} = ${itemTotal.toFixed(2)} Ø±.ÙŠ\n`;
            });
            
            message += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n`;
            
            message += `ğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª:*\n`;
            message += `â”œ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${subtotal.toFixed(2)} Ø±.ÙŠ\n`;
            
            if (discountAmount > 0) {
                message += `â”œ Ø§Ù„Ø®ØµÙ…: ${discountAmount.toFixed(2)} Ø±.ÙŠ\n`;
            }
            
            if (taxAmount > 0) {
                message += `â”œ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${taxAmount.toFixed(2)} Ø±.ÙŠ\n`;
            }
            
            message += `â”” *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${total.toFixed(2)} Ø±.ÙŠ*\n\n`;
            
            message += `ğŸ‰ *Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§!*\n`;
            message += `ğŸ“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: Ù†Ø¸Ø§Ù… ERP ${new Date().getFullYear()}`;

            preview.textContent = message;

            // Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø²Ø±
            const openWhatsappBtn = document.getElementById('openWhatsappBtn');
            openWhatsappBtn.onclick = () => {
                window.open(whatsappUrl, '_blank');
                modal.hide();
            };

            modal.show();
        }

        /**
         * Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­
         */
        function showSuccessModal(invoiceData) {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            document.getElementById('invoiceNumberDisplay').textContent = invoiceData.invoiceNumber || 'INV-' + invoiceCounter;
            
            const paymentMethod = invoiceData.paymentMethod === 'credit' ? 'Ø¢Ø¬Ù„' : 
                                invoiceData.paymentMethod === 'card' ? 'Ø¨Ø·Ø§Ù‚Ø©' : 'Ù†Ù‚Ø¯ÙŠ';
            document.getElementById('paymentMethodDisplay').textContent = paymentMethod;
            
            document.getElementById('finalTotalDisplay').textContent = `${invoiceData.total.toFixed(2)} Ø±.ÙŠ`;
            
            // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            const grossProfit = invoiceData.items.reduce((sum, item) => {
                const itemCost = (item.purchasePrice || 0) * item.quantity;
                const itemRevenue = item.price * item.quantity;
                return sum + (itemRevenue - itemCost);
            }, 0);
            
            document.getElementById('grossProfitDisplay').textContent = `${grossProfit.toFixed(2)} Ø±.ÙŠ`;
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            document.getElementById('printReceiptBtn').onclick = function() {
                printInvoiceFromSuccess(invoiceData);
            };
            
            modal.show();
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø¬Ø§Ø­
        function printInvoiceFromSuccess(invoiceData) {
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ø¥ÙŠØµØ§Ù„ Ø¨ÙŠØ¹ - ${invoiceData.invoiceNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .invoice-info { margin-bottom: 15px; }
                        .table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                        .table th, .table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                        .totals { margin-top: 20px; font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Ø¥ÙŠØµØ§Ù„ Ø¨ÙŠØ¹</h2>
                        <p>${invoiceData.invoiceNumber}</p>
                    </div>
                    
                    <div class="invoice-info">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-YE')}</div>
                        <div><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date().toLocaleTimeString('ar-YE')}</div>
                        <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${invoiceData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ'}</div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceData.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} Ø±.ÙŠ</td>
                                    <td>${(item.price * item.quantity).toFixed(2)} Ø±.ÙŠ</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="totals">
                        <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${invoiceData.subtotal.toFixed(2)} Ø±.ÙŠ</div>
                        ${invoiceData.discount > 0 ? `<div>Ø§Ù„Ø®ØµÙ…: ${invoiceData.discount.toFixed(2)} Ø±.ÙŠ</div>` : ''}
                        ${invoiceData.tax > 0 ? `<div>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${invoiceData.tax.toFixed(2)} Ø±.ÙŠ</div>` : ''}
                        <div style="font-size: 1.2em; color: #28a745;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${invoiceData.total.toFixed(2)} Ø±.ÙŠ</div>
                    </div>

                    <div class="footer">
                        <p>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            }, 500);
        }
        // ==================== 4.5. Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© - Ø¹Ø±Ø¶ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ====================
        async function displayChartOfAccounts() {
            try {
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const accounts = request.result;
                    const coaList = document.getElementById('coaList');
                    if (!coaList) return;
                    
                    coaList.innerHTML = '';
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù„Ù‰ Ù‡ÙŠÙƒÙ„ Ø´Ø¬Ø±Ø©
                    const tree = {};
                    accounts.forEach(acc => {
                        acc.children = [];
                        tree[acc.code] = acc;
                    });

                    accounts.forEach(acc => {
                        if (acc.parentCode && tree[acc.parentCode]) {
                            tree[acc.parentCode].children.push(acc);
                        }
                    });

                    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯Ø© ÙÙŠ HTML
                    function renderAccount(account, level = 0) {
                        const li = document.createElement('li');
                        li.className = `list-group-item d-flex justify-content-between align-items-center ${account.type === 'header' ? 'fw-bold bg-light' : ''}`;
                        li.style.paddingRight = `${10 + level * 20}px`;

                        li.innerHTML = `
                            <span>${account.code} - ${account.name}</span>
                            <span>${account.balance !== undefined ? account.balance.toFixed(2) + ' Ø±.ÙŠ' : ''}</span>
                        `;
                        
                        coaList.appendChild(li);

                        account.children.forEach(child => renderAccount(child, level + 1));
                    }

                    // Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ ÙˆØ§Ù„Ø¯ Ø£Ùˆ ÙˆØ§Ù„Ø¯Ù‡Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
                    Object.values(tree).filter(acc => !acc.parentCode || !tree[acc.parentCode]).forEach(acc => renderAccount(acc));
                };
            } catch (error) {
                console.error('ÙØ´Ù„ Ø¹Ø±Ø¶ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', error);
            }
        }

 
        /**
        * Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        */
        function getAllInvoices() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['invoices'], 'readonly');
                const store = transaction.objectStore('invoices');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
        */
        function getAllCashTransactions() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['cashTransactions'], 'readonly');
                const store = transaction.objectStore('cashTransactions');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }


        // ==================== 4.8. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ====================
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
        */
        function openPurchaseModal() {
            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
            const supplierSelect = document.getElementById('purchaseSupplier');
            supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
            suppliers.forEach(supplier => {
                supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            loadProductsForPurchase();
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseTotal').value = '0';
            
            modal.show();
        }



        /**
        * Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
        */
        async function savePurchaseInvoice() {
            const form = document.getElementById('purchaseForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const purchaseItems = [];
            let isValid = true;

            // Ø¬Ù…Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
            document.querySelectorAll('.purchase-item').forEach(item => {
                const productSelect = item.querySelector('.product-select');
                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('.price-input');
                
                if (productSelect.value && quantityInput.value && priceInput.value) {
                    const quantity = parseInt(quantityInput.value);
                    const price = parseFloat(priceInput.value);
                    
                    if (quantity <= 0 || price <= 0) {
                        isValid = false;
                        alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
                        return;
                    }
                    
                    purchaseItems.push({
                        productId: parseInt(productSelect.value),
                        productName: productSelect.options[productSelect.selectedIndex].text,
                        quantity: quantity,
                        price: price,
                        total: quantity * price
                    });
                } else {
                    isValid = false;
                }
            });

            if (!isValid || purchaseItems.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ­Ø³Ø§Ø¨Ù‡
            const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
            let supplierAccountCode = '2010000'; // Ù…ÙˆØ±Ø¯ÙŠÙ† Ù†Ù‚Ø¯ÙŠÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
            let supplierName = 'Ù…ÙˆØ±Ø¯ Ù†Ù‚Ø¯ÙŠ';
            
            if (supplierId) {
                try {
                    const supplier = await getSupplierById(supplierId);
                    if (supplier && supplier.accCode) {
                        supplierAccountCode = supplier.accCode;
                        supplierName = supplier.name;
                        console.log(`âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„ÙØ±Ø¯ÙŠ: ${supplierAccountCode} - ${supplierName}`);
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯:', error);
                }
            }

            const purchaseInvoice = {
                supplierId: supplierId,
                supplierName: supplierName,
                supplierAccount: supplierAccountCode,
                date: document.getElementById('purchaseDate').value,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                invoiceNumber: document.getElementById('purchaseInvoiceNumber').value || `PUR-${Date.now()}`,
                items: purchaseItems,
                total: parseFloat(document.getElementById('purchaseTotal').value),
                notes: document.getElementById('purchaseNotes').value,
                createdAt: new Date().toISOString(),
                status: 'completed'
            };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const calculatedTotal = purchaseItems.reduce((sum, item) => sum + item.total, 0);
            if (Math.abs(purchaseInvoice.total - calculatedTotal) > 0.01) {
                alert('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù');
                return;
            }

            try {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
                
                // ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
                await executePurchaseTransaction(purchaseInvoice, purchaseItems);
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
                modal.hide();
                
                // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                updateBalance();
                displayChartOfAccounts();
                loadProductsTable();
                loadProductsForPOS();
                loadPurchasesTable();
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!');

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
                alert(`âŒ ÙØ´Ù„ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡: ${error.message}`);
            }
        }

        /**
        * Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±Ù
        */
        async function getSupplierById(supplierId) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readonly');
                const store = transaction.objectStore('suppliers');
                const request = store.get(parseInt(supplierId));
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
        */
        function executePurchaseTransaction(purchase, purchaseItems) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([
                    'purchaseInvoices', 
                    'products', 
                    'suppliers',
                    'cashTransactions',
                    'journalEntries',
                    'chartOfAccounts'
                ], 'readwrite');
                
                transaction.onerror = (e) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡:', e.target.error);
                    reject(new Error(`ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.target.error}`));
                };
                
                transaction.oncomplete = () => {
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
                    resolve();
                };
                
                const purchaseStore = transaction.objectStore('purchaseInvoices');
                const productsStore = transaction.objectStore('products');
                const suppliersStore = transaction.objectStore('suppliers');
                const cashStore = transaction.objectStore('cashTransactions');
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');

                // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
                const productUpdatePromises = [];
                
                for (const item of purchaseItems) {
                    const productRequest = productsStore.get(item.productId);
                    
                    productRequest.onsuccess = (e) => {
                        const product = e.target.result;
                        if (product) {
                            // âœ… Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø±Ø¬Ø­ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                            const currentTotalValue = product.purchasePrice * product.quantity;
                            const newTotalValue = item.price * item.quantity;
                            const totalValue = currentTotalValue + newTotalValue;
                            const totalQuantity = product.quantity + item.quantity;
                            
                            if (totalQuantity > 0) {
                                product.purchasePrice = totalValue / totalQuantity; // Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ØµØ­ÙŠØ­
                            } else {
                                product.purchasePrice = item.price; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØµÙØ±
                            }
                            
                            product.quantity = totalQuantity;
                            product.lastPurchased = new Date().toISOString();
                            
                            // ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            if (!product.salePrice || product.salePrice < product.purchasePrice * 1.1) {
                                product.salePrice = product.purchasePrice * 1.3; // Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ 30%
                            }
                            
                            const updateRequest = productsStore.put(product);
                            updateRequest.onsuccess = () => {
                                console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬: ${product.name}, Ø§Ù„Ø³Ø¹Ø±: ${product.purchasePrice}, Ø§Ù„ÙƒÙ…ÙŠØ©: ${product.quantity}`);
                            };
                            updateRequest.onerror = (e) => {
                                console.error(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ${product.name}:`, e.target.error);
                            };
                            
                        } else {
                            // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                            const newProduct = {
                                code: `ITEM-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                name: item.productName,
                                purchasePrice: item.price,
                                salePrice: item.price * 1.3, // Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ 30%
                                quantity: item.quantity,
                                minQuantity: 5,
                                categoryId: null,
                                image: 'ğŸ“¦',
                                createdAt: new Date().toISOString()
                            };
                            
                            const addRequest = productsStore.add(newProduct);
                            addRequest.onsuccess = (e) => {
                                console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${item.productName}`);
                                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
                                item.productId = e.target.result;
                            };
                            addRequest.onerror = (e) => {
                                console.error(`âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ${item.productName}:`, e.target.error);
                            };
                        }
                    };
                    
                    productRequest.onerror = (e) => {
                        console.error(`âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬:`, e.target.error);
                    };
                }

                // 2. Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
                console.log('ğŸ’¾ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡...');
                const purchaseRequest = purchaseStore.add(purchase);
                
                purchaseRequest.onsuccess = (e) => {
                    const purchaseId = e.target.result;
                    console.log(`âœ… ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø±Ù‚Ù…: ${purchaseId}`);
                    
                    // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„ÙØ±Ø¯ÙŠØ©
                    console.log('ğŸ“’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡...');
                    recordPurchaseAccountingEntriesInTransaction(purchase, purchaseId, transaction)
                        .then(() => {
                            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡');
                            
                            // 4. ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ù‚Ø¯ÙŠØ©
                            if (purchase.paymentMethod === 'cash') {
                                console.log('ğŸ’µ ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ù„Ø´Ø±Ø§Ø¡...');
                                const cashTransaction = {
                                    date: purchase.date,
                                    type: 'Purchase',
                                    amount: -purchase.total,
                                    reference: `ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ ${purchase.invoiceNumber}`,
                                    purchaseId: purchaseId,
                                    supplierId: purchase.supplierId,
                                    supplierName: purchase.supplierName
                                };
                                const cashRequest = cashStore.add(cashTransaction);
                                cashRequest.onsuccess = () => {
                                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ù„Ø´Ø±Ø§Ø¡');
                                };
                                cashRequest.onerror = (e) => {
                                    console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:', e.target.error);
                                };
                            }
                            
                            // 5. ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¢Ø¬Ù„Ø©
                            if (purchase.paymentMethod === 'credit' && purchase.supplierId) {
                                console.log('ğŸ‘¥ ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯...');
                                const supplierRequest = suppliersStore.get(purchase.supplierId);
                                
                                supplierRequest.onsuccess = (e) => {
                                    const supplier = e.target.result;
                                    if (supplier) {
                                        supplier.balance = (supplier.balance || 0) + purchase.total;
                                        supplier.lastTransaction = new Date().toISOString();
                                        const updateRequest = suppliersStore.put(supplier);
                                        updateRequest.onsuccess = () => {
                                            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯: ${supplier.balance}`);
                                        };
                                        updateRequest.onerror = (e) => {
                                            console.error('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯:', e.target.error);
                                        };
                                    }
                                };
                                
                                supplierRequest.onerror = (e) => {
                                    console.error('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯:', e.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡:', error);
                            reject(error);
                        });
                };
                
                purchaseRequest.onerror = (e) => {
                    reject(new Error(`ÙØ´Ù„ Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡: ${e.target.error}`));
                };
            });
        }

        /**
        * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­
        */
        function recordPurchaseAccountingEntriesInTransaction(purchase, purchaseId, transaction) {
            return new Promise((resolve, reject) => {
                const journalStore = transaction.objectStore('journalEntries');
                const coaStore = transaction.objectStore('chartOfAccounts');
                
                console.log('ğŸ” ØªØ­Ø¯ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯:', purchase.supplierAccount);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const supplierAccountCode = purchase.supplierAccount || '2010000';
                
                let entry;
                
                if (purchase.paymentMethod === 'cash') {
                    // âœ… Ø´Ø±Ø§Ø¡ Ù†Ù‚Ø¯ÙŠ: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø¯Ø§Ø¦Ù†)
                    entry = {
                        date: new Date().toISOString(),
                        description: `ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ù†Ù‚Ø¯ÙŠ ${purchase.invoiceNumber} - ${purchase.supplierName}`,
                        debits: [{ 
                            accountCode: '1030', 
                            amount: purchase.total,
                            description: 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'
                        }],
                        credits: [{ 
                            accountCode: '1010', 
                            amount: purchase.total,
                            description: 'Ù…ØµØ§Ø±ÙŠÙ Ù†Ù‚Ø¯ÙŠØ©'
                        }],
                        refType: 'CashPurchase',
                        refId: purchaseId,
                        balanced: true,
                        totalAmount: purchase.total,
                        supplierId: purchase.supplierId,
                        supplierName: purchase.supplierName,
                        supplierAccount: supplierAccountCode,
                        paymentMethod: 'cash',
                        createdAt: new Date().toISOString()
                    };
                } else {
                    // âœ… Ø´Ø±Ø§Ø¡ Ø¢Ø¬Ù„: Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø¯Ø§Ø¦Ù†)
                    entry = {
                        date: new Date().toISOString(),
                        description: `ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¢Ø¬Ù„ ${purchase.invoiceNumber} - ${purchase.supplierName}`,
                        debits: [{ 
                            accountCode: '1030', 
                            amount: purchase.total,
                            description: 'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'
                        }],
                        credits: [{ 
                            accountCode: supplierAccountCode, 
                            amount: purchase.total,
                            description: `Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ${purchase.supplierName}`
                        }],
                        refType: 'CreditPurchase',
                        refId: purchaseId,
                        balanced: true,
                        totalAmount: purchase.total,
                        supplierId: purchase.supplierId,
                        supplierName: purchase.supplierName,
                        supplierAccount: supplierAccountCode,
                        paymentMethod: 'credit',
                        createdAt: new Date().toISOString()
                    };
                }
                
                console.log('ğŸ“Š Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø´Ø±Ø§Ø¡:', entry);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§Ø²Ù† Ø§Ù„Ù‚ÙŠØ¯
                const totalDebit = entry.debits.reduce((sum, d) => sum + d.amount, 0);
                const totalCredit = entry.credits.reduce((sum, c) => sum + c.amount, 0);
                const difference = Math.abs(totalDebit - totalCredit);
                
                if (difference > 0.01) {
                    const error = new Error(`Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†. Ø§Ù„Ù…Ø¯ÙŠÙ†: ${totalDebit.toFixed(2)}, Ø§Ù„Ø¯Ø§Ø¦Ù†: ${totalCredit.toFixed(2)}, Ø§Ù„ÙØ±Ù‚: ${difference.toFixed(2)}`);
                    reject(error);
                    return;
                }

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯
                const journalRequest = journalStore.add(entry);
                
                journalRequest.onsuccess = () => {
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    updateAccountBalances(entry.debits, entry.credits, coaStore)
                        .then(() => {
                            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡');
                            resolve();
                        })
                        .catch(reject);
                };
                
                journalRequest.onerror = (e) => {
                    reject(new Error(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡: ${e.target.error}`));
                };
            });
        }

        /**
        * Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
        */
        function addPurchaseItem() {
            const container = document.getElementById('purchaseItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'purchase-item row g-2 mb-2';
            newItem.innerHTML = `
                <div class="col-md-5">
                    <select class="form-select product-select" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control quantity-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" required min="1">
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control price-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" step="0.01" required min="0.01">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn w-100">Ø­Ø°Ù</button>
                </div>
            `;
            container.appendChild(newItem);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            loadProductsForPurchaseItem(newItem);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const quantityInput = newItem.querySelector('.quantity-input');
            const priceInput = newItem.querySelector('.price-input');
            
            quantityInput.addEventListener('input', calculatePurchaseTotal);
            priceInput.addEventListener('input', calculatePurchaseTotal);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            calculatePurchaseTotal();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ù†ØµØ± Ø´Ø±Ø§Ø¡ Ù…Ø­Ø¯Ø¯
        */
        async function loadProductsForPurchaseItem(itemElement) {
            try {
                const products = await getAllProducts();
                const select = itemElement.querySelector('.product-select');
                
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.code}) - ${product.quantity} Ù…ØªÙˆÙØ±`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
            }
        }

        /**
        * Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
        */
        function calculatePurchaseTotal() {
            let total = 0;
            document.querySelectorAll('.purchase-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(item.querySelector('.price-input').value) || 0;
                total += quantity * price;
            });
            document.getElementById('purchaseTotal').value = total.toFixed(2);
        }

        /**
        * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        */
        function validateInvoiceData(invoice) {
            const errors = [];
            
            if (!invoice.items || invoice.items.length === 0) {
                errors.push('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ØµÙ†Ø§Ù');
            }
            
            if (invoice.total <= 0) {
                errors.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
            }
            
            if (invoice.subtotal < invoice.discount) {
                errors.push('Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ');
            }
            
            if (invoice.paymentMethod === 'credit' && !invoice.customerId) {
                errors.push('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù„Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¢Ø¬Ù„Ø©');
            }
            
            return errors;
        }

        /**
        * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        */
        function validatePurchaseData(purchase) {
            const errors = [];
            
            if (!purchase.items || purchase.items.length === 0) {
                errors.push('ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ØµÙ†Ø§Ù');
            }
            
            if (purchase.total <= 0) {
                errors.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
            }
            
            if (!purchase.supplierId) {
                errors.push('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ³Ø§ÙˆÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const calculatedTotal = purchase.items.reduce((sum, item) => sum + item.total, 0);
            if (Math.abs(purchase.total - calculatedTotal) > 0.01) {
                errors.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù');
            }
            
            return errors;
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡
        */
        async function loadPurchasesTable() {
            try {
                const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                const store = transaction.objectStore('purchaseInvoices');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const purchases = request.result;
                    const tbody = document.getElementById('purchasesTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (purchases.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø´Ø±Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                        return;
                    }
                    
                    purchases.forEach(purchase => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${purchase.id}</td>
                            <td>${suppliers.find(s => s.id === purchase.supplierId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                            <td>${new Date(purchase.date).toLocaleDateString('ar-YE')}</td>
                            <td>${purchase.total.toFixed(2)} Ø±.ÙŠ</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-purchase-btn" data-id="${purchase.id}">Ø¹Ø±Ø¶</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡:', error);
            }
        }
        // ==================== 4.9. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø­Ø±ÙƒØ§Øª ====================
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ÙØ¦Ø©
        */
        function openCategoryModal(categoryId = null) {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            const form = document.getElementById('categoryForm');
            
            if (categoryId) {
                document.getElementById('categoryModalLabel').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©';
                
                const category = categories.find(c => c.id === parseInt(categoryId));
                if (category) {
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryDescription').value = category.description || '';
                }
            } else {
                document.getElementById('categoryModalLabel').textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                form.reset();
            }
            
            modal.show();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„
        */
        async function loadCategoriesBar() {
            const categoriesBar = document.getElementById('categoriesBar');
            if (!categoriesBar) return;

            try {
                const transaction = db.transaction(['categories'], 'readonly');
                const store = transaction.objectStore('categories');
                const request = store.getAll();

                request.onsuccess = function() {
                    const categories = request.result;
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø²Ø± "Ø§Ù„ÙƒÙ„")
                    const existingItems = categoriesBar.querySelectorAll('.suggestion-item:not([data-category-id="all"])');
                    existingItems.forEach(item => item.remove());

                    categories.forEach(category => {
                        const categoryItem = document.createElement('button');
                        categoryItem.className = 'suggestion-item';
                        categoryItem.dataset.categoryId = category.id;
                        categoryItem.onclick = () => {
                            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                            categoriesBar.querySelectorAll('.suggestion-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            categoryItem.classList.add('active');
                            loadProductsGrid(category.id);
                        };

                        categoryItem.innerHTML = `
                            <span class="suggestion-name">${category.name}</span>
                        `;
                        categoriesBar.appendChild(categoryItem);
                    });
                };
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ÙØ¦Ø§Øª:', error);
            }
        }

    
        /**
        * Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©
        */
        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const category = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                icon: 'ğŸ“' // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
            };

            try {
                const transaction = db.transaction(['categories'], 'readwrite');
                const store = transaction.objectStore('categories');
                const request = store.add(category);
                
                request.onsuccess = () => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
                    modal.hide();
                    loadCategoriesTable();
                    loadCategories(); // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ÙØ¦Ø§Øª
                    loadCategoriesBar(); // â­ ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                };
            } catch (error) {
                console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©:', error);
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª
        */
        async function loadCategoriesTable() {
            try {
                const categories = await loadCategories();
                const tbody = document.getElementById('categoriesTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }
                
                // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ÙƒÙ„ ÙØ¦Ø©
                const products = await getAllProducts();
                
                categories.forEach(category => {
                    const productCount = products.filter(p => p.categoryId === category.id).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.name}</td>
                        <td>${category.description || '-'}</td>
                        <td>${productCount}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-category-btn" data-id="${category.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-sm btn-outline-danger delete-category-btn" data-id="${category.id}">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª
        */
        async function loadMovementsProductSelect() {
            try {
                const products = await getAllProducts();
                const select = document.getElementById('movementProductSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ù„Ø¹Ø±Ø¶ Ø­Ø±ÙƒØ§ØªÙ‡</option>';
                
                products.forEach(product => {
                    select.innerHTML += `<option value="${product.id}">${product.name} (${product.code})</option>`;
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø«
                select.addEventListener('change', function() {
                    if (this.value) {
                        loadProductMovements(parseInt(this.value));
                    } else {
                        const movementsTableBody = document.getElementById('movementsTableBody');
                        if (movementsTableBody) {
                            movementsTableBody.innerHTML = '';
                        }
                    }
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø­Ø±ÙƒØ§Øª:', error);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø­Ø±ÙƒØ§Øª Ù…Ù†ØªØ¬ Ù…Ø­Ø¯Ø¯
        */
        async function loadProductMovements(productId) {
            try {
                const [invoices, purchases] = await Promise.all([
                    getAllInvoices(),
                    new Promise((resolve) => {
                        const transaction = db.transaction(['purchaseInvoices'], 'readonly');
                        const store = transaction.objectStore('purchaseInvoices');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                    })
                ]);

                const movements = [];
                
                // Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø®Ø±ÙˆØ¬)
                invoices.forEach(invoice => {
                    if (invoice.items) {
                        invoice.items.forEach(item => {
                            if (item.id === productId) {
                                movements.push({
                                    date: invoice.date,
                                    type: 'Ø¨ÙŠØ¹',
                                    quantity: -item.quantity,
                                    price: item.price,
                                    reference: `ÙØ§ØªÙˆØ±Ø© ${invoice.invoiceNumber}`
                                });
                            }
                        });
                    }
                });
                
                // Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¯Ø®ÙˆÙ„)
                purchases.forEach(purchase => {
                    if (purchase.items) {
                        purchase.items.forEach(item => {
                            if (item.productId === productId) {
                                movements.push({
                                    date: purchase.date,
                                    type: 'Ø´Ø±Ø§Ø¡',
                                    quantity: item.quantity,
                                    price: item.price,
                                    reference: `Ø´Ø±Ø§Ø¡ ${purchase.id}`
                                });
                            }
                        });
                    }
                });
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                movements.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±ÙƒØ§Øª
                const tbody = document.getElementById('movementsTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (movements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬.</td></tr>';
                    return;
                }
                
                movements.forEach(movement => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(movement.date).toLocaleDateString('ar-YE')}</td>
                        <td>
                            <span class="badge ${movement.type === 'Ø¨ÙŠØ¹' ? 'bg-danger' : 'bg-success'}">
                                ${movement.type}
                            </span>
                        </td>
                        <td>${movement.quantity > 0 ? '+' : ''}${movement.quantity}</td>
                        <td>${movement.price.toFixed(2)} Ø±.ÙŠ</td>
                        <td>${movement.reference}</td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªØ¬:', error);
            }
        }
        // ==================== 4.10. Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ====================
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
        */
        function openCashOperationModal(operationType) {
            const modal = new bootstrap.Modal(document.getElementById('cashOperationModal'));
            document.getElementById('cashOperationType').value = operationType;
            
            // ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            const titleMap = {
                'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ',
                'withdraw': 'Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ', 
                'transfer': 'ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª'
            };
            
            document.getElementById('cashOperationModalLabel').textContent = titleMap[operationType];
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
            const accountContainer = document.getElementById('cashAccountContainer');
            accountContainer.style.display = operationType === 'transfer' ? 'block' : 'none';
            
            modal.show();
        }

        /**
        * ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
        */
        async function executeCashOperation() {
            const operationType = document.getElementById('cashOperationType').value;
            const amount = parseFloat(document.getElementById('cashAmount').value);
            const description = document.getElementById('cashDescription').value;
            const targetAccount = document.getElementById('cashAccount').value;

            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }

            try {
                let debits = [];
                let credits = [];
                let journalDescription = '';

                switch(operationType) {
                    case 'deposit':
                        // Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹: Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„
                        debits = [{ accountCode: '1010', amount: amount }];
                        credits = [{ accountCode: '2020', amount: amount }];
                        journalDescription = `Ø¥ÙŠØ¯Ø§Ø¹ Ù†Ù‚Ø¯ÙŠ: ${description}`;
                        break;
                        
                    case 'withdraw':
                        // Ø§Ù„Ø³Ø­Ø¨: Ù†Ù‚ØµØ§Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                        debits = [{ accountCode: '3030', amount: amount }];
                        credits = [{ accountCode: '1010', amount: amount }];
                        journalDescription = `Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ: ${description}`;
                        break;
                        
                    case 'transfer':
                        // Ø§Ù„ØªØ­ÙˆÙŠÙ„: Ù†Ù‚ØµØ§Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¨Ù†Ùƒ
                        debits = [{ accountCode: targetAccount, amount: amount }];
                        credits = [{ accountCode: '1010', amount: amount }];
                        journalDescription = `ØªØ­ÙˆÙŠÙ„ Ù†Ù‚Ø¯ÙŠ: ${description}`;
                        break;
                }

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
                await createJournalEntry(journalDescription, debits, credits, 'CashOperation', null);
                
                // ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                
                const cashTransaction = {
                    date: new Date().toISOString(),
                    type: operationType === 'deposit' ? 'Deposit' : 
                        operationType === 'withdraw' ? 'Withdraw' : 'Transfer',
                    amount: operationType === 'withdraw' ? -amount : amount,
                    reference: description
                };
                
                store.add(cashTransaction);

                const modal = bootstrap.Modal.getInstance(document.getElementById('cashOperationModal'));
                modal.hide();
                
                alert('ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                updateBalance();
                loadCashTransactions();

            } catch (error) {
                console.error('ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©:', error);
                alert('ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + error.message);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
        */
        async function loadCashTransactions() {
            try {
                const transactions = await getAllCashTransactions();
                const tbody = document.getElementById('cashTransactionsTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
                    return;
                }

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                transactions.forEach(trans => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(trans.date).toLocaleDateString('ar-YE')}</td>
                        <td>
                            <span class="badge ${
                                trans.type === 'Sale' ? 'bg-success' :
                                trans.type === 'Deposit' ? 'bg-info' :
                                trans.type === 'Withdraw' ? 'bg-danger' :
                                trans.type === 'Transfer' ? 'bg-warning' : 'bg-secondary'
                            }">
                                ${trans.type === 'Sale' ? 'Ø¨ÙŠØ¹' :
                                trans.type === 'Deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' :
                                trans.type === 'Withdraw' ? 'Ø³Ø­Ø¨' :
                                trans.type === 'Transfer' ? 'ØªØ­ÙˆÙŠÙ„' : trans.type}
                            </span>
                        </td>
                        <td class="${trans.amount < 0 ? 'text-danger' : 'text-success'}">
                            ${trans.amount > 0 ? '+' : ''}${trans.amount.toFixed(2)} Ø±.ÙŠ
                        </td>
                        <td>${trans.reference}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:', error);
            }
        }

        /**
        * Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© ÙˆØ¹Ù…Ù„ ØªØ³ÙˆÙŠØ©
        */
        async function closeShift() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¹Ù…Ù„ ØªØ³ÙˆÙŠØ©ØŸ')) {
                return;
            }

            try {
                // Ø¬Ù„Ø¨ Ø­Ø±ÙƒØ§Øª Ø§Ù„ÙŠÙˆÙ…
                const today = new Date().toDateString();
                const cashTransactions = await getAllCashTransactions();
                const todayTransactions = cashTransactions.filter(trans => 
                    new Date(trans.date).toDateString() === today
                );

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                const totalDeposits = todayTransactions
                    .filter(trans => trans.type === 'Deposit')
                    .reduce((sum, trans) => sum + trans.amount, 0);
                    
                const totalWithdrawals = todayTransactions
                    .filter(trans => trans.type === 'Withdraw')
                    .reduce((sum, trans) => sum + Math.abs(trans.amount), 0);
                    
                const totalSales = todayTransactions
                    .filter(trans => trans.type === 'Sale')
                    .reduce((sum, trans) => sum + trans.amount, 0);

                const netAmount = totalDeposits + totalSales - totalWithdrawals;

                // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©
                const report = `
        Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© - ${new Date().toLocaleDateString('ar-YE')}

        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª: ${totalDeposits.toFixed(2)} Ø±.ÙŠ
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª: ${totalWithdrawals.toFixed(2)} Ø±.ÙŠ
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales.toFixed(2)} Ø±.ÙŠ
        ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª: ${netAmount.toFixed(2)} Ø±.ÙŠ

        Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ
                `;

                if (confirm(report)) {
                    // ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø·Ø¨Ø§Ø¹ØªÙ‡
                    alert('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                }

            } catch (error) {
                console.error('ÙØ´Ù„ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:', error);
                alert('ÙØ´Ù„ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©: ' + error.message);
            }
        }
        // ==================== 4.11. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ====================
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        */
        function openJournalEntryModal() {
            const modal = new bootstrap.Modal(document.getElementById('journalEntryModal'));
            
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            loadAccountOptions();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('journalEntryForm').reset();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('debitEntriesContainer').innerHTML = `
                <div class="debit-entry row g-2 mb-2">
                    <div class="col-md-8">
                        <select class="form-select debit-account-select" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control debit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                    </div>
                </div>
            `;
            
            document.getElementById('creditEntriesContainer').innerHTML = `
                <div class="credit-entry row g-2 mb-2">
                    <div class="col-md-8">
                        <select class="form-select credit-account-select" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control credit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                    </div>
                </div>
            `;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            setTimeout(() => {
                loadAccountOptions();
                calculateJournalEntryTotals();
            }, 500);
            
            modal.show();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        */
        async function loadAccountOptions() {
            try {
                const transaction = db.transaction(['chartOfAccounts'], 'readonly');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const accounts = request.result;
                    
                    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ØªØµÙÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
                    const activeAccounts = accounts.filter(acc => 
                        acc.isActive !== false && // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
                        acc.type !== 'header' // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø±Ø£Ø³ÙŠØ©
                    );
                    
                    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                    const mainAccounts = activeAccounts.filter(acc => 
                        !acc.customerId && !acc.supplierId
                    );
                    
                    const customerAccounts = activeAccounts.filter(acc => 
                        acc.customerId && acc.accountType === 'customer'
                    );
                    
                    const supplierAccounts = activeAccounts.filter(acc => 
                        acc.supplierId && acc.accountType === 'supplier'
                    );
                    
                    const debitSelects = document.querySelectorAll('.debit-account-select');
                    const creditSelects = document.querySelectorAll('.credit-account-select');
                    
                    // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
                    let optionsHTML = '';
                    
                    // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    if (mainAccounts.length > 0) {
                        optionsHTML += '<optgroup label="ğŸ”„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">';
                        mainAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} Ø±.ÙŠ)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="${acc.type}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    }
                    
                    // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                    if (customerAccounts.length > 0) {
                        optionsHTML += '<optgroup label="ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">';
                        customerAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} Ø±.ÙŠ)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="customer" data-customer-id="${acc.customerId}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    } else {
                        // âœ… Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø¹Ù…Ù„Ø§Ø¡
                        optionsHTML += '<optgroup label="ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">';
                        optionsHTML += `<option value="1040000" data-type="customer">1040000 - Ø¹Ù…Ù„Ø§Ø¡ Ù†Ù‚Ø¯ÙŠÙˆÙ†</option>`;
                        optionsHTML += '</optgroup>';
                    }
                    
                    // Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©
                    if (supplierAccounts.length > 0) {
                        optionsHTML += '<optgroup label="ğŸ¢ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©">';
                        supplierAccounts.forEach(acc => {
                            const balanceText = acc.balance !== undefined ? ` (${acc.balance.toFixed(2)} Ø±.ÙŠ)` : '';
                            optionsHTML += `<option value="${acc.code}" data-type="supplier" data-supplier-id="${acc.supplierId}">${acc.code} - ${acc.name}${balanceText}</option>`;
                        });
                        optionsHTML += '</optgroup>';
                    } else {
                        // âœ… Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ÙˆØ±Ø¯ÙŠÙ†
                        optionsHTML += '<optgroup label="ğŸ¢ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† - Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©">';
                        optionsHTML += `<option value="2010000" data-type="supplier">2010000 - Ù…ÙˆØ±Ø¯ÙŠÙ† Ù†Ù‚Ø¯ÙŠÙˆÙ†</option>`;
                        optionsHTML += '</optgroup>';
                    }
                    
                    // âœ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                    debitSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>' + optionsHTML;
                        if (currentValue) select.value = currentValue;
                    });
                    
                    creditSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>' + optionsHTML;
                        if (currentValue) select.value = currentValue;
                    });

                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', {
                        main: mainAccounts.length,
                        customers: customerAccounts.length,
                        suppliers: supplierAccounts.length
                    });
                };
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:', error);
            }
        }

        /**
        * Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        */
        function addDebitEntry() {
            const container = document.getElementById('debitEntriesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'debit-entry row g-2 mb-2';
            newEntry.innerHTML = `
                <div class="col-md-8">
                    <select class="form-select debit-account-select" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control debit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                </div>
            `;
            container.appendChild(newEntry);
            loadAccountOptions();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const amountInput = newEntry.querySelector('.debit-amount');
            amountInput.addEventListener('input', calculateJournalEntryTotals);
        }

        /**
        * Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù† Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        */
        function addCreditEntry() {
            const container = document.getElementById('creditEntriesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'credit-entry row g-2 mb-2';
            newEntry.innerHTML = `
                <div class="col-md-8">
                    <select class="form-select credit-account-select" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control credit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" step="0.01" required>
                </div>
            `;
            container.appendChild(newEntry);
            loadAccountOptions();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const amountInput = newEntry.querySelector('.credit-amount');
            amountInput.addEventListener('input', calculateJournalEntryTotals);
        }

        /**
        * Ø­Ø³Ø§Ø¨ Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† ÙˆØ§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ†Ù‡Ù…Ø§
        */
        function calculateJournalEntryTotals() {
            let totalDebit = 0;
            let totalCredit = 0;
            
            document.querySelectorAll('.debit-amount').forEach(input => {
                totalDebit += parseFloat(input.value) || 0;
            });
            
            document.querySelectorAll('.credit-amount').forEach(input => {
                totalCredit += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalDebitAmount').textContent = totalDebit.toFixed(2);
            document.getElementById('totalCreditAmount').textContent = totalCredit.toFixed(2);
            
            const difference = totalDebit - totalCredit;
            document.getElementById('balanceDifference').textContent = difference.toFixed(2);
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù†
            const saveBtn = document.getElementById('saveJournalEntryBtn');
            saveBtn.disabled = Math.abs(difference) > 0.01;
        }





        /**
        * Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        */
        async function saveJournalEntry() {
            const description = document.getElementById('entryDescription').value;
            
            if (!description) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ù‚ÙŠØ¯');
                return;
            }

            // Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
            const debits = [];
            document.querySelectorAll('.debit-entry').forEach(entry => {
                const accountSelect = entry.querySelector('.debit-account-select');
                const amountInput = entry.querySelector('.debit-amount');
                
                if (accountSelect.value && amountInput.value) {
                    debits.push({
                        accountCode: accountSelect.value,
                        amount: parseFloat(amountInput.value),
                        accountType: accountSelect.options[accountSelect.selectedIndex].dataset.type
                    });
                }
            });

            // Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
            const credits = [];
            document.querySelectorAll('.credit-entry').forEach(entry => {
                const accountSelect = entry.querySelector('.credit-account-select');
                const amountInput = entry.querySelector('.credit-amount');
                
                if (accountSelect.value && amountInput.value) {
                    credits.push({
                        accountCode: accountSelect.value,
                        amount: parseFloat(amountInput.value),
                        accountType: accountSelect.options[accountSelect.selectedIndex].dataset.type
                    });
                }
            });

            // Ø¬Ù…Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ„
            const collectionEntries = [];
            document.querySelectorAll('.collection-entry').forEach(entry => {
                const customerSelect = entry.querySelector('.collection-customer-select');
                const supplierSelect = entry.querySelector('.collection-supplier-select');
                const amountInput = entry.querySelector('.collection-amount');
                const paymentMethod = entry.querySelector('.collection-payment-method');
                const collectionDescription = entry.querySelector('.collection-description');
                
                if (amountInput.value) {
                    const amount = parseFloat(amountInput.value);
                    let collectionEntry = {
                        amount: amount,
                        paymentMethod: paymentMethod?.value || 'cash',
                        description: collectionDescription?.value || 'Ø¹Ù…Ù„ÙŠØ© ØªØ­ØµÙŠÙ„'
                    };
                    
                    if (customerSelect && customerSelect.value) {
                        // ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„
                        collectionEntry.type = 'customer_collection';
                        collectionEntry.customerId = parseInt(customerSelect.value);
                        collectionEntry.customerAccount = customerSelect.options[customerSelect.selectedIndex].dataset.account;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚ÙŠÙˆØ¯: Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¯Ø§Ø¦Ù†)
                        debits.push({ accountCode: '1010', amount: amount });
                        credits.push({ accountCode: collectionEntry.customerAccount, amount: amount });
                        
                    } else if (supplierSelect && supplierSelect.value) {
                        // Ø³Ø¯Ø§Ø¯ Ù„Ù…ÙˆØ±Ø¯
                        collectionEntry.type = 'supplier_payment';
                        collectionEntry.supplierId = parseInt(supplierSelect.value);
                        collectionEntry.supplierAccount = supplierSelect.options[supplierSelect.selectedIndex].dataset.account;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚ÙŠÙˆØ¯: Ø§Ù„Ù…ÙˆØ±Ø¯ (Ù…Ø¯ÙŠÙ†) â† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø¯Ø§Ø¦Ù†)
                        debits.push({ accountCode: collectionEntry.supplierAccount, amount: amount });
                        credits.push({ accountCode: '1010', amount: amount });
                    }
                    
                    collectionEntries.push(collectionEntry);
                }
            });

            if (debits.length === 0 && credits.length === 0 && collectionEntries.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            try {
                await createJournalEntry(description, debits, credits, 'Manual', null);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('journalEntryModal'));
                modal.hide();
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ù†Ø§Ø³Ø¨Ø©
                if (collectionEntries.length > 0) {
                    let successMessage = 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!';
                    collectionEntries.forEach(entry => {
                        if (entry.type === 'customer_collection') {
                            successMessage += `\nğŸ’° ØªÙ… ØªØ­ØµÙŠÙ„ ${entry.amount.toFixed(2)} Ø±.ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„`;
                        } else if (entry.type === 'supplier_payment') {
                            successMessage += `\nğŸ’³ ØªÙ… Ø³Ø¯Ø§Ø¯ ${entry.amount.toFixed(2)} Ø±.ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯`;
                        }
                    });
                    alert(successMessage);
                } else {
                    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                }
                
                displayChartOfAccounts();
                loadJournalEntries();

            } catch (error) {
                console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯: ' + error.message);
            }
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        */
        async function loadJournalEntries() {
            try {
                const transaction = db.transaction(['journalEntries'], 'readonly');
                const store = transaction.objectStore('journalEntries');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const entries = request.result;
                    const tbody = document.getElementById('journalEntriesTable');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (entries.length === 0) {
                        tbody.innerHTML = '<tr class="text-center text-muted"><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙŠÙˆÙ…ÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</td></tr>';
                        return;
                    }
                    
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
                    entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    entries.forEach(entry => {
                        const totalDebit = entry.debits.reduce((sum, d) => sum + d.amount, 0);
                        const totalCredit = entry.credits.reduce((sum, c) => sum + c.amount, 0);
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(entry.date).toLocaleDateString('ar-YE')}</td>
                            <td>${entry.description}</td>
                            <td>${totalDebit.toFixed(2)}</td>
                            <td>${totalCredit.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:', error);
            }
        }
        // ==================== 4.12. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ====================
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯
        */
        function openSupplierModal(supplierId = null) {
            const modal = new bootstrap.Modal(document.getElementById('supplierModal'));
            const form = document.getElementById('supplierForm');
            
            if (supplierId) {
                document.getElementById('supplierModalLabel').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯';
                const supplier = suppliers.find(s => s.id === parseInt(supplierId));
                if (supplier) {
                    document.getElementById('supplierId').value = supplier.id;
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone || '';
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierAddress').value = supplier.address || '';
                }
            } else {
                document.getElementById('supplierModalLabel').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯';
                form.reset();
            }
            
            modal.show();
        }
        /**
        * Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        */
        async function saveSupplier() {
            const form = document.getElementById('supplierForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const supplier = {
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value
            };

            const supplierId = document.getElementById('supplierId').value;
            if (supplierId) {
                supplier.id = parseInt(supplierId);
            }

            try {
                let savedSupplierId;
                
                if (supplierId) {
                    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ±Ø¯ Ù…ÙˆØ¬ÙˆØ¯
                    const transaction = db.transaction(['suppliers'], 'readwrite');
                    const store = transaction.objectStore('suppliers');
                    await store.put(supplier);
                    savedSupplierId = supplier.id;
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯');
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯
                    const transaction = db.transaction(['suppliers'], 'readwrite');
                    const store = transaction.objectStore('suppliers');
                    const request = store.add(supplier);
                    
                    await new Promise((resolve, reject) => {
                        request.onsuccess = (e) => {
                            savedSupplierId = e.target.result;
                            supplier.id = savedSupplierId;
                            resolve();
                        };
                        request.onerror = (e) => reject(e.target.error);
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    await createSupplierAccount(supplier);
                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯');
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                const modal = bootstrap.Modal.getInstance(document.getElementById('supplierModal'));
                modal.hide();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadSuppliersTable();
                await loadSuppliers();
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                if (document.getElementById('accounting').classList.contains('active')) {
                    displayChartOfAccounts();
                }
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ù‡ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª!');

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        */
        async function createSupplierAccount(supplier) {
            return new Promise((resolve, reject) => {
                const accountCode = `2010${supplier.id.toString().padStart(4, '0')}`;
                const account = {
                    code: accountCode,
                    name: `Ù…ÙˆØ±Ø¯ - ${supplier.name}`,
                    type: 'liability',
                    parentCode: '2010',
                    balance: 0.00,
                    supplierId: supplier.id,
                    supplierName: supplier.name,
                    supplierPhone: supplier.phone,
                    accountType: 'supplier',
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.add(account);
                
                request.onsuccess = async () => {
                    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ${accountCode} Ù„Ù„Ù…ÙˆØ±Ø¯ ${supplier.name}`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨
                    const supplierTransaction = db.transaction(['suppliers'], 'readwrite');
                    const supplierStore = supplierTransaction.objectStore('suppliers');
                    supplier.accCode = accountCode;
                    await supplierStore.put(supplier);
                    
                    resolve(accountCode);
                };
                
                request.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯:', e.target.error);
                    reject(e.target.error);
                };
            });
        }
        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        */
        async function loadSuppliersTable() {
            try {
                const suppliers = await loadSuppliers();
                const tbody = document.getElementById('suppliersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (suppliers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†.</td></tr>';
                    return;
                }
                
                suppliers.forEach(supplier => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${supplier.name}</td>
                        <td>${supplier.phone || '-'}</td>
                        <td>${supplier.email || '-'}</td>
                        <td>${supplier.address || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-supplier-btn" data-id="${supplier.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-sm btn-outline-danger delete-supplier-btn" data-id="${supplier.id}">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', error);
            }
        }

        /**
        * Ø­Ø°Ù Ù…ÙˆØ±Ø¯
        */
        async function deleteSupplier(supplierId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ')) return;
            
            try {
                const transaction = db.transaction(['suppliers'], 'readwrite');
                const store = transaction.objectStore('suppliers');
                await store.delete(parseInt(supplierId));
                
                loadSuppliersTable();
                loadSuppliers();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                console.error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯:', error);
                alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }
        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„
        */
        function openCustomerModal(customerId = null) {
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            const form = document.getElementById('customerForm');
            
            if (customerId) {
                document.getElementById('customerModalLabel').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„';
                const customer = customers.find(c => c.id === parseInt(customerId));
                if (customer) {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone || '';
                    document.getElementById('customerEmail').value = customer.email || '';
                    document.getElementById('customerAddress').value = customer.address || '';
                }
            } else {
                document.getElementById('customerModalLabel').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
                form.reset();
            }
            
            modal.show();
        }
        /**
        * Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
        */
        async function saveCustomer() {
            const form = document.getElementById('customerForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const customer = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                address: document.getElementById('customerAddress').value,
                balance: 0
            };

            const customerId = document.getElementById('customerId').value;
            if (customerId) {
                customer.id = parseInt(customerId);
            }

            try {
                let savedCustomerId;
                
                if (customerId) {
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯
                    const transaction = db.transaction(['customers'], 'readwrite');
                    const store = transaction.objectStore('customers');
                    await store.put(customer);
                    savedCustomerId = customer.id;
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯');
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                    const transaction = db.transaction(['customers'], 'readwrite');
                    const store = transaction.objectStore('customers');
                    const request = store.add(customer);
                    
                    await new Promise((resolve, reject) => {
                        request.onsuccess = (e) => {
                            savedCustomerId = e.target.result;
                            customer.id = savedCustomerId;
                            resolve();
                        };
                        request.onerror = (e) => reject(e.target.error);
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    await createCustomerAccount(customer);
                    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„');
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                modal.hide();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadCustomersTable();
                await loadCustomers();
                await loadCustomersForPOS();
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                if (document.getElementById('accounting').classList.contains('active')) {
                    displayChartOfAccounts();
                }
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ù‡ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª!');

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        */
        async function createCustomerAccount(customer) {
            return new Promise((resolve, reject) => {
                const accountCode = `1040${customer.id.toString().padStart(4, '0')}`;
                const account = {
                    code: accountCode,
                    name: `Ø¹Ù…ÙŠÙ„ - ${customer.name}`,
                    type: 'asset',
                    parentCode: '1040',
                    balance: 0.00,
                    customerId: customer.id,
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    accountType: 'customer',
                    isActive: true,
                    createdAt: new Date().toISOString()
                };
                
                const transaction = db.transaction(['chartOfAccounts'], 'readwrite');
                const store = transaction.objectStore('chartOfAccounts');
                const request = store.add(account);
                
                request.onsuccess = async () => {
                    console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ${accountCode} Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customer.name}`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨
                    const customerTransaction = db.transaction(['customers'], 'readwrite');
                    const customerStore = customerTransaction.objectStore('customers');
                    customer.accCode = accountCode;
                    await customerStore.put(customer);
                    
                    resolve(accountCode);
                };
                
                request.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        */
        async function loadCustomersTable() {
            try {
                const customers = await loadCustomers();
                const tbody = document.getElementById('customersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†.</td></tr>';
                    return;
                }
                
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.address || '-'}</td>
                        <td class="${(customer.balance || 0) > 0 ? 'text-danger' : 'text-success'}">
                            ${(customer.balance || 0).toFixed(2)} Ø±.ÙŠ
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-customer-btn" data-id="${customer.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-sm btn-outline-danger delete-customer-btn" data-id="${customer.id}">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', error);
            }
        }

        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        */
        function openSupplierPaymentModal() {
            const modal = new bootstrap.Modal(document.getElementById('supplierPaymentModal'));
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±ØµØ¯Ø©
            loadSuppliersWithBalances();
            
            modal.show();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±ØµØ¯Ø© Ø¯Ø§Ø¦Ù†Ø©
        */
        async function loadSuppliersWithBalances() {
            try {
                const suppliers = await loadSuppliers();
                const supplierSelect = document.getElementById('supplierPaymentSelect');
                
                if (!supplierSelect) return;
                
                supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
                
                let hasBalances = false;
                
                for (const supplier of suppliers) {
                    if (supplier.balance > 0) {
                        hasBalances = true;
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = `${supplier.name} - Ù…Ø³ØªØ­Ù‚: ${supplier.balance.toFixed(2)} Ø±.ÙŠ`;
                        option.dataset.balance = supplier.balance;
                        option.dataset.accountCode = supplier.accCode;
                        supplierSelect.appendChild(option);
                    }
                }
                
                if (!hasBalances) {
                    supplierSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';
                }
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†:', error);
            }
        }

        /**
        * ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù„Ù„Ù…ÙˆØ±Ø¯
        */
        async function executeSupplierPayment() {
            const supplierSelect = document.getElementById('supplierPaymentSelect');
            const amountInput = document.getElementById('supplierPaymentAmount');
            const descriptionInput = document.getElementById('supplierPaymentDescription');
            
            const supplierId = supplierSelect.value;
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value;
            
            if (!supplierId || !amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
                const supplier = await getSupplierById(parseInt(supplierId));
                if (!supplier) {
                    alert('Ø§Ù„Ù…ÙˆØ±Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯ Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯
                if (amount > supplier.balance) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯ (${amount.toFixed(2)}) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (${supplier.balance.toFixed(2)})`);
                    return;
                }
                
                // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø³Ø¯Ø§Ø¯
                const debits = [{
                    accountCode: supplier.accCode || '2010000', // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯
                    amount: amount,
                    description: `Ø³Ø¯Ø§Ø¯ Ù„Ù…ÙˆØ±Ø¯ - ${description}`
                }];
                
                const credits = [{
                    accountCode: '1010', // Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                    amount: amount,
                    description: `Ø³Ø¯Ø§Ø¯ Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø© - ${supplier.name}`
                }];
                
                await createJournalEntry(
                    `Ø³Ø¯Ø§Ø¯ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù„Ù„Ù…ÙˆØ±Ø¯ ${supplier.name} - ${description}`,
                    debits,
                    credits,
                    'SupplierPayment',
                    supplier.id
                );
                
                // âœ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯
                supplier.balance -= amount;
                await updateSupplier(supplier);
                
                // âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                await store.add({
                    date: new Date().toISOString(),
                    type: 'SupplierPayment',
                    amount: -amount,
                    reference: `Ø³Ø¯Ø§Ø¯ Ù„Ù„Ù…ÙˆØ±Ø¯ ${supplier.name} - ${description}`,
                    supplierId: supplier.id,
                    supplierName: supplier.name
                });
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                const modal = bootstrap.Modal.getInstance(document.getElementById('supplierPaymentModal'));
                modal.hide();
                
                alert(`âœ… ØªÙ… Ø³Ø¯Ø§Ø¯ ${amount.toFixed(2)} Ø±.ÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ ${supplier.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                updateBalance();
                displayChartOfAccounts();
                loadSuppliersTable();
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø¯Ø§Ø¯:', error);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø¯Ø§Ø¯: ' + error.message);
            }
        }

        /**
        * ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        */
        function openCollectionModal() {
            const modal = new bootstrap.Modal(document.getElementById('collectionModal'));
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±ØµØ¯Ø©
            loadCustomersWithBalances();
            
            modal.show();
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±ØµØ¯Ø© Ù…Ø¯ÙŠÙ†Ø©
        */
        async function loadCustomersWithBalances() {
            try {
                const customers = await loadCustomers();
                const customerSelect = document.getElementById('collectionCustomerSelect');
                
                if (!customerSelect) return;
                
                customerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
                
                let hasBalances = false;
                
                for (const customer of customers) {
                    if (customer.balance > 0) {
                        hasBalances = true;
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} - Ø±ØµÙŠØ¯: ${customer.balance.toFixed(2)} Ø±.ÙŠ`;
                        option.dataset.balance = customer.balance;
                        option.dataset.accountCode = customer.accCode;
                        customerSelect.appendChild(option);
                    }
                }
                
                if (!hasBalances) {
                    customerSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³ØªØ­Ù‚Ø©</option>';
                }
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', error);
            }
        }

        /**
        * ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
        */
        async function executeCollection() {
            const customerSelect = document.getElementById('collectionCustomerSelect');
            const amountInput = document.getElementById('collectionAmount');
            const descriptionInput = document.getElementById('collectionDescription');
            
            const customerId = customerSelect.value;
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value;
            
            if (!customerId || !amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                const customer = await getCustomerById(parseInt(customerId));
                if (!customer) {
                    alert('Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯
                if (amount > customer.balance) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ (${amount.toFixed(2)}) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚ (${customer.balance.toFixed(2)})`);
                    return;
                }
                
                // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„ØªØ­ØµÙŠÙ„
                const debits = [{
                    accountCode: '1010', // Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                    amount: amount,
                    description: `ØªØ­ØµÙŠÙ„ Ù…Ù† ${customer.name}`
                }];
                
                const credits = [{
                    accountCode: customer.accCode || '1040000', // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
                    amount: amount,
                    description: `ØªØ­ØµÙŠÙ„ Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø© - ${description}`
                }];
                
                await createJournalEntry(
                    `ØªØ­ØµÙŠÙ„ Ø¯ÙŠÙˆÙ† Ù…Ù† ${customer.name} - ${description}`,
                    debits,
                    credits,
                    'Collection',
                    customer.id
                );
                
                // âœ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
                customer.balance -= amount;
                await updateCustomer(customer);
                
                // âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                const transaction = db.transaction(['cashTransactions'], 'readwrite');
                const store = transaction.objectStore('cashTransactions');
                await store.add({
                    date: new Date().toISOString(),
                    type: 'Collection',
                    amount: amount,
                    reference: `ØªØ­ØµÙŠÙ„ Ù…Ù† ${customer.name} - ${description}`,
                    customerId: customer.id,
                    customerName: customer.name
                });
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                const modal = bootstrap.Modal.getInstance(document.getElementById('collectionModal'));
                modal.hide();
                
                alert(`âœ… ØªÙ… ØªØ­ØµÙŠÙ„ ${amount.toFixed(2)} Ø±.ÙŠ Ù…Ù† ${customer.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                updateBalance();
                displayChartOfAccounts();
                loadCustomersTable();
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„:', error);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„: ' + error.message);
            }
        }

        /**
        * Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
        */
        async function deleteCustomer(customerId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
            
            try {
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                await store.delete(parseInt(customerId));
                
                loadCustomersTable();
                loadCustomers();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                console.error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:', error);
                alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        /**
        * Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† IndexedDB
        */
        function loadCustomers() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readonly');
                const store = transaction.objectStore('customers');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    customers = request.result;
                    resolve(customers);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
        */
        async function updateCustomer(customer) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['customers'], 'readwrite');
                const store = transaction.objectStore('customers');
                const request = store.put(customer);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
        * ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
        */
        async function updateSupplier(supplier) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Database not initialized"));
                const transaction = db.transaction(['suppliers'], 'readwrite');
                const store = transaction.objectStore('suppliers');
                const request = store.put(supplier);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        // ==================== 4.14. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ====================

        /**
        * Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        */
        async function saveSettings() {
            try {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
                
                // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
                const settings = {
                    exchangeRate: parseFloat(document.getElementById('exchangeRateInput').value) || 425,
                    taxRate: parseFloat(document.getElementById('taxRateInput').value) || 0,
                    showQuantityField: document.getElementById('showQuantityFieldSetting') ? 
                        document.getElementById('showQuantityFieldSetting').checked : true
                };

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (isNaN(settings.exchangeRate) || settings.exchangeRate <= 0) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ±Ù ØµØ­ÙŠØ­');
                    return;
                }

                if (isNaN(settings.taxRate) || settings.taxRate < 0) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø¶Ø±ÙŠØ¨Ø© ØµØ­ÙŠØ­Ø©');
                    return;
                }

                console.log('ğŸ“Š Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:', settings);

                // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ IndexedDB
                await saveSettingsToDatabase(settings);
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ø§Ù‹
                await applySettingsImmediately(settings);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                showSettingsSuccessMessage(settings);
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                alert('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + error.message);
            }
        }

        /**
        * Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        */
        async function saveSettingsToDatabase(settings) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©'));
                    return;
                }

                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                // Ø­ÙØ¸ ÙƒÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
                const promises = [
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'exchangeRate', value: settings.exchangeRate });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    }),
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'taxRate', value: settings.taxRate });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    }),
                    new Promise((res, rej) => {
                        const request = store.put({ key: 'showQuantityField', value: settings.showQuantityField });
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                    })
                ];

                // Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙØ¸
                Promise.all(promises)
                    .then(() => {
                        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        resolve();
                    })
                    .catch(error => {
                        console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                        reject(error);
                    });

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
                transaction.oncomplete = () => {
                    console.log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ù…Ø¹Ø§Ù…Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                };

                transaction.onerror = (e) => {
                    console.error('âŒ ÙØ´Ù„ Ù…Ø¹Ø§Ù…Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        /**
        * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        */
        async function applySettingsImmediately(settings) {
            try {
                console.log('ğŸ”„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ø§Ù‹...');
                
                // 1. ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹
                const taxRateInputPOS = document.getElementById('taxRateInput');
                if (taxRateInputPOS) {
                    taxRateInputPOS.value = settings.taxRate;
                }

                const taxInput = document.getElementById('taxInput');
                if (taxInput) {
                    taxInput.value = settings.taxRate;
                }

                // 2. ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
                await setupQuantityFieldVisibility();
                
                // 3. ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ ØªØªØ£Ø«Ø± Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                updateAffectedElements(settings);
                
                console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                throw error;
            }
        }

        /**
        * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        */
        function updateAffectedElements(settings) {
            // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØªØ£Ø«Ø± Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const exchangeRateElements = document.querySelectorAll('[data-exchange-rate]');
            exchangeRateElements.forEach(el => {
                el.textContent = settings.exchangeRate;
            });

            const taxRateElements = document.querySelectorAll('[data-tax-rate]');
            taxRateElements.forEach(el => {
                el.textContent = settings.taxRate;
            });
        }

        /**
        * Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸
        */
        function showSettingsSuccessMessage(settings) {
            const message = `
        âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!

        â€¢ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: ${settings.exchangeRate} YER = 1 SAR
        â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${settings.taxRate}%
        â€¢ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©: ${settings.showQuantityField ? 'Ù…Ø¸Ù‡ÙˆØ±' : 'Ù…Ø®ÙÙŠ'}

        Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.
            `.trim();

            alert(message);
        }

        /**
        * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù… - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        */
        async function loadSettings() {
            try {
                console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
                
                if (!db) {
                    console.warn('âš ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©...');
                    setTimeout(loadSettings, 1000);
                    return;
                }

                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.getAll();

                request.onsuccess = function() {
                    const settings = request.result;
                    const settingsMap = {};
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
                    settings.forEach(setting => {
                        settingsMap[setting.key] = setting.value;
                    });

                    console.log('ğŸ“‹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', settingsMap);

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    applyLoadedSettings(settingsMap);
                    
                    // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
                    setTimeout(() => setupQuantityFieldVisibility(), 500);
                };

                request.onerror = function(e) {
                    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', e.target.error);
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                    applyDefaultSettings();
                };

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                applyDefaultSettings();
            }
        }

        /**
        * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        */
        function applyLoadedSettings(settingsMap) {
            // Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            if (exchangeRateInput) {
                exchangeRateInput.value = settingsMap.exchangeRate || 425;
            }

            // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
            const taxRateInput = document.getElementById('taxRateInput');
            if (taxRateInput) {
                taxRateInput.value = settingsMap.taxRate || 0;
            }

            // Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
            const showQuantityFieldSetting = document.getElementById('showQuantityFieldSetting');
            if (showQuantityFieldSetting) {
                showQuantityFieldSetting.checked = settingsMap.showQuantityField !== undefined ? 
                    settingsMap.showQuantityField : true;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©
            const taxInput = document.getElementById('taxInput');
            if (taxInput) {
                taxInput.value = settingsMap.taxRate || 0;
            }

            const taxRateInputPOS = document.getElementById('taxRateInput');
            if (taxRateInputPOS) {
                taxRateInputPOS.value = settingsMap.taxRate || 0;
            }
        }

        /**
        * ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        */
        function applyDefaultSettings() {
            console.log('ğŸ”„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
            
            const defaultSettings = {
                exchangeRate: 425,
                taxRate: 0,
                showQuantityField: true
            };

            applyLoadedSettings(defaultSettings);
        }

        /**
        * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        */
        async function validateCurrentSettings() {
            try {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.getAll();

                request.onsuccess = function() {
                    const settings = request.result;
                    if (settings.length === 0) {
                        console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª');
                        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                        saveDefaultSettings();
                    } else {
                        console.log('âœ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØµØ§Ù„Ø­Ø©:', settings);
                    }
                };

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
            }
        }

        /**
        * Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        */
        async function saveDefaultSettings() {
            const defaultSettings = {
                exchangeRate: 425,
                taxRate: 0,
                showQuantityField: true
            };

            try {
                await saveSettingsToDatabase(defaultSettings);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', error);
            }
        }


        /**
        * Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        */
        async function backupData() {
            try {
                const stores = ['products', 'invoices', 'customers', 'suppliers', 'cashTransactions', 
                            'settings', 'chartOfAccounts', 'journalEntries', 'purchaseInvoices', 'categories'];
                
                const backup = {};
                
                for (const storeName of stores) {
                    const data = await new Promise((resolve, reject) => {
                        const transaction = db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = (e) => reject(e.target.error);
                    });
                    backup[storeName] = data;
                }
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `erp_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:', error);
                alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
            }
        }

        /**
        * Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        */
        async function importData(file) {
            if (!confirm('ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                return;
            }
            
            try {
                const fileText = await file.text();
                const backup = JSON.parse(fileText);
                
                const stores = Object.keys(backup);
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                for (const storeName of stores) {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    await store.clear();
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                for (const storeName of stores) {
                    const data = backup[storeName];
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    for (const item of data) {
                        await store.add(item);
                    }
                }
                
                alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù.');
            }
        }


        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        async function performInstantSearch(searchTerm) {
            try {
                const products = await getAllProducts();
                return products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm)
                ).slice(0, 10); // Ø£ÙˆÙ„ 10 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ:', error);
                return [];
            }
        }

        // ğŸ”§ Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        function renderSearchResults(results, container) {
            container.innerHTML = '';
            
            results.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item p-2 border-bottom';
                resultItem.style.cursor = 'pointer';
                resultItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${product.name}</strong>
                            <small class="text-muted d-block">${product.code}</small>
                        </div>
                        <div class="text-success fw-bold">${product.salePrice.toFixed(2)} Ø±.ÙŠ</div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    addToCart(product.id, product.name, product.salePrice, product.purchasePrice);
                    container.style.display = 'none';
                    productSearchInput.value = '';
                });
                
                container.appendChild(resultItem);
            });
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ====================

        /**
        * Ø­Ø°Ù ÙØ¦Ø©
        */
        async function deleteCategory(categoryId) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©
                const products = await getAllProducts();
                const productsInCategory = products.filter(p => p.categoryId == categoryId);
                
                if (productsInCategory.length > 0) {
                    if (!confirm(`Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${productsInCategory.length} Ù…Ù†ØªØ¬. Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                        return;
                    }
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    
                    for (const product of productsInCategory) {
                        product.categoryId = null;
                        await store.put(product);
                    }
                }
                
                // Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©
                const categoryTransaction = db.transaction(['categories'], 'readwrite');
                const categoryStore = categoryTransaction.objectStore('categories');
                await categoryStore.delete(parseInt(categoryId));
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                loadCategoriesTable();
                loadCategories();
                if (currentView === 'categories') {
                    loadCategoriesView();
                }
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                console.error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©:', error);
                alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }



        // Ø¥ØµÙ„Ø§Ø­ Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            setTimeout(() => {
                if (typeof initDatabase === 'function') {
                    initDatabase();
                }
                if (typeof loadSettings === 'function') {
                    loadSettings();
                }
            }, 1000);
        });

        /**
        * Ø­Ø¯Ø« Ù…Ø®ØµØµ Ù„Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        */
        function triggerDataUpdate() {
            const event = new CustomEvent('dataUpdated');
            document.dispatchEvent(event);
        }

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© globally Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† HTML Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        window.showCategoriesView = showCategoriesView;
        window.loadCategoriesView = loadCategoriesView;

        // ==================== 4.6. Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners) ====================
        /**
        * Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
        */
        function setupLocalEventListeners() {
            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModule(this.dataset.module);
                });
            });

            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSubTab(this.dataset.tab);
                });
            });

        }


            document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            loadFallbackLibraries().then(() => {
                initDatabase();
            });

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'bi bi-moon' : 'bi bi-sun';
            }

            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            


            // Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„Ø¬ÙˆØ§Ù„)
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.getElementById('appSidebar').classList.toggle('show');
                });
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.addEventListener('click', function() {
                    if (window.innerWidth < 768) {
                        const sidebar = document.getElementById('appSidebar');
                        if (sidebar && sidebar.classList.contains('show')) {
                            sidebar.classList.remove('show');
                        }
                    }
                });
            }

            // ==================== Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ====================

            // Ø²Ø± FAB Ù„ÙØªØ­ Ø§Ù„Ø³Ù„Ø©
            const fabCartBtn = document.getElementById('fabCartBtn');
            if (fabCartBtn) {
                fabCartBtn.addEventListener('click', function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                });
            }
            
            // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù„Ø©
            const closeCartBtn = document.getElementById('closeCartBtn');
            if (closeCartBtn) {
                closeCartBtn.addEventListener('click', function() {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.remove('show');
                    }
                });
            }
            
            // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØ¦Ø§Øª ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
            if (backToCategoriesBtn) {
                backToCategoriesBtn.addEventListener('click', showCategoriesView);
            }

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            // ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
            const productSearchInput = document.getElementById('productSearchInput');
            if (productSearchInput) {
                productSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const searchResults = document.getElementById('posSearchResults');
                    
                    if (searchTerm.length < 2) {
                        searchResults.style.display = 'none';
                        searchResults.innerHTML = '';
                        return;
                    }
                    
                    // ğŸ”§ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    performInstantSearch(searchTerm).then(results => {
                        if (results.length > 0) {
                            renderSearchResults(results, searchResults);
                            searchResults.style.display = 'block';
                        } else {
                            searchResults.style.display = 'none';
                            searchResults.innerHTML = '';
                        }
                    });
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
                productSearchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        const searchResults = document.getElementById('posSearchResults');
                        searchResults.style.display = 'none';
                    }, 200);
                });
            }



            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø®ØµÙ…/Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
            ['discountType', 'discountInput', 'taxType', 'taxInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCartDisplay);
                }
            });
            
            // Ø²Ø± Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
            if (saveInvoiceBtn) {
                saveInvoiceBtn.addEventListener('click', saveInvoice);
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
            const cartItemsList = document.getElementById('cartItemsList');
            if (cartItemsList) {
                cartItemsList.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if (removeBtn) {
                        const index = parseInt(removeBtn.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentCart.length) {
                            currentCart.splice(index, 1);
                            updateCartDisplay();
                            updateCartCount();
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ badges
                            if (currentView === 'products' && currentCategoryId) {
                                loadProductsForCategory(currentCategoryId);
                            }
                        }
                    }
                });
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const printInvoiceBtn = document.getElementById('printInvoiceBtn');
            if (printInvoiceBtn) {
                printInvoiceBtn.addEventListener('click', printInvoice);
            }
            
            // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const shareWhatsappBtn = document.getElementById('shareWhatsappBtn');
            if (shareWhatsappBtn) {
                shareWhatsappBtn.addEventListener('click', createWhatsappPreview);
            }

            // Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„
            const printReceiptBtn = document.getElementById('printReceiptBtn');
            if (printReceiptBtn) {
                printReceiptBtn.addEventListener('click', function() {
                    window.print();
                });
            }

            // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ====================

            // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
            const addProductBtn = document.getElementById('addProductBtn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    openProductModal();
                });
            }

            // ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ù…Ù†ØªØ¬ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶)
            const productsTableBody = document.getElementById('productsTableBody');
            if (productsTableBody) {
                productsTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-product-btn')) {
                        const productId = e.target.dataset.id;
                        openProductModal(productId);
                    } else if (e.target.classList.contains('delete-product-btn')) {
                        const productId = e.target.dataset.id;
                        deleteProductHandler(productId);
                    }
                });
            }

            // Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const saveProductBtn = document.getElementById('saveProductBtn');
            if (saveProductBtn) {
                saveProductBtn.addEventListener('click', saveProductFromForm);
            }

            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const importProductsBtn = document.getElementById('importProductsBtn');
            if (importProductsBtn) {
                importProductsBtn.addEventListener('click', function() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.xlsx, .xls';
                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files.length > 0) {
                            importProductsFromExcel(e.target.files[0]);
                        }
                    });
                    fileInput.click();
                });
            }

            // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const exportProductsBtn = document.getElementById('exportProductsBtn');
            if (exportProductsBtn) {
                exportProductsBtn.addEventListener('click', exportProductsToExcel);
            }

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù
            const inventorySearchInput = document.getElementById('inventorySearchInput');
            if (inventorySearchInput) {
                inventorySearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#productsTableBody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }

            // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡
            const recordPurchaseBtn = document.getElementById('recordPurchaseBtn');
            if (recordPurchaseBtn) {
                recordPurchaseBtn.addEventListener('click', openPurchaseModal);
            }

            // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
            const addPurchaseItemBtn = document.getElementById('addPurchaseItemBtn');
            if (addPurchaseItemBtn) {
                addPurchaseItemBtn.addEventListener('click', addPurchaseItem);
            }

            // Ø¥Ø²Ø§Ù„Ø© ØµÙ†Ù Ù…Ù† ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶)
            const purchaseItemsContainer = document.getElementById('purchaseItemsContainer');
            if (purchaseItemsContainer) {
                purchaseItemsContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-item-btn')) {
                        e.target.closest('.purchase-item').remove();
                        calculatePurchaseTotal();
                    }
                });
            }

            // Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
            const savePurchaseBtn = document.getElementById('savePurchaseBtn');
            if (savePurchaseBtn) {
                savePurchaseBtn.addEventListener('click', savePurchaseInvoice);
            }

            // Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', () => {
                    openCategoryModal();
                });
            }

            // ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù ÙØ¦Ø©
            const categoriesTableBody = document.getElementById('categoriesTableBody');
            if (categoriesTableBody) {
                categoriesTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-category-btn')) {
                        const categoryId = e.target.dataset.id;
                        openCategoryModal(categoryId);
                    } else if (e.target.classList.contains('delete-category-btn')) {
                        const categoryId = e.target.dataset.id;
                        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.')) {
                            deleteCategory(categoryId);
                        }
                    }
                });
            }

            // Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            if (saveCategoryBtn) {
                saveCategoryBtn.addEventListener('click', saveCategory);
            }

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ù
            const movementSearchInput = document.getElementById('movementSearchInput');
            if (movementSearchInput) {
                movementSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const select = document.getElementById('movementProductSelect');
                    const options = select.options;
                    
                    for (let i = 0; i < options.length; i++) {
                        const option = options[i];
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(searchTerm) ? '' : 'none';
                    }
                });
            }
            // ==================== Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ====================
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            const depositBtn = document.getElementById('depositBtn');
            if (depositBtn) {
                depositBtn.addEventListener('click', () => {
                    openCashOperationModal('deposit');
                });
            }
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (withdrawBtn) {
                withdrawBtn.addEventListener('click', () => {
                    openCashOperationModal('withdraw');
                });
            }
            
            const transferBtn = document.getElementById('transferBtn');
            if (transferBtn) {
                transferBtn.addEventListener('click', () => {
                    openCashOperationModal('transfer');
                });
            }
            
            const closeShiftBtn = document.getElementById('closeShiftBtn');
            if (closeShiftBtn) {
                closeShiftBtn.addEventListener('click', closeShift);
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            const saveCashOperationBtn = document.getElementById('saveCashOperationBtn');
            if (saveCashOperationBtn) {
                saveCashOperationBtn.addEventListener('click', executeCashOperation);
            }
            // ==================== Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ====================
            // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ
            const addManualEntryBtn = document.getElementById('addManualEntryBtn');
            if (addManualEntryBtn) {
                addManualEntryBtn.addEventListener('click', openJournalEntryModal);
            }

            // Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            const addDebitEntryBtn = document.getElementById('addDebitEntryBtn');
            if (addDebitEntryBtn) {
                addDebitEntryBtn.addEventListener('click', addDebitEntry);
            }
            
            const addCreditEntryBtn = document.getElementById('addCreditEntryBtn');
            if (addCreditEntryBtn) {
                addCreditEntryBtn.addEventListener('click', addCreditEntry);
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯
            const debitEntriesContainer = document.getElementById('debitEntriesContainer');
            if (debitEntriesContainer) {
                debitEntriesContainer.addEventListener('input', calculateJournalEntryTotals);
            }
            
            const creditEntriesContainer = document.getElementById('creditEntriesContainer');
            if (creditEntriesContainer) {
                creditEntriesContainer.addEventListener('input', calculateJournalEntryTotals);
            }

            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            const saveJournalEntryBtn = document.getElementById('saveJournalEntryBtn');
            if (saveJournalEntryBtn) {
                saveJournalEntryBtn.addEventListener('click', saveJournalEntry);
            }
            // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ====================
            const addSupplierBtn = document.getElementById('addSupplierBtn');
            if (addSupplierBtn) {
                addSupplierBtn.addEventListener('click', () => {
                    openSupplierModal();
                });
            }

            const saveSupplierBtn = document.getElementById('saveSupplierBtn');
            if (saveSupplierBtn) {
                saveSupplierBtn.addEventListener('click', saveSupplier);
            }

            const suppliersTableBody = document.getElementById('suppliersTableBody');
            if (suppliersTableBody) {
                suppliersTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-supplier-btn')) {
                        const supplierId = e.target.dataset.id;
                        openSupplierModal(supplierId);
                    } else if (e.target.classList.contains('delete-supplier-btn')) {
                        const supplierId = e.target.dataset.id;
                        deleteSupplier(supplierId);
                    }
                });
            }
            // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ====================
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    openCustomerModal();
                });
            }

            const saveCustomerBtn = document.getElementById('saveCustomerBtn');
            if (saveCustomerBtn) {
                saveCustomerBtn.addEventListener('click', saveCustomer);
            }

            const customersTableBody = document.getElementById('customersTableBody');
            if (customersTableBody) {
                customersTableBody.addEventListener('click', function(e) {
                    if (e.target.classList.contains('edit-customer-btn')) {
                        const customerId = e.target.dataset.id;
                        openCustomerModal(customerId);
                    } else if (e.target.classList.contains('delete-customer-btn')) {
                        const customerId = e.target.dataset.id;
                        deleteCustomer(customerId);
                    }
                });
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯
            document.getElementById('executeCollectionBtn')?.addEventListener('click', executeCollection);
            document.getElementById('executeSupplierPaymentBtn')?.addEventListener('click', executeSupplierPayment);

            // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
            const accountingHeader = document.querySelector('#accounting .card-header');
            if (accountingHeader) {
                const buttonsHtml = `
                    <button class="btn btn-sm btn-success me-2" id="openCollectionModalBtn">
                        <i class="bi bi-cash-coin"></i> ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…Ù„Ø§Ø¡
                    </button>
                    <button class="btn btn-sm btn-warning" id="openSupplierPaymentModalBtn">
                        <i class="bi bi-credit-card"></i> Ø³Ø¯Ø§Ø¯ Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
                    </button>
                `;
                accountingHeader.innerHTML += buttonsHtml;
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            document.getElementById('openCollectionModalBtn')?.addEventListener('click', openCollectionModal);
            document.getElementById('openSupplierPaymentModalBtn')?.addEventListener('click', openSupplierPaymentModal);
        
            // ==================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====================

            
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.addEventListener('click', backupData);
            }
            
            const restoreBtn = document.getElementById('restoreBtn');
            if (restoreBtn) {
                restoreBtn.addEventListener('click', function() {
                    document.getElementById('restoreFileInput').click();
                });
            }

            const restoreFileInput = document.getElementById('restoreFileInput');
            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        importData(e.target.files[0]);
                    }
                });
            }
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
            document.addEventListener('click', function(e) {
                const productCard = e.target.closest('.product-card');
                if (productCard && currentView === 'products') {
                    const productId = parseInt(productCard.dataset.productId);
                    const productName = productCard.querySelector('.card-title').textContent;
                    const productPrice = parseFloat(productCard.dataset.productPrice);
                    const productCost = parseFloat(productCard.dataset.productCost) || 0;
                    
                    if (!isNaN(productId)) {
                        addToCart(productId, productName, productPrice, productCost);
                    }
                }
            });

            // 10. Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© ÙØªØ­ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            document.addEventListener('click', function(e) {
                if (e.target.id === 'fabCartBtn' || e.target.closest('#fabCartBtn')) {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                }
                
                if (e.target.id === 'floatingCartBtn' || e.target.closest('#floatingCartBtn')) {
                    const posCart = document.getElementById('posCart');
                    if (posCart) {
                        posCart.classList.add('show');
                    }
                }
            });

            // 11. Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
                    const removeBtn = e.target.closest('.remove-item-btn');
                    if (removeBtn && removeBtn.dataset.index) {
                        const index = parseInt(removeBtn.dataset.index);
                        if (!isNaN(index) && index >= 0 && index < currentCart.length) {
                            currentCart.splice(index, 1);
                            updateCartDisplay();
                            updateCartCount();
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ badges
                            if (currentView === 'products' && currentCategoryId) {
                                loadProductsForCategory(currentCategoryId);
                            }
                        }
                    }
                }
            });
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.addEventListener('dataUpdated', function() {
                if (currentView === 'categories') {
                    loadCategoriesView();
                } else if (currentView === 'products' && currentCategoryId) {
                    loadProductsForCategory(currentCategoryId);
                }
            });


            // â­ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø­Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ©
            const showQuantityFieldSetting = document.getElementById('showQuantityFieldSetting');
            if (showQuantityFieldSetting) {
                showQuantityFieldSetting.addEventListener('change', function() {
                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹ Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    setupQuantityFieldVisibility();
                });
            }
            
            // â­ ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø¹ Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', async function() {
                    await saveSettings();
                    // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
                    await setupQuantityFieldVisibility();
                });
            }

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
            setTimeout(loadSettings, 1000);
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
            // Ø¥Ø¶Ø§ÙØ© ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¶Ø§ÙÙŠØ©
            setTimeout(() => {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
                updateBalance();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                loadProductsForPOS();
                loadCategories();
                loadSuppliers();
                loadCustomers();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                updateCartCount();
                updateCartDisplay();
                
                console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
            }, 1000);
        });

    </script>
</body>
</html>